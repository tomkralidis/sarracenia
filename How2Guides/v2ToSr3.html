
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Porting v2 Plugins to Sr3 &#8212; sarracenia 3.00.013 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">sarracenia 3.00.013 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Porting v2 Plugins to Sr3</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="porting-v2-plugins-to-sr3">
<h1>Porting v2 Plugins to Sr3<a class="headerlink" href="#porting-v2-plugins-to-sr3" title="Permalink to this headline">¶</a></h1>
<p>This is a guide to porting plugins from Sarracenia version 2.X (metpx-sarracenia) to Sarracenia version 3.x (metpx-sr3)
If you are new to Sarracenia, and have no experience or need to look at v2 plugins, don’t read this. it will just
confuse you. This guide is for those who need to take existing v2 plugins and port them to v3.
You are better off getting a fresh look by looking at the jupyter notebook examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">MetPX</span><span class="o">/</span><span class="n">sarracenia</span><span class="o">/</span><span class="n">tree</span><span class="o">/</span><span class="n">v03_wip</span><span class="o">/</span><span class="n">jupyter</span>
</pre></div>
</div>
<p>Which provide an introduction to v3 without confusing references to v2.  In fact, Those notebooks
are probably a good pre-requisite for everyone, to understand how v3 plugins work, before trying
to port v2 ones.</p>
<p>Sample v3 plugin:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">MetPX</span><span class="o">/</span><span class="n">sarracenia</span><span class="o">/</span><span class="n">blob</span><span class="o">/</span><span class="n">v03_wip</span><span class="o">/</span><span class="n">sarracenia</span><span class="o">/</span><span class="n">flowcb</span><span class="o">/</span><span class="n">log</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Generally speaking v2 plugins were bolted onto existing code to allow some modification of behaviour.
v2 plugins when through a first generation, when only single routines were declared (e.g. <em>on_message</em>),
and a second generation, when whole classes (e.g. <em>plugin</em>) were declared, but still in a stilted way.</p>
<p>Sr3 plugins are core design elements, composed together to implement part of Sarracenia itself. V3 plugins
should be easier for Python programmers to debug and implement, and are strictly more flexible and powerful
than the v2 mechanism.</p>
<blockquote>
<div><ul class="simple">
<li><p>v3 uses standard python syntax, not v2’s strange things … e.g. <em>self.plugins</em>, <em>parent.logger</em>, Why doesn’t <em>import</em> work?</p></li>
<li><p>standard python import; Syntax errors are detected and reported <em>the normal way</em></p></li>
<li><p>v3 classes are designed to be usable outside the CLI itself (see jupyter notebook examples)
callable by application programmers in their own code, like any other python library.</p></li>
<li><p>v3 classes can be sub-classed to add core functionality, like new message or file transport protocols.</p></li>
</ul>
</div></blockquote>
<dl class="simple">
<dt>There are also a couple walkthrough videos on Youtube showing simple v2 -&gt; v3 ports:</dt><dd><ul class="simple">
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=rUazjoGzPac">Sender (10 min)</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=P20M9ojn_Zw">Poll (20 min)</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="file-placement">
<h1>File Placement<a class="headerlink" href="#file-placement" title="Permalink to this headline">¶</a></h1>
<p>v2 places configuration files under ~/.config/sarra, and state files under ~/.cache/sarra</p>
<p>v3 places configuration files under ~/.config/sr3, and state files under ~/.cache/sr3</p>
<p>v2 has a C implementation of sarra called sarrac. The C implementation for v3, is called sr3c,
and is the same as the v2 one, except it uses the new file locations.</p>
</section>
<section id="command-line-difference">
<h1>Command Line Difference<a class="headerlink" href="#command-line-difference" title="Permalink to this headline">¶</a></h1>
<p>Briefly, the sr3 entry point is used to start/stop/status things:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v2</span><span class="p">:</span>  <span class="n">sr_</span><span class="o">*</span><span class="n">component</span><span class="o">*</span> <span class="n">start</span> <span class="n">config</span>

<span class="n">v3</span><span class="p">:</span>  <span class="n">sr3</span> <span class="n">start</span> <span class="o">*</span><span class="n">component</span><span class="o">*/</span><span class="n">config</span>
</pre></div>
</div>
<p>In sr3, one can also use file globbing style specifications to ask for a command
to be invoked on a group of configurations, wheras in v2, one could only operate on one at a time.</p>
<p>sr3_post is an exception to this change in that it works like v2’s sr_post did, being
a tool for interactive posting.</p>
</section>
<section id="what-will-work-without-change">
<h1>What Will Work Without Change<a class="headerlink" href="#what-will-work-without-change" title="Permalink to this headline">¶</a></h1>
<p>The first step in porting a configuration subscribe/X to v3, is just to copy the configuration file from
~/.config/sarra to the corresponding location in ~/.config/sr3 and try:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3</span> <span class="n">show</span> <span class="n">subscribe</span><span class="o">/</span><span class="n">X</span>
</pre></div>
</div>
<p>The <em>show</em> command is new in sr3 and provides a way to view the configuration after
it has been parsed. Most of it should work, unless you have do_* plugins.</p>
<p>Examples of things that should work:</p>
<ul>
<li><p>all settings from v2 config files should be recognized by the v3 option parser, and converted
to v3 equivalents, when they exist. v2 option -&gt; v3 option some examples:</p>
<ul class="simple">
<li><p>accept_scp_threshold -&gt; accel_threshold</p></li>
<li><p>heartbeat -&gt; housekeeping</p></li>
<li><p>chmod_log -&gt; default_log_mode</p></li>
<li><p>loglevel -&gt; logLevel</p></li>
<li><p>post_base_url -&gt; post_baseUrl</p></li>
<li><p>post_rate_limit -&gt; message_rate_max</p></li>
<li><p>cache, suppress_duplicates -&gt;  nodupe_ttl</p></li>
<li><p>topic_prefix -&gt; topicPrefix</p></li>
</ul>
<p>The topic_prefix in v2 is ‘v02.post’  in v3, the default is ‘v03’. If topic_prefix is omitted
you will need to add the line <em>topicPrefix v02.post</em> to get the same behaviour as v2. Could
also be placed in ~/.config/sr3/default.conf if the case is too common.
One might have to similarly override the sr3 default for post_topicPrefix.</p>
</li>
<li><p>all on_message, on_file, on_post, on_heartbeat, routines will work, by sr3 using
the flowcb/v2wrapper.py plugin which will be automatically invoked when v2 plugins are
seen in the config file.</p>
<p>Note that ideally, v2wrapper is used as a crutch to allow one to have a functional configuration
quickly. There is a performance hit to using v2wrapper, and</p>
</li>
</ul>
<p>Things that will not work:</p>
<ul class="simple">
<li><p>do_*  they are just fundamentally different in v3.</p></li>
</ul>
<p>If you have a configuration with a do_* plugin, then you need this guide, from day 1.
to set a configuration to use a plugin, in v2 one used the <em>plugin</em> option.
The equivalent to that in v3 is <em>callback</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v2</span><span class="p">:</span> <span class="n">plugin</span> <span class="n">x</span>
<span class="n">v3</span><span class="p">:</span> <span class="n">callback</span> <span class="n">x3</span>
</pre></div>
</div>
<p>where x3 is the v3 ported version of the plugin made for v2. for this shorthand to work,
there should be a file named x3.py somewhere in the PYTHONPATH (~/.config/plugins is added
for convenience.) and that python source file needs to have a class X3.py declared in it
(same as the file name but first letter capitalized.)  If you need to name it differently
there is a longer form that allows one to violate the convention:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flowCallback</span> <span class="n">x3</span><span class="o">.</span><span class="n">MyFavouriteClass</span>
</pre></div>
</div>
<p>the individual routine plugin declarations on_message, on_file, etc… are not a way of
doing things in v3. You declare callbacks, and have them contain the entry points you need.</p>
</section>
<section id="coding-differences-between-plugins-in-v2-vs-sr3">
<h1>Coding Differences between plugins in v2 vs. Sr3<a class="headerlink" href="#coding-differences-between-plugins-in-v2-vs-sr3" title="Permalink to this headline">¶</a></h1>
<p>The API for adding or customizing functionality in sr3 is quite different from v2.
In general, v3 plugins:</p>
<ul>
<li><p><strong>are usually subclassed from sarracenia.flowcb.FlowCB.</strong></p>
<p>In v2, one would declare:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Msg_Log</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</pre></div>
</div>
<p>v3 plugins are normal python source files (no magic at the end.)
they are subclassed from sarracenia.flowcb:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sarracenia.flowcb</span> <span class="kn">import</span> <span class="n">FlowCB</span>

<span class="k">class</span> <span class="nc">myplugin</span><span class="p">(</span><span class="n">FlowCB</span><span class="p">):</span>
</pre></div>
</div>
<p>To create an <em>after_accept</em> plugin in <em>myplugin</em> class, define a function
with that name, and the appropriate signature.</p>
</li>
<li><p><strong>are pythonic, not weird</strong> : In v2, you need the last line to include something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">plugin</span> <span class="o">=</span> <span class="s1">&#39;Msg_Delay&#39;</span>
</pre></div>
</div>
<p>for a second generation plugin, the first generation ones had
something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msg_2localfile</span> <span class="o">=</span> <span class="n">Msg_2LocalFile</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">on_message</span> <span class="o">=</span> <span class="n">msg_2localfile</span><span class="o">.</span><span class="n">on_message</span>
</pre></div>
</div>
<p>at the end to assign entry points explicitly. either way a naive python
of the file would invariably fail without some sort of test harness being
wrapped around it. (<strong>In v3, delete these lines (usually located at the bottom of the file</strong>)</p>
<p>In v2, there were strange issues with imports, resulting in people putting
import statements within some functions. That problem is fixed in v3;
put the necessary imports at the beginning of the file, like any other python
module <strong>and remove the imports located within functions</strong>.</p>
<p>in v3 one can at least check syntax by doing <em>import X</em> in any python interpreter.</p>
</li>
<li><p><strong>v3 plugins can be used by application programmers.</strong> The plugins aren’t
bolted on after the fact, but a core element, implementing duplicate
suppression, reception and transmission of messages, file monitoring,
etc.. understanding v3 plugins gives people important clues to being
able to work on sarracenia itself.</p>
<p>v3 plugins can be <em>imported</em> into existing applications to add the ability
to interact with sarracenia pumps without using the Sarracenia CLI.
see jupyter tutorials.</p>
</li>
<li><p><strong>use standard python logging</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
</pre></div>
</div>
<p>Make sure the following logger declaration is after the <strong>last _import_</strong> in the top of the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1">#when you want a log message:</span>
<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span> <span class="o">...</span> <span class="p">)</span>

<span class="c1"># In VI you can use the global replace:</span>
<span class="p">:</span><span class="o">%</span><span class="n">s</span><span class="o">/</span><span class="n">parent</span><span class="o">.</span><span class="n">logger</span><span class="o">/</span><span class="n">logger</span><span class="o">/</span><span class="n">g</span>
</pre></div>
</div>
<p>In v3 plugins: <em>logger.x</em> replaces <em>parent.logger.x</em> found in v2 plugins.
In v2, to test outside the app, one had to build a test harness that had
parent.logger declared. sometimes there is also self.logger x… dunno why…
don’t ask.</p>
</li>
<li><p><em>have options as an argument to the __init__(self, options): routine</em>.
by convention, most modules include:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">o</span> <span class="o">=</span> <span class="n">options</span>
</pre></div>
</div>
<p>so in v2 if you need to access settings, <em>replace parent.setting by self.o.setting</em>.</p>
<blockquote>
<div><blockquote>
<div><p># In VI you can use the global replace:
:%s/parent/self.o/g</p>
</div></blockquote>
<p>Likewise in the __init__ function needs the self.o with options</p>
</div></blockquote>
</li>
<li><p><strong>you can see what options are active by starting a component with the ‘show’ command</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3</span> <span class="n">show</span> <span class="n">subscribe</span><span class="o">/</span><span class="n">myconf</span>
</pre></div>
</div>
<p>these settings can be access from self.o</p>
</li>
<li><p>in the settings generally, <strong>look for replacement of many underscores with camelCase</strong> in sr3, as per WMO standardization.
the exception being post_  where the underscore seems to better match intent.  so:</p>
<ul class="simple">
<li><p>post_base_dir becomes post_baseDir,</p></li>
<li><p>post_broker is unchanged.</p></li>
<li><p>post_base_url -&gt; post_baseUrl</p></li>
</ul>
</li>
<li><p><strong>messages are python dictionaries</strong> , so <cite>msg.relpath</cite> becomes <cite>msg[‘relPath’]</cite>
v3 messages, as dictionaries are the default internal representation.</p></li>
<li><p><strong>plugins operate on batches of messages</strong> v2 <em>on_message</em> gets parent as a parameter,
and the message is in parent.message. In v3, <em>after_accept</em> has worklist as an
option, which is python list of messages, maximum length being fixed by the
<em>batch</em> option. So the general organization for after_accept, and after_work is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">new_incoming</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">old_list</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">good</span><span class="p">:</span>
       <span class="n">new_incoming</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bad</span><span class="p">:</span>
       <span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="o">=</span><span class="n">new_incoming</span>
</pre></div>
</div>
<p>Note: plugins must be moved from the /plugins directory to the /flowcb directory,
and specifically, on_message plugins that turn into after_accept ones should be
placed in the flowcb/accept directory (so simialr plugins can be grouped together).</p>
<p>In <em>after_work</em>, the replacement for v2 <em>on_file</em>, the operations are on:</p>
<ul class="simple">
<li><p>worklist.ok (transfer succeeded.)</p></li>
<li><p>worklist.failed (transfers that failed.)</p></li>
</ul>
<p>In the case of receiving a .tar file and expanding into to individual files,
the <em>after_work</em> routine would change the worklist.ok to contain messages for
the individual files, rather than the original collective .tar.</p>
<p>Note: on_file plugins that become after_work plugins should be placed in the
/flowcb/after_work directory</p>
</li>
<li><p><strong>No Need to set message fields in plugins</strong>
in v2, one would need to set partstr, and sumstr for v2 messages in plugins.
This required an excessive understanding of message formats, and meant that
changing message formats required modifying plugins (v03 message format is
not supported by most v2 plugins, for example). To build a message from a
local file in a v3 plugin:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sarracenia</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">fromFileData</span><span class="p">(</span><span class="n">sample_fileName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">sample_fileName</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>just look at  <a class="reference internal" href="#do-poll-poll">do_poll -&gt; poll</a></p>
</li>
<li><p><strong>rarely, involve subclassing of moth or transfer classes.</strong>
The sarracenia.moth class implements support for message queueing protocols
that support topic hierarchy based subscriptions. There are currently
two subclasses of Moth: amqp (for rabbitmq), and mqtt.  It would be
great for someone to add an amq1 (for qpid amqp 1.0 support.)</p>
<p>It might be reasonable to add an SMTP class there for sending email,
not sure.</p>
<p>The sarracenia.transfer classes include http, ftp, and sftp today.
They are used to interact with remote services that provide a fileish
interface (supporting things like listing files, and downloading and/or
sending.) Other sub-classes such as S3, IPFS, or webdav, would be
great additions.</p>
</li>
</ul>
</section>
<section id="configuration-files">
<h1>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h1>
<p>in v2, the primary configuration option to declare a plugin is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plugin</span> <span class="n">X</span>
</pre></div>
</div>
<p>Generally speaking, there should be a file plugins/x.py
with a class X.py in that file in either ~/.config/plugins
or in the sarra/plugins directory in the package itself.
This is already a second generation style of plugin declaration
in Sarracenia. The original version, one declared individual
entry points:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">on_message</span><span class="p">,</span> <span class="n">on_file</span><span class="p">,</span> <span class="n">on_post</span><span class="p">,</span> <span class="n">on_</span><span class="o">...</span><span class="p">,</span> <span class="n">do_</span><span class="o">...</span>
</pre></div>
</div>
<p>In Sr3, the above entries are taken to be requests for v2
plugins, and should only be used for continuity reasons.
Ideally, one should invoke v3 plugins like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">callback</span> <span class="n">x</span>
</pre></div>
</div>
<p>Where x will be a subclass of sarracenia.flowcb, which
will contain a class X (first letter capitalized) in the
file x.py a in the python search path, or in the
<em>sarracenia/flowcb</em> directory included as part of the package.
This is actually a shorthand version of the python import.
If you need to declare a callback that does not obey that
convention, one can also use a more flexible but longer-winded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flowcb</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">X</span>
</pre></div>
</div>
<p>the above two are equivalent. The flowcb version can be used to import classes
that don’t match the convention of the x.X (a file named x.py containing a class called X.py)</p>
</section>
<section id="configuration-upgrade">
<h1>Configuration Upgrade<a class="headerlink" href="#configuration-upgrade" title="Permalink to this headline">¶</a></h1>
<p>Once a plugin is ported, one can also arrange for the v3 option parser to recognize a v2
plugin invocation and replace it with a v3 one.  looking in sarracenia/config.py,
there is a data structure <em>convert_to_v3</em>.  A sample entry would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="s1">&#39;on_message&#39;</span> <span class="p">:</span> <span class="p">{</span>
         <span class="s1">&#39;msg_delete&#39;</span><span class="p">:</span> <span class="p">[</span> <span class="s1">&#39;flowCallback&#39;</span><span class="p">:</span> <span class="s1">&#39;sarracenia.flowcb.filter.deleteflowfiles.DeleteFlowFiles&#39;</span> <span class="p">]</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div>
<p>A v2 config file containing a line <em>on_message msg_delete</em> would be replaced by the parser with
effectively:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flowCallback</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">deleteflowfiles</span><span class="o">.</span><span class="n">DeleteFlowFiles</span>
</pre></div>
</div>
</section>
<section id="options">
<h1>Options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h1>
<p>In v2, one would declare settings to be used by a plugin in the __init__ routine, with
the <em>declare_option</em>.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parent</span><span class="o">.</span><span class="n">declare_option</span><span class="p">(</span><span class="s1">&#39;poll_usgs_stn_file&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>it the values are always of type <em>list</em>, so usually, one uses the value by
picking the first value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parent</span><span class="o">.</span><span class="n">poll_usgs_stn_file</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<p>In v3, that would be replaced with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">add_option</span><span class="p">(</span> <span class="n">option</span><span class="o">=</span><span class="s1">&#39;poll_usgs_stn_file&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;hoho&#39;</span> <span class="p">)</span>
</pre></div>
</div>
<p>where in version 3 there is now types and default value setting included without additional
code. it would be referred to in other routines like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">poll_usgs_stn_file</span>
</pre></div>
</div>
</section>
<section id="mapping-entry-points">
<h1>Mapping Entry Points<a class="headerlink" href="#mapping-entry-points" title="Permalink to this headline">¶</a></h1>
<p>for a comprehensive look at the v3 entry points, have a look at:</p>
<p><a class="reference external" href="https://github.com/MetPX/sarracenia/blob/v03_wip/sarracenia/flowcb/__init__.py">https://github.com/MetPX/sarracenia/blob/v03_wip/sarracenia/flowcb/__init__.py</a></p>
<p>for details.</p>
<section id="on-message-on-post-after-accept">
<h2>on_message, on_post –&gt; after_accept<a class="headerlink" href="#on-message-on-post-after-accept" title="Permalink to this headline">¶</a></h2>
<p>v2: receives one message, returns True/False</p>
<dl class="simple">
<dt>v3: receives worklist</dt><dd><p>modify worklist.incoming
transferring rejected messages to worklist.rejected, or worklist.failed.</p>
</dd>
</dl>
<p>Sample flow:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">after_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>

   <span class="o">...</span>

   <span class="n">new_incoming</span><span class="o">=</span><span class="p">[]</span>
   <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="n">useful</span> <span class="n">to</span> <span class="n">us</span><span class="p">:</span>
           <span class="n">new_incoming</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">else</span>
           <span class="n">worklist</span><span class="o">.</span><span class="n">rejected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

   <span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span> <span class="o">=</span> <span class="n">new_incoming</span>
</pre></div>
</div>
<dl class="simple">
<dt>examples:</dt><dd><p>v2: plugins/msg_gts2wistopic.py
v3: flowcb/wistree.py</p>
</dd>
</dl>
</section>
<section id="on-file-after-work">
<h2>on_file –&gt; after_work<a class="headerlink" href="#on-file-after-work" title="Permalink to this headline">¶</a></h2>
<p>v2: receives one message, returns True/False</p>
<dl>
<dt>v3: receives worklist</dt><dd><p>modify worklist.ok (transfer has already happenned.)
transferring rejected messages to worklist.rejected, or worklist.failed.</p>
<p>can also be used to work on worklist.failed (retry logic does this.)</p>
</dd>
</dl>
<p>examples:</p>
</section>
<section id="on-heartbeat-on-housekeeping">
<h2>on_heartbeat -&gt; on_housekeeping<a class="headerlink" href="#on-heartbeat-on-housekeeping" title="Permalink to this headline">¶</a></h2>
<dl class="simple">
<dt>v2: receives parent as argument.</dt><dd><p>will work unchanged.</p>
</dd>
</dl>
<p>v3: only receives self (which should have self.o replacing parent)</p>
<p>examples:</p>
<blockquote>
<div><ul class="simple">
<li><p>v2: hb_cache.py – cleans out cache (references sr_cache.)</p></li>
<li><p>v3: flowcb/nodupe.py – implements entire caching routine.</p></li>
</ul>
</div></blockquote>
</section>
<section id="do-poll-poll">
<h2>do_poll -&gt; poll<a class="headerlink" href="#do-poll-poll" title="Permalink to this headline">¶</a></h2>
<p>v2: call do_poll from plugin.</p>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>protocol to use the do_poll routine is identified by registered_as() entry point</dt><dd><p>which is mandatory to provide.</p>
</dd>
</dl>
</li>
<li><p>requires manually constructing fields for messages, is message verison specific,
(generally do not support v03 messages.)</p></li>
<li><p>explicitly calls poll entry points.</p></li>
<li><p>runs, one must worry about whether one has the vip or not to decide what processing
to do in each plugin.</p></li>
<li><p>poll_without_vip setting available.</p></li>
</ul>
</div></blockquote>
<p>v3: define poll in a flowcb class.</p>
<blockquote>
<div><ul class="simple">
<li><p>poll only runs when has_vip is true.</p></li>
<li><p>registered_as() entry point is moot.</p></li>
<li><p>gather runs always, and is used to subscribe to post done by node that has the vip,
allowing the nodupe cache to be kept uptodate.</p></li>
<li><p>api defined to build messages from file data regardless of message format.</p></li>
<li><p>returns a list of messages to be filtered and posted.</p></li>
</ul>
</div></blockquote>
<p>To build a message, without a local file, use fromFileInfo sarracenia.message factory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dateparser</span>
<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">import</span> <span class="nn">sarracenia</span>

<span class="n">gathered_messages</span><span class="o">=</span><span class="p">[]</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">fromFileInfo</span><span class="p">(</span><span class="n">sample_fileName</span><span class="p">,</span> <span class="n">cfg</span><span class="p">)</span>
</pre></div>
</div>
<p>builds an message from scratch.</p>
<p>One can also build an supply a simulated stat record to fromFileInfo factory,
using the <em>paramiko.SFTPAttributes()</em> class. For example, using the dateparser
routines to convert however the remote server lists the date and time, as well
as determine the file size and permissions in effect:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pollmtime</span> <span class="o">=</span> <span class="n">dateparser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span> <span class="o">...</span> <span class="p">,</span> <span class="n">settings</span><span class="o">=</span><span class="p">{</span> <span class="o">...</span> <span class="n">TO_TIMEZONE</span><span class="o">=</span><span class="s1">&#39;utc&#39;</span> <span class="p">}</span> <span class="p">)</span>
<span class="n">mtimestamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span> <span class="n">pollmtime</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span> <span class="p">)</span>

<span class="n">fsize</span> <span class="o">=</span> <span class="n">info_from_poll</span> <span class="c1">#about the size of the file to download</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SFTPAttributes</span><span class="p">()</span>
<span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span><span class="o">=</span><span class="n">mtimstamp</span>
<span class="n">st</span><span class="o">.</span><span class="n">st_atime</span><span class="o">=</span><span class="n">mtimestamp</span>
<span class="n">st</span><span class="o">.</span><span class="n">st_size</span><span class="o">=</span><span class="n">fsize</span>
<span class="n">st</span><span class="o">.</span><span class="n">st_mode</span><span class="o">=</span><span class="mo">0o666</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">Message</span><span class="o">.</span><span class="n">fromFileInfo</span><span class="p">(</span><span class="n">sample_fileName</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">st</span><span class="p">)</span>
</pre></div>
</div>
<p>One should fill in the <em>SFTPAttributes</em> record if possible, since the duplicate
cache use metadata if available. The better the metadata, the better the
detection of changes to existing files.</p>
<p>Once the message is built, append it to the list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gathered_messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
</pre></div>
</div>
<p>and at the end:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">gathered_messages</span>
</pre></div>
</div>
<section id="vip-processing-in-poll">
<h3>vip processing in poll<a class="headerlink" href="#vip-processing-in-poll" title="Permalink to this headline">¶</a></h3>
<p>If you have vip set in v2, all participating nodes poll the upstream server
and maintain the list of current files, they just don’t publish the result.
So if you have 8 servers sharing a vip, all eight are polling, kind of sad.
There is also the poll_no_vip setting, and plugins often have to check if they
have the vip or not.</p>
<p>In v3, only the server with the vip polls. The plugins don’t need to check.
The other participating servers subscribe to where the poll posts to,
to keep update their recent_files cache.</p>
<dl class="simple">
<dt>examples:</dt><dd><ul class="simple">
<li><p>flowcb/poll/airnow.py</p></li>
</ul>
</dd>
</dl>
</section>
<section id="on-html-page-subclass-flowcb-poll">
<h3>on_html_page -&gt; subclass flowcb/poll<a class="headerlink" href="#on-html-page-subclass-flowcb-poll" title="Permalink to this headline">¶</a></h3>
<p>Here is a v2 plugin nsa_mls_nrt.py:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="k">class</span> <span class="nc">Html_parser</span><span class="p">():</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span>

        <span class="n">parent</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Html_parser __init__&quot;</span><span class="p">)</span>
        <span class="kn">import</span> <span class="nn">html.parser</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">logger</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">html</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">handle_starttag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_starttag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">handle_data</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_data</span>


    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">c</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="n">attr</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;href&quot;</span> <span class="ow">and</span> <span class="n">n</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">myfname</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">time</span>

        <span class="k">if</span> <span class="s1">&#39;MLS-Aura&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;data </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">data</span><span class="p">)</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">myfname</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-rwxr-xr-x 1 101 10 &#39;</span> <span class="o">+</span><span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;Jan 1 00:01&#39;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">data</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">) = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myfname</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">myfname</span><span class="p">]))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">myfname</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">myfname</span> <span class="o">==</span> <span class="n">data</span> <span class="p">:</span> <span class="k">return</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        # at this point data is a filename like</span>
<span class="sd">        name = data.strip().strip(&#39;\t&#39;)</span>

<span class="sd">        parts = name.split(&#39;_&#39;)</span>
<span class="sd">        if len(parts) != 3 : return</span>

<span class="sd">        words = parts[1].split(&#39;.&#39;)</span>
<span class="sd">        sdate  = &#39; &#39;.join(words[:4])</span>
<span class="sd">        t      = time.strptime(sdate,&#39;%Y %j %H %M&#39;)</span>

<span class="sd">        # accept file if 1 month old in sec  60 sec* 60min * 24hr * 31days</span>

<span class="sd">        epochf = time.mktime(t)</span>
<span class="sd">        now    = time.time()</span>
<span class="sd">        elapse = now - epochf</span>

<span class="sd">        if elapse &gt; self.month_in_secs : return</span>

<span class="sd">        # build an ls line from date in file ... size set to 0  since not provided</span>

<span class="sd">        mydate = time.strftime(&#39;%b %d %H:%M&#39;,t)</span>

<span class="sd">        mysize = &#39;_&#39;</span>

<span class="sd">        self.entries[self.myfname] = &#39;-rwxr-xr-x 1 101 10 &#39; + mysize + &#39; &#39; + mydate + &#39; &#39; + data</span>
<span class="sd">        self.logger.debug(&quot;(%s) = %s&quot; % (self.myfname,self.entries[self.myfname]))</span>
<span class="sd">        &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Html_parser parse&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">myfname</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;data </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">parent</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">parent</span><span class="o">.</span><span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">entries</span>

        <span class="k">return</span> <span class="kc">True</span>

<span class="n">html_parser</span> <span class="o">=</span> <span class="n">Html_parser</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">on_html_page</span> <span class="o">=</span> <span class="n">html_parser</span><span class="o">.</span><span class="n">parse</span>
</pre></div>
</div>
<p>The plugin has a main “parse” routine, which invokes the html.parser class, where data_handler
is called for each line, gradually building the self.entries dictionary where each entry is
a string constructed to resemble a line of <em>ls</em> command output.</p>
<p>This plugin is a near exact copy of the html_page.py plugin used by default.
The on_html_page entry point for plugins is replaced by a completely different
mechanism. Most of the logic of v2 poll in sr3 is in the new sarracenia.FlowCB.Poll class.
Logic from the v2 plugins/html_page.py, used by default, is now part of this
new Poll class, subclassed from flowcb, so basic HTML parsing is built-in.</p>
<p>Another change from v2 is that there was far more string manipulation in the old
version. in sr3 polls, most string maniupulation has been replaced by filling an
paramiko.SFTPAttributes structure as soon as possible.</p>
<p>So the way to replace on_html_page in sr3 is by sub-classing Poll.  Here is an
sr3 version of same plugin (nasa_mls_nrt.py):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">paramiko</span>
<span class="kn">import</span> <span class="nn">sarracenia</span>
<span class="kn">from</span> <span class="nn">sarracenia</span> <span class="kn">import</span> <span class="n">nowflt</span><span class="p">,</span> <span class="n">timestr2flt</span>
<span class="kn">from</span> <span class="nn">sarracenia.flowcb.poll</span> <span class="kn">import</span> <span class="n">Poll</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Nasa_mls_nrt</span><span class="p">(</span><span class="n">Poll</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="n">st</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SFTPAttributes</span><span class="p">()</span>
        <span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">st</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">=</span> <span class="mo">0o775</span>
        <span class="n">st</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="s1">&#39;MLS-Aura&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
               <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;data </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">data</span><span class="p">)</span>
               <span class="c1">#self.entries[self.myfname] = &#39;-rwxr-xr-x 1 101 10 &#39; +&#39;_&#39; + &#39; &#39; + &#39;Jan 1 00:01&#39; + &#39; &#39; + data</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">entries</span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="o">=</span><span class="n">st</span>

               <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(</span><span class="si">%s</span><span class="s2">) = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">myfname</span><span class="p">,</span><span class="n">st</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">myfname</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">myfname</span> <span class="o">==</span> <span class="n">data</span> <span class="p">:</span> <span class="k">return</span>
</pre></div>
</div>
<p>( <a class="reference external" href="https://github.com/MetPX/sarracenia/blob/v03_wip/sarracenia/flowcb/poll/nasa_mls_nrt.py">https://github.com/MetPX/sarracenia/blob/v03_wip/sarracenia/flowcb/poll/nasa_mls_nrt.py</a> )
and matching config file provided here:
( <a class="reference external" href="https://github.com/MetPX/sarracenia/blob/v03_wip/sarracenia/examples/poll/nasa-mls-nrt.conf">https://github.com/MetPX/sarracenia/blob/v03_wip/sarracenia/examples/poll/nasa-mls-nrt.conf</a> )</p>
<p>The new class is declared as a subclass of Poll, and only the needed
The HTML routine (handle_data) need be written to override the behaviour
provided by the parent class.</p>
<p>This solution is less than half the size of the v2 one, and permits
all manner of flexibility by allowing replacement of any or all elements
of the poll class.</p>
</section>
<section id="on-line-poll-subclassing">
<h3>on_line -&gt; poll subclassing<a class="headerlink" href="#on-line-poll-subclassing" title="Permalink to this headline">¶</a></h3>
<p>Similarly to on_html_page above, all uses of on_line in the previous version
were about re-formatting lines to be parseable. the on_line routine can be
similarly sub-classed to replace it.  One had to modify the parent.line
string to be parseable by the built in <em>ls</em> style line parsing.</p>
<p>In sr3, on_line is expected to return a populated paramiko.SFTPAttributes field, similar
to the way on_html_page works (but only a single one instead of a dictionary of them.)
With the more flexible date parsing in sr3, there has been no identified need for on_line
on which to build an example.</p>
</section>
<section id="do-send-send">
<h3>do_send -&gt; send:<a class="headerlink" href="#do-send-send" title="Permalink to this headline">¶</a></h3>
<p>v2: do_send could be either a standalone routine, or associated with a protocol type</p>
<ul class="simple">
<li><p>based on registered_as()  so the destination determines whether it is used or not.</p></li>
<li><p>accepts parent as an argument.</p></li>
<li><p>returns True on success, False on failure.</p></li>
<li><p>will typically have a registered_as() entry point to say which protocols to use a sender for.</p></li>
</ul>
<p>v3: send(self,msg)</p>
<ul class="simple">
<li><p>use the provided msg to do sending.</p></li>
<li><p>returns True on success, False on failure.</p></li>
<li><p>registered as is not used anymore, can be deleted.</p></li>
<li><p>The send entry_point overrides all sends, and is not protocol specific.
To add support for new protocols, subclass sarracenia.transfer instead.</p></li>
</ul>
<dl class="simple">
<dt>examples:</dt><dd><ul class="simple">
<li><p>flowcb/send/email.py</p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="do-download-download">
<h2>do_download -&gt; download:<a class="headerlink" href="#do-download-download" title="Permalink to this headline">¶</a></h2>
<p>create a flowCallback class with a <em>download</em> entry point.</p>
<ul>
<li><p>accepts a single message as an argument.</p></li>
<li><p>returns True if download succeeds.</p></li>
<li><p>if it returns False, the retry logic applies (download will be called again
then placed on the retry queue.)</p></li>
<li><p>use msg[‘new_dir’], msg[‘new_file’], msg[‘new_inflight_path’]
to respect settings such as <em>inflight</em> and place file properly.
(unless changing that is motivation for the plugin.)</p></li>
<li><p>might be a good idea to verify the checksum of the downloaded data.
if the checksum of the file downloaded does not agree with what is in
the message, duplicate suppression fails, and looping results.</p></li>
<li><p>one case of download is when retrievalURL is not a normal file download.
in v03, there is a retPath fields for exactly this case. This new feature
can be used to eliminate the need for download plugins.  Example:</p>
<p>in v2:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/MetPX/sarracenia/blob/v2_stable/sarra/plugins/poll_noaa.py">https://github.com/MetPX/sarracenia/blob/v2_stable/sarra/plugins/poll_noaa.py</a></p></li>
<li><p><a class="reference external" href="https://github.com/MetPX/sarracenia/blob/v2_stable/sarra/plugins/download_noaa.py">https://github.com/MetPX/sarracenia/blob/v2_stable/sarra/plugins/download_noaa.py</a></p></li>
</ul>
</div></blockquote>
<p>is ported to sr3:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://github.com/MetPX/sarracenia/blob/v03_wip/sarracenia/flowcb/poll/noaa_hydrometric.py">https://github.com/MetPX/sarracenia/blob/v03_wip/sarracenia/flowcb/poll/noaa_hydrometric.py</a></p></li>
</ul>
</div></blockquote>
<p>The ported result sets the new field <em>retPath</em> ( retrieval path ) instead of new_dir and new_file
fields, and normal processing of the <em>retPath</em> field in the message will do a good download, no
plugin required.</p>
</li>
</ul>
</section>
<section id="v3-only-post-gather">
<h2>v3 only: post,gather<a class="headerlink" href="#v3-only-post-gather" title="Permalink to this headline">¶</a></h2>
<p>The polling/posting is actually done in flow callback (flowcb) classes.
The exit status does not matter, all such routines will be called in order.</p>
<p>The return of a gather is a list of messages to be appended to worklist.incoming</p>
<p>The return of post is undefined. The whole point is to create a side-effect
that affects some other process or server.</p>
<dl class="simple">
<dt>examples:</dt><dd><ul class="simple">
<li><p>flowcb/gather/file.py - read files from disk (for post and watch)</p></li>
<li><p>flowcb/gather/message.py - how messages are received by all components</p></li>
<li><p>flowcb/post/message.py - how messages are posted by all components.</p></li>
<li><p>flowcb/poll/nexrad.py - this polls NOAA’s AWS server for data.
install a configuration to use it with <em>sr3 add poll/aws-nexrad.conf</em></p></li>
</ul>
</dd>
</dl>
</section>
<section id="v3-complex-examples">
<h2>v3 Complex Examples<a class="headerlink" href="#v3-complex-examples" title="Permalink to this headline">¶</a></h2>
<section id="flowcb-nodupe">
<h3>flowcb/nodupe<a class="headerlink" href="#flowcb-nodupe" title="Permalink to this headline">¶</a></h3>
<p>duplicate suppression in v3, has:</p>
<ul class="simple">
<li><p>an after_accept routing the prunes duplicates from worklist.incoming.
( adding non-dupes to the reception cache.)</p></li>
</ul>
</section>
<section id="flowcb-retry">
<h3>flowcb/retry<a class="headerlink" href="#flowcb-retry" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>has an after_accept function to append messages to the
incoming queue, in order to trigger another attempt to process them.</p></li>
<li><p>has an after_work routine doing something unknown… FIXME.</p></li>
<li><p>has a post function to take failed downloads and put them
on the retry list for later consideration.</p></li>
</ul>
</div></blockquote>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Porting v2 Plugins to Sr3</a></li>
<li><a class="reference internal" href="#file-placement">File Placement</a></li>
<li><a class="reference internal" href="#command-line-difference">Command Line Difference</a></li>
<li><a class="reference internal" href="#what-will-work-without-change">What Will Work Without Change</a></li>
<li><a class="reference internal" href="#coding-differences-between-plugins-in-v2-vs-sr3">Coding Differences between plugins in v2 vs. Sr3</a></li>
<li><a class="reference internal" href="#configuration-files">Configuration Files</a></li>
<li><a class="reference internal" href="#configuration-upgrade">Configuration Upgrade</a></li>
<li><a class="reference internal" href="#options">Options</a></li>
<li><a class="reference internal" href="#mapping-entry-points">Mapping Entry Points</a><ul>
<li><a class="reference internal" href="#on-message-on-post-after-accept">on_message, on_post –&gt; after_accept</a></li>
<li><a class="reference internal" href="#on-file-after-work">on_file –&gt; after_work</a></li>
<li><a class="reference internal" href="#on-heartbeat-on-housekeeping">on_heartbeat -&gt; on_housekeeping</a></li>
<li><a class="reference internal" href="#do-poll-poll">do_poll -&gt; poll</a><ul>
<li><a class="reference internal" href="#vip-processing-in-poll">vip processing in poll</a></li>
<li><a class="reference internal" href="#on-html-page-subclass-flowcb-poll">on_html_page -&gt; subclass flowcb/poll</a></li>
<li><a class="reference internal" href="#on-line-poll-subclassing">on_line -&gt; poll subclassing</a></li>
<li><a class="reference internal" href="#do-send-send">do_send -&gt; send:</a></li>
</ul>
</li>
<li><a class="reference internal" href="#do-download-download">do_download -&gt; download:</a></li>
<li><a class="reference internal" href="#v3-only-post-gather">v3 only: post,gather</a></li>
<li><a class="reference internal" href="#v3-complex-examples">v3 Complex Examples</a><ul>
<li><a class="reference internal" href="#flowcb-nodupe">flowcb/nodupe</a></li>
<li><a class="reference internal" href="#flowcb-retry">flowcb/retry</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/How2Guides/v2ToSr3.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">sarracenia 3.00.013 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Porting v2 Plugins to Sr3</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Peter Silva.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>