
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>How to setup a Remote Subscriber &#8212; sarracenia 3.00.013 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">sarracenia 3.00.013 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to setup a Remote Subscriber</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="how-to-setup-a-remote-subscriber">
<h1><a class="toc-backref" href="#id2">How to setup a Remote Subscriber</a><a class="headerlink" href="#how-to-setup-a-remote-subscriber" title="Permalink to this headline">¶</a></h1>
<p>This example goes over how to subscribe to the swob files from the Environment Canada Weather office.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title">Table of Contents:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#how-to-setup-a-remote-subscriber" id="id2">How to setup a Remote Subscriber</a></p>
<ul>
<li><p><a class="reference internal" href="#setup" id="id3">Setup</a></p></li>
<li><p><a class="reference internal" href="#startup" id="id4">Startup</a></p></li>
<li><p><a class="reference internal" href="#cleanup" id="id5">Cleanup</a></p></li>
</ul>
</li>
</ul>
</div>
<p>FIXME: v03 edit is broken.</p>
<section id="setup">
<h2><a class="toc-backref" href="#id3">Setup</a><a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h2>
<p>Initialize the credentials storage in the <cite>~/.config/sr3/credentials.conf</cite> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 edit credentials.conf
  amqps://anonymous:anonymous@dd.weather.gc.ca
</pre></div>
</div>
<p>The format is a complete url on each line (<cite>amqps://&lt;user&gt;:&lt;password&gt;&#64;&lt;target.url&gt;</cite>).
This credentials.conf file should be private (linux octal permissions: 0600).
.conf files placed in the <code class="docutils literal notranslate"><span class="pre">~/.config/sr3/subscribe_directory</span></code> will be automatically found by <code class="docutils literal notranslate"><span class="pre">sr_subscribe</span></code>, rather than giving the full path.</p>
<p>The <em>edit</em> command starts the user’s configured editor on the file to be created, in the correct directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 edit subscribe/swob.conf
  broker amqps://anonymous@dd.weather.gc.ca
  subtopic observations.swob-ml.#
  directory /tmp/swob_downloads
  accept .*
$ mkdir /tmp/swob_downloads
$ sr3 status subscribe/swob
  2017-12-14 06:54:54,010 [INFO] sr_subscribe swob 01 is stopped
</pre></div>
</div>
<div class="admonition error">
<p class="admonition-title">Error</p>
<p>Currrently edit is failing if there isn’t a file in the expected location
(it does in fact, not create a file)
See issue <a class="reference external" href="https://github.com/MetPX/sarracenia/issues/251">#251</a> for more info or to complain.
In the interim instead use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mkdir -p .config/sarra/subscribe
$ touch $_/swob.conf
$ sr3 edit swob.conf
</pre></div>
</div>
</div>
<p><em>broker</em> indicates where to connect to get the stream of notifications.
The term <em>broker</em> is taken from AMQP (<a class="reference external" href="http://www.amqp.org">http://www.amqp.org</a>), the protocol used to transfer the notifications.
The notifications that will be received all have <em>topics</em> that correspond to their URL.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Omitting <code class="docutils literal notranslate"><span class="pre">directory</span></code> from the config file will write the files in the present working directory.
Given how quickly they arrive, be prepared to clean up.</p>
</div>
</section>
<section id="startup">
<h2><a class="toc-backref" href="#id4">Startup</a><a class="headerlink" href="#startup" title="Permalink to this headline">¶</a></h2>
<p>Now start up the newly created subscriber:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 start swob
  2015-12-03 06:53:35,268 [INFO] user_config = 0 ../swob.conf
  2015-12-03 06:53:35,269 [INFO] instances 1
  2015-12-03 06:53:35,270 [INFO] sr subscribe swob 0001 started
</pre></div>
</div>
<p>Activity can be monitored via log files in <code class="docutils literal notranslate"><span class="pre">~/.cache/sarra/log/</span></code> or with the <em>log</em> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 log swob

  2015-12-03 06:53:35,635 [INFO] Binding queue q_anonymous.sr_subscribe.swob.21096474.62787751 with key v02.post.observations.swob-ml.# to exchange xpublic on broker amqps://anonymous@dd.weather.gc.ca/
  2015-12-03 17:32:01,834 [INFO] user_config = 1 ../swob.conf
  2015-12-03 17:32:01,835 [INFO] sr_subscribe start
  2015-12-03 17:32:01,835 [INFO] sr_subscribe run
  2015-12-03 17:32:01,835 [INFO] AMQP  broker(dd.weather.gc.ca) user(anonymous) vhost(/)
  2015-12-03 17:32:01,835 [INFO] AMQP  input :    exchange(xpublic) topic(v02.post.observations.swob-ml.#)
  2015-12-03 17:32:01,835 [INFO] AMQP  output:    exchange(xs_anonymous) topic(v02.report.#)

  2015-12-03 17:32:08,191 [INFO] Binding queue q_anonymous.sr_subscribe.swob.21096474.62787751 with key v02.post.observations.swob-ml.# to exchange xpublic on broker amqps://anonymous@dd.weather.gc.ca/
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">[Ctrl]</span> <span class="pre">+</span> <span class="pre">[C]</span></code> to exit watching the logs.
The startup log appears normal, indicating the authentication information was accepted.
<code class="docutils literal notranslate"><span class="pre">sr_subscribe</span></code> will get the notification and download the file into the present working directory
(unless otherwise specified in the configuration file).</p>
<hr class="docutils" />
<p>A normal download looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">031</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">topic</span>   <span class="n">v02</span><span class="o">.</span><span class="n">post</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">swob</span><span class="o">-</span><span class="n">ml</span><span class="mf">.20151203</span><span class="o">.</span><span class="n">CMED</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">031</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">notice</span>  <span class="mf">20151203223214.699</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd2</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span><span class="n">observations</span><span class="o">/</span><span class="n">swob</span><span class="o">-</span><span class="n">ml</span><span class="o">/</span><span class="mi">20151203</span><span class="o">/</span><span class="n">CMED</span><span class="o">/</span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">2200</span><span class="o">-</span><span class="n">CMED</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">031</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Received</span> <span class="n">headers</span> <span class="p">{</span><span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s1">&#39;2015-12-03-2200-CMED-AUTO-swob.xml&#39;</span><span class="p">,</span> <span class="s1">&#39;parts&#39;</span><span class="p">:</span> <span class="s1">&#39;1,3738,1,0,0&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="s1">&#39;d,157a9e98406e38a8252eaadf68c0ed60&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;metpx&#39;</span><span class="p">,</span> <span class="s1">&#39;to_clusters&#39;</span><span class="p">:</span> <span class="s1">&#39;DD,DDI.CMC,DDI.ED M&#39;</span><span class="p">,</span> <span class="s1">&#39;from_cluster&#39;</span><span class="p">:</span> <span class="s1">&#39;DD&#39;</span><span class="p">}</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">15</span><span class="p">,</span><span class="mi">031</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">downloading</span><span class="o">/</span><span class="n">copying</span> <span class="n">into</span> <span class="o">./</span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">2200</span><span class="o">-</span><span class="n">CMED</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span>
</pre></div>
</div>
<p>Giving all the information contained in the notification.
Here is a failure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span><span class="mi">715</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Downloads</span><span class="p">:</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd2</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span><span class="n">observations</span><span class="o">/</span><span class="n">swob</span><span class="o">-</span><span class="n">ml</span><span class="o">/</span><span class="mi">20151203</span><span class="o">/</span><span class="n">CXFB</span><span class="o">/</span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">2200</span><span class="o">-</span><span class="n">CXFB</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span>  <span class="n">into</span> <span class="o">./</span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">2200</span><span class="o">-</span><span class="n">CXFB</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span> <span class="mi">0</span><span class="o">-</span><span class="mi">6791</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span><span class="mi">786</span> <span class="p">[</span><span class="n">ERROR</span><span class="p">]</span> <span class="n">Download</span> <span class="n">failed</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd2</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span><span class="n">observations</span><span class="o">/</span><span class="n">swob</span><span class="o">-</span><span class="n">ml</span><span class="o">/</span><span class="mi">20151203</span><span class="o">/</span><span class="n">CXFB</span><span class="o">/</span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">2200</span><span class="o">-</span><span class="n">CXFB</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span>
<span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">03</span> <span class="mi">17</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">30</span><span class="p">,</span><span class="mi">787</span> <span class="p">[</span><span class="n">ERROR</span><span class="p">]</span> <span class="n">Server</span> <span class="n">couldn</span><span class="s1">&#39;t fulfill the request. Error code: 404, Not Found</span>
</pre></div>
</div>
<p>This message is not always a failure as <code class="docutils literal notranslate"><span class="pre">sr_subscribe</span></code> retries a few times before giving up.
After a few minutes, here is what the download directory looks like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ls -al | tail
  -rw-rw-rw-  1 peter peter   7875 Dec  3 17:36 2015-12-03-2236-CL3D-AUTO-minute-swob.xml
  -rw-rw-rw-  1 peter peter   7868 Dec  3 17:37 2015-12-03-2236-CL3G-AUTO-minute-swob.xml
  -rw-rw-rw-  1 peter peter   7022 Dec  3 17:37 2015-12-03-2236-CTRY-AUTO-minute-swob.xml
  -rw-rw-rw-  1 peter peter   6876 Dec  3 17:37 2015-12-03-2236-CYPY-AUTO-swob.xml
  -rw-rw-rw-  1 peter peter   6574 Dec  3 17:36 2015-12-03-2236-CYZP-AUTO-swob.xml
  -rw-rw-rw-  1 peter peter   7871 Dec  3 17:37 2015-12-03-2237-CL3D-AUTO-minute-swob.xml
  -rw-rw-rw-  1 peter peter   7873 Dec  3 17:37 2015-12-03-2237-CL3G-AUTO-minute-swob.xml
  -rw-rw-rw-  1 peter peter   7037 Dec  3 17:37 2015-12-03-2237-CTBF-AUTO-minute-swob.xml
  -rw-rw-rw-  1 peter peter   7022 Dec  3 17:37 2015-12-03-2237-CTRY-AUTO-minute-swob.xml
  -rw-rw-rw-  1 peter peter 122140 Dec  3 17:38 sr_subscribe_dd_swob_0001.log
</pre></div>
</div>
</section>
<section id="cleanup">
<h2><a class="toc-backref" href="#id5">Cleanup</a><a class="headerlink" href="#cleanup" title="Permalink to this headline">¶</a></h2>
<p>To not download more files, stop the subscriber:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr_subscribe stop swob
  2015-12-03 17:32:22,219 [INFO] sr_subscribe swob 01 stopped
</pre></div>
</div>
<p>This however leaves the queue that <code class="docutils literal notranslate"><span class="pre">sr_subscribe</span> <span class="pre">start</span></code> setup on the broker active,
as to allow a failed subscriber to attempt reconnecting without loosing progress.
That is until the broker times out the queue and removes it.
To tell the broker that we are finished with the queue, tell the subscriber to cleanup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr_subscribe cleanup swob
2015-12-03 17:32:22,008 [INFO] sr_subscribe swob cleanup
2015-12-03 17:32:22,008 [INFO] AMQP broker(dd.weatheer.gc.ca) user(anonymous) vhost()
2015-12-03 17:32:22,008 [INFO] Using amqp module (AMQP 0-9-1)
2015-12-03 17:32:22,008 [INFO] deleting queue q_anonymous.sr_subscribe.swob.21096474.62787751 (anonymous@dd.weather.gc.ca)
</pre></div>
</div>
<p>Best practice is to clear the queue when done as to lessen the load on the broker.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">How to setup a Remote Subscriber</a><ul>
<li><a class="reference internal" href="#setup">Setup</a></li>
<li><a class="reference internal" href="#startup">Startup</a></li>
<li><a class="reference internal" href="#cleanup">Cleanup</a></li>
</ul>
</li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Tutorials/Setup_a_remote_subscriber.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">sarracenia 3.00.013 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">How to setup a Remote Subscriber</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Peter Silva.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>