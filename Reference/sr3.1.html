
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>SR3 &#8212; sarracenia 3.00.013 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/classic.css" />
    
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">sarracenia 3.00.013 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">SR3</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="sr3">
<h1><a class="toc-backref" href="#id21">SR3</a><a class="headerlink" href="#sr3" title="Permalink to this headline">¶</a></h1>
<section id="sr3-sarracenia-cli">
<h2><a class="toc-backref" href="#id22">sr3 Sarracenia CLI</a><a class="headerlink" href="#sr3-sarracenia-cli" title="Permalink to this headline">¶</a></h2>
<dl class="field-list simple">
<dt class="field-odd">Manual section</dt>
<dd class="field-odd"><p>1</p>
</dd>
<dt class="field-even">Date</dt>
<dd class="field-even"><p>&#64;Date&#64;</p>
</dd>
<dt class="field-odd">Version</dt>
<dd class="field-odd"><p>&#64;Version&#64;</p>
</dd>
<dt class="field-even">Manual group</dt>
<dd class="field-even"><p>MetPX-Sarracenia</p>
</dd>
</dl>
<section id="synopsis">
<h3><a class="toc-backref" href="#id23">SYNOPSIS</a><a class="headerlink" href="#synopsis" title="Permalink to this headline">¶</a></h3>
<p><strong>sr3</strong> add|cleanup|declare|disable|dump|enable|foreground|list|remove|restart|sanity|setup|show|start|stop|status|overview _configs_</p>
</section>
<section id="description">
<h3><a class="toc-backref" href="#id24">DESCRIPTION</a><a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h3>
<p><strong>sr3</strong> is a command line tool to manage <a class="reference external" href="https://github.com/MetPX/sarracenia">Sarracenia</a> configurations, individually or in groups.
For the current user, it reads on all of the configuration files, state files, and consults the process table to determine the
state of all components.  It then makes the change requested.</p>
<p>This man page is a reference, sort of a dictionary for the entire application, and may be a bit much to chew off at first.
If you already familiar in general with Sarracenia, and are looking for information about specific options or directives,
check the table of <a class="reference internal" href="#contents">Contents</a>
To more easily get started, have a look at <a class="reference external" href="../How2Guides/subscriber.rst">the Subscriber Guide on github</a></p>
<p>sr3 components are used to publish to and download files from websites or file servers
that provide <a class="reference external" href="sr3_post.7.rst">sr3_post(7)</a> protocol notifications. Such sites
publish messages for each file as soon as it is available. Clients connect to a
<em>broker</em> (often the same as the server itself) and subscribe to the notifications.
The <em>sr3_post</em> notifications provide true push notices for web-accessible folders (WAF),
and are far more efficient than either periodic polling of directories, or ATOM/RSS style
notifications. Sr_subscribe can be configured to post messages after they are downloaded,
to make them available to consumers for further processing or transfers.</p>
<p><strong>sr3</strong> can also be used for purposes other than downloading, (such as for
supplying to an external program) specifying the -n (equal to: <em>download off</em>) will
suppress the download behaviour and only post the URL on standard output. The standard
output can be piped to other processes in classic UNIX text filter style.</p>
<p><strong>sr3</strong> is very configurable and is the basis for other components of Sarracenia:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#cpump-sr-cpump">cpump|sr_cpump</a> - copy messages from one pump another second one (a C implementation of shovel.)</p></li>
<li><p><a class="reference internal" href="#poll">poll</a> - poll a non-sarracenia web or file server to create messages for processing.</p></li>
<li><p><a class="reference internal" href="#post-sr3-post-sr-cpost-watch">post|sr3_post|sr_cpost|watch</a> - create messages for files for processing.</p></li>
<li><p><a class="reference internal" href="#sarra">sarra</a> - download file from a remote server to the local one, and re-post them for others.</p></li>
<li><p><a class="reference internal" href="#sender">sender</a> - send files from a local server to a remote one.</p></li>
<li><p><a class="reference internal" href="#shovel">shovel</a> - copy messages, only, not files.</p></li>
<li><p><a class="reference internal" href="#watch">watch</a> - create messages for each new file that arrives in a directory, or at a set path.</p></li>
<li><p><a class="reference internal" href="#winnow">winnow</a> - copy messages, suppressing duplicates.</p></li>
</ul>
</div></blockquote>
<p>All of these components accept the same options, with the same effects.
There is also <a class="reference external" href="sr3_cpump.1.rst">sr3_cpump(1)</a> which is a C version that implements a
subset of the options here, but where they are implemented, they have the same effect.</p>
<p>The <strong>sr3</strong> command takes two arguments: an action <code class="docutils literal notranslate"><span class="pre">start|stop|restart|reload|status</span></code>,
followed by a list of configuration files</p>
<p>When any component is invoked, an operation and a configuration file are specified.
The operation is one of:</p>
<blockquote>
<div><ul class="simple">
<li><p>foreground: run a single instance in the foreground logging to stderr</p></li>
<li><p>restart: stop and then start the configuration.</p></li>
<li><p>sanity: looks for instances which have crashed or gotten stuck and restarts them.</p></li>
<li><p>start:  start the configuration running</p></li>
<li><p>status: check if the configuration is running.</p></li>
<li><p>stop: stop the configuration from running</p></li>
</ul>
</div></blockquote>
<p>Note that the <em>sanity</em> check is invoked by housekeeping processing in sr_audit on a regular basis.
The remaining operations manage the resources (exchanges, queues) used by the component on
the rabbitmq server, or manage the configurations.</p>
<blockquote>
<div><ul class="simple">
<li><p>cleanup:       deletes the component’s resources on the server.</p></li>
<li><p>declare:       creates the component’s resources on the server.</p></li>
<li><p>setup:         like declare, additionally does queue bindings.</p></li>
<li><p>add:           copy to the list of available configurations.</p></li>
<li><p>list:          list all the configurations available.</p></li>
<li><p>list plugins:  list all the plugins available.</p></li>
<li><p>list examples:  list all the plugins available.</p></li>
<li><p>show           view an interpreted version of a configuration file.</p></li>
<li><p>edit:          modify an existing configuration.</p></li>
<li><p>remove:        remove a configuration.</p></li>
<li><p>disable:       mark a configuration as ineligible to run.</p></li>
<li><p>enable:        mark a configuration as eligible to run.</p></li>
</ul>
</div></blockquote>
<p>For example:  <em>sr_subscribe foreground dd</em> runs the sr_subscribe component with
the dd configuration as a single foreground instance.</p>
<p>The <strong>foreground</strong> action is used when building a configuration or for debugging.
The <strong>foreground</strong> instance will run regardless of other instances which are currently
running.  Should instances be running, it shares the same message queue with them.
A user stop the <strong>foreground</strong> instance by simply using &lt;ctrl-c&gt; on linux
or use other means to kill the process.</p>
<p>After a configuration has been refined, <em>start</em> to launch the component as a background
service (daemon or fleet of daemons whose number is controlled by the <em>instances</em> option.)
If multiple configurations and components need to be run together, the entire fleet
can be similarly controlled using the <a class="reference external" href="sr.8.rst">sr(8)</a> command.</p>
<p>To have components run all the time, on Linux one can use <a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/">systemd</a> integration,
as described in the <a class="reference external" href="../How2Guides/Admin.rst">Admin Guide</a> On Windows, one can configure a service,
as described in the <a class="reference external" href="../Tutorials/Windows.rst">Windows user manual</a></p>
<p>The actions <strong>cleanup</strong>, <strong>declare</strong>, <strong>setup</strong> can be used to manage resources on
the rabbitmq server. The resources are either queues or exchanges. <strong>declare</strong> creates
the resources. <strong>setup</strong> creates and additionally binds the queues.</p>
<p>The <strong>add, remove, list, edit, enable &amp; disable</strong> actions are used to manage the list
of configurations.  One can see all of the configurations available using the <strong>list</strong>
action.   to view available plugins use <strong>list plugins</strong>.  Using the <strong>edit</strong> option,
one can work on a particular configuration.  A <em>disabled</em> configuration will not be
started or restarted by the <strong>start</strong>,
<strong>foreground</strong>, or <strong>restart</strong> actions. It can be used to set aside a configuration
temporarily.</p>
</section>
<section id="contents">
<h3><a class="toc-backref" href="#id25">Contents</a><a class="headerlink" href="#contents" title="Permalink to this headline">¶</a></h3>
<div class="contents topic" id="id1">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#sr3" id="id21">SR3</a></p>
<ul>
<li><p><a class="reference internal" href="#sr3-sarracenia-cli" id="id22">sr3 Sarracenia CLI</a></p>
<ul>
<li><p><a class="reference internal" href="#synopsis" id="id23">SYNOPSIS</a></p></li>
<li><p><a class="reference internal" href="#description" id="id24">DESCRIPTION</a></p></li>
<li><p><a class="reference internal" href="#contents" id="id25">Contents</a></p></li>
<li><p><a class="reference internal" href="#commands" id="id26">COMMANDS</a></p></li>
<li><p><a class="reference internal" href="#components" id="id27">COMPONENTS</a></p>
<ul>
<li><p><a class="reference internal" href="#cpump-sr-cpump" id="id28">CPUMP|sr_cpump</a></p></li>
<li><p><a class="reference internal" href="#poll" id="id29">POLL</a></p>
<ul>
<li><p><a class="reference internal" href="#repeated-scans-and-vip" id="id30">Repeated Scans and VIP</a></p></li>
<li><p><a class="reference internal" href="#polling-specifications" id="id31">POLLING SPECIFICATIONS</a></p></li>
<li><p><a class="reference internal" href="#posting-specifications" id="id32">POSTING SPECIFICATIONS</a></p></li>
<li><p><a class="reference internal" href="#advanced-features" id="id33">ADVANCED FEATURES</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#post-sr3-post-sr-cpost-watch" id="id34">post|sr3_post|sr_cpost|watch</a></p>
<ul>
<li><p><a class="reference internal" href="#settings" id="id35">Settings</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#p-path-path" id="id36">[-p|–path path]</a></p></li>
<li><p><a class="reference internal" href="#blocksize-value" id="id37">[–blocksize &lt;value&gt;]</a></p></li>
<li><p><a class="reference internal" href="#e-fileevents-event-event" id="id38">[-e|–fileEvents &lt;event|event|…&gt;]</a></p></li>
<li><p><a class="reference internal" href="#fp-force-polling-boolean" id="id39">[-fp|–force_polling &lt;boolean&gt;]</a></p></li>
<li><p><a class="reference internal" href="#pos-post-on-start" id="id40">[-pos|–post_on_start]</a></p></li>
<li><p><a class="reference internal" href="#r-randomize" id="id41">[-r|–randomize]</a></p></li>
<li><p><a class="reference internal" href="#real-realpath-boolean" id="id42">[-real|–realpath &lt;boolean&gt;]</a></p></li>
<li><p><a class="reference internal" href="#rn-rename-path" id="id43">[-rn|–rename &lt;path&gt;]</a></p></li>
<li><p><a class="reference internal" href="#rr-reconnect" id="id44">[-rr|–reconnect]</a></p></li>
<li><p><a class="reference internal" href="#fs-follow-symlinks-boolean" id="id45">[-fs|–follow_symlinks &lt;boolean&gt;]</a></p></li>
<li><p><a class="reference internal" href="#header-name-value" id="id46">[-header &lt;name&gt;=&lt;value&gt;]</a></p></li>
<li><p><a class="reference internal" href="#id4" id="id47">[-real|–realpath &lt;boolean&gt;]</a></p></li>
<li><p><a class="reference internal" href="#id5" id="id48">[-rn|–rename &lt;path&gt;]</a></p></li>
<li><p><a class="reference internal" href="#sub-subtopic-key" id="id49">[-sub|–subtopic &lt;key&gt;]</a></p></li>
<li><p><a class="reference internal" href="#sleep-time" id="id50">[–sleep &lt;time&gt; ]</a></p></li>
<li><p><a class="reference internal" href="#sum-sum-string" id="id51">[-sum|–sum &lt;string&gt;]</a></p></li>
<li><p><a class="reference internal" href="#file-detection-strategies" id="id52">File Detection Strategies</a></p></li>
<li><p><a class="reference internal" href="#file-detection-strategy-table" id="id53">File Detection Strategy Table</a></p>
<ul>
<li><p><a class="reference internal" href="#shim-library-usage" id="id54">SHIM LIBRARY USAGE</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#shim-usage-notes" id="id55">Shim Usage Notes</a></p></li>
<li><p><a class="reference internal" href="#sarra" id="id56">SARRA</a></p>
<ul>
<li><p><a class="reference internal" href="#specific-consuming-requirements" id="id57">Specific consuming requirements</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#sender" id="id58">SENDER</a></p>
<ul>
<li><p><a class="reference internal" href="#destination-unavailable" id="id59">DESTINATION UNAVAILABLE</a></p></li>
<li><p><a class="reference internal" href="#setup-1-pump-to-pump-replication" id="id60">SETUP 1 : PUMP TO PUMP REPLICATION</a></p></li>
<li><p><a class="reference internal" href="#destination-setup-2-metpx-sundew-like-dissemination" id="id61">DESTINATION SETUP 2 : METPX-SUNDEW LIKE DISSEMINATION</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#shovel" id="id62">shovel</a></p></li>
<li><p><a class="reference internal" href="#subscribe" id="id63">subscribe</a></p></li>
<li><p><a class="reference internal" href="#watch" id="id64">watch</a></p></li>
<li><p><a class="reference internal" href="#winnow" id="id65">winnow</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#id11" id="id66">DESCRIPTION</a></p>
<ul>
<li><p><a class="reference internal" href="#documentation" id="id67">Documentation</a></p></li>
<li><p><a class="reference internal" href="#configurations" id="id68">Configurations</a></p></li>
<li><p><a class="reference internal" href="#option-syntax" id="id69">Option Syntax</a></p>
<ul>
<li><p><a class="reference internal" href="#option-order" id="id70">Option Order</a></p></li>
<li><p><a class="reference internal" href="#flowcallback-options" id="id71">flowCallback options</a></p></li>
<li><p><a class="reference internal" href="#callback-options" id="id72">callback options</a></p></li>
<li><p><a class="reference internal" href="#importing-extensions" id="id73">Importing Extensions</a></p></li>
<li><p><a class="reference internal" href="#deprecated-v2-plugins" id="id74">Deprecated v2 plugins</a></p></li>
<li><p><a class="reference internal" href="#environment-variables" id="id75">Environment Variables</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#logs-and-monitoring" id="id76">LOGS and MONITORING</a></p></li>
<li><p><a class="reference internal" href="#credentials" id="id77">CREDENTIALS</a></p>
<ul>
<li><p><a class="reference internal" href="#credential-details" id="id78">Credential Details</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#consumer" id="id79">CONSUMER</a></p>
<ul>
<li><p><a class="reference internal" href="#setting-the-broker" id="id80">Setting the Broker</a></p></li>
<li><p><a class="reference internal" href="#creating-the-queue" id="id81">Creating the Queue</a></p>
<ul>
<li><p><a class="reference internal" href="#queue-queue-name-qn-name" id="id82">[ queue|queue_name|qn &lt;name&gt;]</a></p></li>
<li><p><a class="reference internal" href="#durable-boolean-default-true" id="id83">durable &lt;boolean&gt; (default: True)</a></p></li>
<li><p><a class="reference internal" href="#expire-duration-default-5m-five-minutes-recommend-overriding" id="id84">expire &lt;duration&gt; (default: 5m  == five minutes. RECOMMEND OVERRIDING)</a></p></li>
<li><p><a class="reference internal" href="#message-ttl-duration-default-none" id="id85">message_ttl &lt;duration&gt;  (default: None)</a></p></li>
<li><p><a class="reference internal" href="#prefetch-n-default-1" id="id86">prefetch &lt;N&gt; (default: 1)</a></p></li>
<li><p><a class="reference internal" href="#reset-boolean-default-false" id="id87">reset &lt;boolean&gt; (default: False)</a></p></li>
<li><p><a class="reference internal" href="#save-restore" id="id88">save/restore</a></p></li>
<li><p><a class="reference internal" href="#declare-queue-bind-queue" id="id89">declare_queue/bind_queue</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#amqp-queue-bindings" id="id90">AMQP QUEUE BINDINGS</a></p>
<ul>
<li><p><a class="reference internal" href="#exchange-name-default-xpublic-and-exchange-suffix" id="id91">exchange &lt;name&gt; (default: xpublic) and exchange_suffix</a></p></li>
<li><p><a class="reference internal" href="#subtopic-amqp-pattern-default" id="id92">subtopic &lt;amqp pattern&gt; (default: #)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#client-side-filtering" id="id93">Client-side Filtering</a></p>
<ul>
<li><p><a class="reference internal" href="#brief-introduction-to-regular-expressions" id="id94">Brief Introduction to Regular Expressions</a></p></li>
<li><p><a class="reference internal" href="#accept-reject-and-accept-unmatch" id="id95">accept, reject and accept_unmatch</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#acceleration" id="id96">ACCELERATION</a></p>
<ul>
<li><p><a class="reference internal" href="#accel-treshold-byte-count-default-0-disabled" id="id97">accel_treshold &lt;byte count&gt; (default: 0- disabled.)</a></p></li>
<li><p><a class="reference internal" href="#accel-xx-command" id="id98">accel_xx_command</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#delivery-specifications" id="id99">DELIVERY SPECIFICATIONS</a></p>
<ul>
<li><p><a class="reference internal" href="#attempts-count-default-3" id="id100">attempts &lt;count&gt; (default: 3)</a></p></li>
<li><p><a class="reference internal" href="#acceptsizewrong-boolean-default-false" id="id101">acceptSizeWrong: &lt;boolean&gt; (default: False)</a></p></li>
<li><p><a class="reference internal" href="#retry-ttl-duration-default-same-as-expire" id="id102">retry_ttl &lt;duration&gt; (default: same as expire)</a></p></li>
<li><p><a class="reference internal" href="#timeout-float-default-0" id="id103">timeout &lt;float&gt; (default: 0)</a></p></li>
<li><p><a class="reference internal" href="#inflight-string-default-tmp-or-none-if-post-broker-set" id="id104">inflight &lt;string&gt; (default: .tmp or NONE if post_broker set)</a></p></li>
<li><p><a class="reference internal" href="#delete-boolean-default-off" id="id105">delete &lt;boolean&gt; (default: off)</a></p></li>
<li><p><a class="reference internal" href="#batch-count-default-100" id="id106">batch &lt;count&gt; (default: 100)</a></p></li>
<li><p><a class="reference internal" href="#directory-path-default" id="id107">directory &lt;path&gt; (default: .)</a></p></li>
<li><p><a class="reference internal" href="#mirror-boolean-default-off" id="id108">mirror &lt;boolean&gt; (default: off)</a></p></li>
<li><p><a class="reference internal" href="#strip-count-regexp-default-0" id="id109">strip &lt;count|regexp&gt; (default: 0)</a></p></li>
<li><p><a class="reference internal" href="#flatten-string-default" id="id110">flatten &lt;string&gt; (default: ‘/’)</a></p></li>
<li><p><a class="reference internal" href="#basedir-path-default" id="id111">baseDir &lt;path&gt; (default: /)</a></p></li>
<li><p><a class="reference internal" href="#inline-boolean-default-false" id="id112">inline &lt;boolean&gt; (default: False)</a></p></li>
<li><p><a class="reference internal" href="#inplace-boolean-default-on" id="id113">inplace &lt;boolean&gt; (default: On)</a></p></li>
<li><p><a class="reference internal" href="#outlet-post-json-url-default-post" id="id114">outlet post|json|url (default: post)</a></p></li>
<li><p><a class="reference internal" href="#overwrite-boolean-default-off" id="id115">overwrite &lt;boolean&gt; (default: off)</a></p></li>
<li><p><a class="reference internal" href="#discard-boolean-default-off" id="id116">discard &lt;boolean&gt; (default: off)</a></p></li>
<li><p><a class="reference internal" href="#source-from-exchange-boolean-default-off" id="id117">source_from_exchange &lt;boolean&gt; (default: off)</a></p></li>
<li><p><a class="reference internal" href="#housekeeping-count-default-300-seconds" id="id118">housekeeping &lt;count&gt; (default: 300 seconds)</a></p></li>
<li><p><a class="reference internal" href="#shim-defer-posting-to-exit-experimental" id="id119">shim_defer_posting_to_exit (EXPERIMENTAL)</a></p></li>
<li><p><a class="reference internal" href="#shim-post-minterval-interval-experimental" id="id120">shim_post_minterval <em>interval</em> (EXPERIMENTAL)</a></p></li>
<li><p><a class="reference internal" href="#shim-skip-parent-open-files-experimental" id="id121">shim_skip_parent_open_files (EXPERIMENTAL)</a></p></li>
<li><p><a class="reference internal" href="#suppress-duplicates-off-on-999-smhdw-default-off" id="id122">suppress_duplicates &lt;off|on|999[smhdw]&gt; (default: off)</a></p></li>
<li><p><a class="reference internal" href="#suppress-duplicates-basis-data-name-path-default-path" id="id123">suppress_duplicates_basis &lt;data|name|path&gt; (default: path)</a></p></li>
<li><p><a class="reference internal" href="#kbytes-ps-count-default-0" id="id124">kbytes_ps &lt;count&gt; (default: 0)</a></p></li>
<li><p><a class="reference internal" href="#messagecountmax-count-default-0" id="id125">messageCountMax &lt;count&gt; (default: 0)</a></p></li>
<li><p><a class="reference internal" href="#messageratemax-float-default-0" id="id126">messageRateMax &lt;float&gt; (default: 0)</a></p></li>
<li><p><a class="reference internal" href="#messageratemin-float-default-0" id="id127">messageRateMin &lt;float&gt; (default: 0)</a></p></li>
<li><p><a class="reference internal" href="#timecopy-default-on" id="id128">timeCopy (default: on)</a></p></li>
<li><p><a class="reference internal" href="#permdefault-permdirdefault-permlog-permcopy" id="id129">permDefault, permDirDefault, permLog, permCopy</a></p></li>
<li><p><a class="reference internal" href="#tls-rigour-default-medium" id="id130">tls_rigour (default: medium)</a></p></li>
<li><p><a class="reference internal" href="#xattr-disable-default-off" id="id131">xattr_disable (default: off)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#delivery-completion-inflight" id="id132">Delivery Completion (inflight)</a></p>
<ul>
<li><p><a class="reference internal" href="#frequent-configuration-errors" id="id133">Frequent Configuration Errors</a></p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference internal" href="#on-windows" id="id134">On Windows</a></p></li>
<li><p><a class="reference internal" href="#periodic-processing" id="id135">PERIODIC PROCESSING</a></p>
<ul>
<li><p><a class="reference internal" href="#sanity-log-dead-interval-default-1-5-housekeeping" id="id136">sanity_log_dead &lt;interval&gt; (default: 1.5*housekeeping)</a></p></li>
<li><p><a class="reference internal" href="#suppress-duplicates-off-on-999-default-off" id="id137">suppress_duplicates &lt;off|on|999&gt; (default: off)</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#error-recovery" id="id138">ERROR RECOVERY</a></p></li>
<li><p><a class="reference internal" href="#examples" id="id139">EXAMPLES</a></p></li>
<li><p><a class="reference internal" href="#naming-exchanges-and-queues" id="id140">NAMING EXCHANGES AND QUEUES</a></p></li>
<li><p><a class="reference internal" href="#queues-and-multiple-streams" id="id141">QUEUES and MULTIPLE STREAMS</a></p></li>
<li><p><a class="reference internal" href="#report-back-and-report-exchange" id="id142">report_back and report_exchange</a></p></li>
<li><p><a class="reference internal" href="#instances" id="id143">INSTANCES</a></p>
<ul>
<li><p><a class="reference internal" href="#vip-active-passive-options" id="id144">vip - ACTIVE/PASSIVE OPTIONS</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#posting-options" id="id145">POSTING OPTIONS</a></p>
<ul>
<li><p><a class="reference internal" href="#blocksize-value-default-0-auto" id="id146">[–blocksize &lt;value&gt;] (default: 0 (auto))</a></p></li>
<li><p><a class="reference internal" href="#pbd-post-basedir-path-optional" id="id147">[-pbd|–post_baseDir &lt;path&gt;] (optional)</a></p></li>
<li><p><a class="reference internal" href="#post-baseurl-url-mandatory" id="id148">post_baseUrl &lt;url&gt; (MANDATORY)</a></p></li>
<li><p><a class="reference internal" href="#post-exchange-name-default-xpublic" id="id149">post_exchange &lt;name&gt; (default: xpublic)</a></p></li>
<li><p><a class="reference internal" href="#post-exchange-split-number-default-0" id="id150">post_exchange_split   &lt;number&gt;   (default: 0)</a></p></li>
<li><p><a class="reference internal" href="#remote-configurations" id="id151">Remote Configurations</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#extensions" id="id152">Extensions</a></p>
<ul>
<li><p><a class="reference internal" href="#flowcallback-and-flowcallbackprepend-class" id="id153">flowCallback and flowCallbackPrepend &lt;class&gt;</a></p></li>
<li><p><a class="reference internal" href="#integrity" id="id154">Integrity</a></p></li>
<li><p><a class="reference internal" href="#transfer" id="id155">Transfer</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#queue-save-restore" id="id156">Queue Save/Restore</a></p>
<ul>
<li><p><a class="reference internal" href="#sender-destination-unavailable" id="id157">Sender Destination Unavailable</a></p></li>
<li><p><a class="reference internal" href="#shovel-save-restore" id="id158">Shovel Save/Restore</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#roles-feeder-admin-declare" id="id159">ROLES - feeder/admin/declare</a></p>
<ul>
<li><p><a class="reference internal" href="#subscriber" id="id160">subscriber</a></p></li>
<li><p><a class="reference internal" href="#source" id="id161">source</a></p></li>
<li><p><a class="reference internal" href="#feeder" id="id162">feeder</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#configuration-files" id="id163">CONFIGURATION FILES</a></p></li>
<li><p><a class="reference internal" href="#see-also" id="id164">SEE ALSO</a></p></li>
<li><p><a class="reference internal" href="#bugs" id="id165">BUGS</a></p></li>
<li><p><a class="reference internal" href="#developer-only-options" id="id166">DEVELOPER ONLY OPTIONS</a></p></li>
<li><p><a class="reference internal" href="#sundew-compatibility-options" id="id167">SUNDEW COMPATIBILITY OPTIONS</a></p>
<ul>
<li><p><a class="reference internal" href="#destfn-script-script-default-none" id="id168">destfn_script &lt;script&gt; (default:None)</a></p></li>
<li><p><a class="reference internal" href="#filename-keyword-default-whatfn" id="id169">filename &lt;keyword&gt; (default:WHATFN)</a></p></li>
<li><p><a class="reference internal" href="#field-replacements" id="id170">Field Replacements</a></p></li>
<li><p><a class="reference internal" href="#deprecated-settings" id="id171">DEPRECATED SETTINGS</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#history" id="id172">HISTORY</a></p>
<ul>
<li><p><a class="reference internal" href="#dd-subscribe-renaming" id="id173">dd_subscribe Renaming</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</section>
<section id="commands">
<h3><a class="toc-backref" href="#id26">COMMANDS</a><a class="headerlink" href="#commands" title="Permalink to this headline">¶</a></h3>
<p><strong>declare|setup</strong></p>
<p>Call the corresponding function for each configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 declare
  declare: 2020-09-06 23:22:18,043 [INFO] root declare looking at cpost/pelle_dd1_f04
  2020-09-06 23:22:18,048 [INFO] sarra.moth.amqp __putSetup exchange declared: xcvan00 (as: amqp://tfeed@localhost/)
  2020-09-06 23:22:18,049 [INFO] sarra.moth.amqp __putSetup exchange declared: xcvan01 (as: amqp://tfeed@localhost/)
  2020-09-06 23:22:18,049 [INFO] root declare looking at cpost/veille_f34
  2020-09-06 23:22:18,053 [INFO] sarra.moth.amqp __putSetup exchange declared: xcpublic (as: amqp://tfeed@localhost/)
  2020-09-06 23:22:18,053 [INFO] root declare looking at cpost/pelle_dd2_f05
  ...
  2020-09-06 23:22:18,106 [INFO] root declare looking at cpost/pelle_dd2_f05
  2020-09-06 23:22:18,106 [INFO] root declare looking at cpump/xvan_f14
  2020-09-06 23:22:18,110 [INFO] sarra.moth.amqp __getSetup queue declared q_tfeed.sr_cpump.xvan_f14.23011811.49631644 (as: amqp://tfeed@localhost/)
  2020-09-06 23:22:18,110 [INFO] sarra.moth.amqp __getSetup um..: pfx: v03, exchange: xcvan00, values: #
  2020-09-06 23:22:18,110 [INFO] sarra.moth.amqp __getSetup binding q_tfeed.sr_cpump.xvan_f14.23011811.49631644 with v03.# to xcvan00 (as: amqp://tfeed@localhost/)
  2020-09-06 23:22:18,111 [INFO] root declare looking at cpump/xvan_f15
  2020-09-06 23:22:18,115 [INFO] sarra.moth.amqp __getSetup queue declared q_tfeed.sr_cpump.xvan_f15.50074940.98161482 (as: amqp://tfeed@localhost/)
</pre></div>
</div>
<p>Declares the queues and exchanges related to each configuration.
One can also invoke it with –users, so that it will declare users as well as exchanges and queues:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 --users declare
  2020-09-06 23:28:56,211 [INFO] sarra.rabbitmq_admin add_user permission user &#39;ender&#39; role source  configure=&#39;^q_ender.*|^xs_ender.*&#39; write=&#39;^q_ender.*|^xs_ender.*&#39; read=&#39;^q_ender.*|^x[lrs]_ender.*|^x.*public$&#39;
  ...
</pre></div>
</div>
<p><strong>dump</strong></p>
<p>print the three data structure used by sr.  There are three lists:</p>
<ul class="simple">
<li><p>processes thought to be related to sr.</p></li>
<li><p>configurations present</p></li>
<li><p>contents of the state files.</p></li>
</ul>
<p><strong>dump</strong> is used for debugging or to get more detail than provided by status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Running</span> <span class="n">Processes</span>
     <span class="mi">4238</span><span class="p">:</span> <span class="n">name</span><span class="p">:</span><span class="n">sr_poll</span><span class="o">.</span><span class="n">py</span> <span class="n">cmdline</span><span class="p">:[</span><span class="s1">&#39;/usr/bin/python3&#39;</span><span class="p">,</span> <span class="s1">&#39;/home/peter/src/sarracenia/sarra/sr_poll.py&#39;</span><span class="p">,</span> <span class="s1">&#39;--no&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="s1">&#39;pulse&#39;</span><span class="p">]</span>
     <span class="o">.</span>
     <span class="o">.</span>
     <span class="o">.</span>
<span class="n">Configs</span>
   <span class="n">cpost</span>
       <span class="n">veille_f34</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;running&#39;</span><span class="p">,</span> <span class="s1">&#39;instances&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

<span class="n">States</span>
   <span class="n">cpost</span>
       <span class="n">veille_f34</span> <span class="p">:</span> <span class="p">{</span><span class="s1">&#39;instance_pids&#39;</span><span class="p">:</span> <span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">4251</span><span class="p">},</span> <span class="s1">&#39;queue_name&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;instances_expected&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;has_state&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;missing_instances&#39;</span><span class="p">:</span> <span class="p">[]}</span>

<span class="n">Missing</span>
</pre></div>
</div>
<p>It is quite long, and so a bit too much information to look at in a raw state.
Usually used in conjunction with linux filters, such as grep.
for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 dump  | grep stopped
  WMO_mesh_post : {&#39;status&#39;: &#39;stopped&#39;, &#39;instances&#39;: 0}
  shim_f63 : {&#39;status&#39;: &#39;stopped&#39;, &#39;instances&#39;: 0}
  test2_f61 : {&#39;status&#39;: &#39;stopped&#39;, &#39;instances&#39;: 0}

$ sr3 dump  | grep disabled
  amqp_f30.conf : {&#39;status&#39;: &#39;disabled&#39;, &#39;instances&#39;: 5}
</pre></div>
</div>
<p>provides easy method to determine which configurations are in a particular state.
Another example, if <em>sr status</em> reports sender/tsource2send_f50 as being partial, then
one can use dump to get more detail:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 dump | grep sender/tsource2send_f50
  49308: name:sr3_sender.py cmdline:[&#39;/usr/bin/python3&#39;, &#39;/usr/lib/python3/dist-packages/sarracenia/instance.py&#39;, &#39;--no&#39;, &#39;1&#39;, &#39;start&#39;, &#39;sender/tsource2send_f50&#39;]
  q_tsource.sr_sender.tsource2send_f50.58710892.12372870: [&#39;sender/tsource2send_f50&#39;]
</pre></div>
</div>
<p><strong>foreground</strong></p>
<p>run a single instance of a single configuration as an interactive process logging to the current stderr/terminal output.
for debugging.</p>
<p><strong>list</strong></p>
<p>shows the user the configuration files present:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 list
  User Configurations: (from: /home/peter/.config/sarra )
  cpost/pelle_dd1_f04.conf         cpost/pelle_dd2_f05.conf         cpost/veille_f34.conf
  cpump/xvan_f14.conf              cpump/xvan_f15.conf              poll/f62.conf
  post/shim_f63.conf               post/t_dd1_f00.conf              post/t_dd2_f00.conf
  post/test2_f61.conf              sarra/download_f20.conf          sender/tsource2send_f50.conf
  shovel/rabbitmqtt_f22.conf       subscribe/amqp_f30.conf          subscribe/cclean_f91.conf
  subscribe/cdnld_f21.conf         subscribe/cfile_f44.conf         subscribe/cp_f61.conf
  subscribe/ftp_f70.conf           subscribe/q_f71.conf             subscribe/rabbitmqtt_f31.conf
  subscribe/u_sftp_f60.conf        watch/f40.conf                   admin.conf
  credentials.conf                 default.conf
  logs are in: /home/peter/.cache/sarra/log
</pre></div>
</div>
<p>The last line says which directory the log files are in.</p>
<p>Also <em>list examples</em> shows included configuration templates available as starting points with the <em>add</em> command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 list examples
  Sample Configurations: (from: /home/peter/Sarracenia/v03_wip/sarra/examples )
  cpump/cno_trouble_f00.inc        poll/aws-nexrad.conf             poll/pollingest.conf
  poll/pollnoaa.conf               poll/pollsoapshc.conf            poll/pollusgs.conf
  poll/pulse.conf                  post/WMO_mesh_post.conf          sarra/wmo_mesh.conf
  sender/ec2collab.conf            sender/pitcher_push.conf         shovel/no_trouble_f00.inc
  subscribe/WMO_Sketch_2mqtt.conf  subscribe/WMO_Sketch_2v3.conf    subscribe/WMO_mesh_CMC.conf
  subscribe/WMO_mesh_Peer.conf     subscribe/aws-nexrad.conf        subscribe/dd_2mqtt.conf
  subscribe/dd_all.conf            subscribe/dd_amis.conf           subscribe/dd_aqhi.conf
  subscribe/dd_cacn_bulletins.conf subscribe/dd_citypage.conf       subscribe/dd_cmml.conf
  subscribe/dd_gdps.conf           subscribe/dd_ping.conf           subscribe/dd_radar.conf
  subscribe/dd_rdps.conf           subscribe/dd_swob.conf           subscribe/ddc_cap-xml.conf
  subscribe/ddc_normal.conf        subscribe/downloademail.conf     subscribe/ec_ninjo-a.conf
  subscribe/hpfx_amis.conf         subscribe/local_sub.conf         subscribe/pitcher_pull.conf
  subscribe/sci2ec.conf            subscribe/subnoaa.conf           subscribe/subsoapshc.conf
  subscribe/subusgs.conf           watch/master.conf                watch/pitcher_client.conf
  watch/pitcher_server.conf        watch/sci2ec.conf


$ sr3 add dd_all.conf
  add: 2021-01-24 18:04:57,018 [INFO] sarracenia.sr add copying: /usr/lib/python3/dist-packages/sarracenia/examples/subscribe/dd_all.conf to /home/peter/.config/sr3/subscribe/dd_all.conf
$ sr3 edit dd_all.conf
</pre></div>
</div>
<p>The <strong>add, remove, list, edit, enable &amp; disable</strong> actions are used to manage the list
of configurations.  One can see all of the configurations available using the <strong>list</strong>
action.   to view available plugins use <strong>list plugins</strong>.  Using the <strong>edit</strong> option,
one can work on a particular configuration.  A <em>disabled</em> sets a configuration aside
(by adding <em>.off</em> to the name) so that it will not be started or restarted by
the <strong>start</strong>, <strong>foreground</strong>, or <strong>restart</strong> actions.</p>
<p><strong>show</strong></p>
<p>View all configuration settings (the result of all parsing… what the flow components actually see):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 --debug show subscribe/q_f71

  Config of subscribe/q_f71:
  _Config__admin=amqp://bunnymaster@localhost
  _Config__broker=amqp://tsource@localhost
  _Config__post_broker=None
  accept_unmatch=True
  accept_unmatched=False
  auto_delete=False
  baseDir=None
  batch=100
  bind=True
  bindings=[(&#39;v03&#39;, &#39;xs_tsource_poll&#39;, &#39;#&#39;)]
  bufsize=1048576
  bytes_per_second=None
  bytes_ps=0
  cfg_run_dir=&#39;/home/peter/.cache/sarra/subscribe/q_f71&#39;
  permDefault=0
  permDirDefault=509
  permLog=384
  config=&#39;q_f71&#39;
  currentDir=&#39;/home/peter/.cache/sarra/log&#39;
  debug=False
  declare=True
  declared_exchanges=[&#39;xpublic&#39;, &#39;xcvan01&#39;]
  delete=False
  destfn_script=None
  directory=&#39;//home/peter/sarra_devdocroot/recd_by_srpoll_test1&#39;
  documentRoot=None
  download=False
  durable=True
  env=environ({&#39;SHELL&#39;: &#39;/bin/bash&#39;, &#39;SESSION_MANAGER&#39;: &#39;local/fractal:@/tmp...&#39;
  exchange=&#39;xs_tsource_poll&#39;
  exchange_suffix=&#39;poll&#39;
  expire=3600.0
  feeder=&#39;amqp://tfeed@localhost/&#39;
  file_total_interval=&#39;0&#39;
  filename=None
  flatten=&#39;/&#39;
  hostdir=&#39;fractal&#39;
  hostname=&#39;fractal&#39;
  housekeeping=30
  inflight=None
  inline=False
  inline_only=False
  inline_encoding=&#39;guess&#39;
  inline_max=4096
  instances=1
  logFormat=&#39;%(asctime)s [%(levelname)s] %(name)s %(funcName)s %(message)s&#39;
  logLevel=&#39;info&#39;
  log_reject=True
  lr_backupCount=5
  lr_interval=1
  lr_when=&#39;midnight&#39;
  masks=[(&#39;.*&#39;, &#39;//home/peter/sarra_devdocroot/recd_by_srpoll_test1&#39;, None, re...&#39;
  message_strategy={&#39;reset&#39;: True, &#39;stubborn&#39;: True, &#39;failure_duration&#39;: &#39;5m&#39;}
  message_ttl=0
  mirror=True
  msg_total_interval=&#39;0&#39;
  plugins=[&#39;sarra.plugin.accel_scp.ACCEL_SCP&#39;]
  post_baseDir=None
  post_baseUrl=None
  post_documentRoot=None
  post_exchanges=[]
  prefetch=25
  permCopy=True
  timeCopy=True
  program_name=&#39;subscribe&#39;
  pstrip=&#39;.*sent_by_tsource2send/&#39;
  queue_filename=&#39;/home/peter/.cache/sarra/subscribe/q_f71/sr_subscribe.q_f71.tsource.qname&#39;
  queue_name=&#39;q_tsource.sr_subscribe.q_f71.68760401.09509451&#39;
  randid=&#39;b486&#39;
  realpath_post=False
  report_daemons=False
  reset=False
  resolved_qname=&#39;q_tsource.sr_subscribe.q_f71.68760401.09509451&#39;
  settings={}
  sleep=0.1
  statehost=False
  strip=0
  subtopic=None
  suppress_duplicates=0
  suppress_duplicates_basis=&#39;data&#39;
  timeout=300
  tls_rigour=&#39;normal&#39;
  topicPrefix=&#39;v03&#39;
  undeclared=[&#39;msg_total_interval&#39;, &#39;file_total_interval&#39;]
  users={&#39;tsub&#39;: &#39;subscriber&#39;, &#39;tsource&#39;: &#39;source&#39;, &#39;anonymous&#39;: &#39;subscriber&#39;,...&#39;
  v2plugin_options=[]
  v2plugins={&#39;plugin&#39;: [&#39;msg_total_save&#39;, &#39;file_total_save&#39;]}
  vhost=&#39;/&#39;
  vip=None
</pre></div>
</div>
<p><strong>start</strong></p>
<p>launch all configured components:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 start
  gathering global state: procs, configs, state files, logs, analysis - Done.
  starting...Done
</pre></div>
</div>
<p><strong>stop</strong></p>
<p>stop all processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 stop
  gathering global state: procs, configs, state files, logs, analysis - Done.
  stopping........Done
  Waiting 1 sec. to check if 93 processes stopped (try: 0)
  All stopped after try 0
</pre></div>
</div>
<p><strong>status</strong></p>
<p>Sample OK status (sr is running):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 status
  status:
  Component/Config                         State        Run  Miss   Exp Retry
  ----------------                         -----        ---  ----   --- -----
  cpost/pelle_dd1_f04                      stopped        0     0     0     0
  cpost/pelle_dd2_f05                      stopped        0     0     0     0
  cpost/veille_f34                         partial        0     1     1     0
  cpump/xvan_f14                           partial        0     1     1     0
  cpump/xvan_f15                           partial        0     1     1     0
  poll/f62                                 running        1     0     1     0
  post/shim_f63                            stopped        0     0     0     0
  post/t_dd1_f00                           stopped        0     0     0     0
  post/t_dd2_f00                           stopped        0     0     0     0
  post/test2_f61                           stopped        0     0     0     0
  report/tsarra_f20                        running        1     0     1     0
  sarra/download_f20                       running        1     0     1     0
  sender/tsource2send_f50                  running        1     0     1     0
  shovel/rabbitmqtt_f22                    running        1     0     1     0
  subscribe/amqp_f30                       running        1     0     1     0
  subscribe/cclean_f91                     running        1     0     1     0
  subscribe/cdnld_f21                      running        1     0     1     0
  subscribe/cfile_f44                      running        1     0     1     0
  subscribe/cp_f61                         running        1     0     1     0
  subscribe/dd_all                         stopped        0     0     0     0
  subscribe/ftp_f70                        running        1     0     1     0
  subscribe/q_f71                          running        1     0     1     0
  subscribe/rabbitmqtt_f31                 running        1     0     1     0
  subscribe/u_sftp_f60                     running        1     0     1     0
  watch/f40                                running        1     0     1     0
        total running configs:  15 ( processes: 15 missing: 3 stray: 0 )
</pre></div>
</div>
<p>The configurations are listed on the left. For each configuraion, the state
will be:</p>
<ul class="simple">
<li><p>stopped:  no processes are running.</p></li>
<li><p>running:  all processes are running.</p></li>
<li><p>partial:  some processes are running.</p></li>
<li><p>disabled: configured not to run.</p></li>
</ul>
<p>The columns to the right give more information, detailing how many processes are Running, and Missing ones.
The Expected entry lists how many processes should be running based on the configuration, and whether it is stopped
or not.  The contents of the Run and Miss columns should always add up to what is in the Exp column.</p>
<p>The last column is the number of messages stored in the local retry queue, indicating what channels are having
processing difficulties. Here is an example of seeing that a single configuration is running, stopping it,
cleaning it out:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 status
  status:
  Component/Config                         State        Run  Miss   Exp Retry
  ----------------                         -----        ---  ----   --- -----
  subscribe/dd_all                         running        5     0     1     0
        total running configs:   1 ( processes: 5 missing: 0 stray: 0 )

$ sr3 stop subscribe/dd_all
  Stopping: sending SIGTERM ..... ( 5 ) Done
  Waiting 1 sec. to check if 5 processes stopped (try: 0)
  Waiting 2 sec. to check if 3 processes stopped (try: 1)
  pid: 818881-[&#39;/usr/bin/python3&#39;, &#39;/usr/lib/python3/dist-packages/sarracenia/instance.py&#39;, &#39;--no&#39;, &#39;3&#39;, &#39;start&#39;] does not match any configured instance, sending it TERM
  Waiting 4 sec. to check if 3 processes stopped (try: 2)
  All stopped after try 2

$ sr3 cleanup subscribe/dd_all
  cleanup: queues to delete: [(ParseResult(scheme=&#39;amqps&#39;, netloc=&#39;anonymous:anonymous@dd.weather.gc.ca&#39;, path=&#39;/&#39;, params=&#39;&#39;, query=&#39;&#39;, fragment=&#39;&#39;), &#39;q_anonymous.sr_subscribe.dd_all.47257736.46056854&#39;)]
  removing state file: /home/peter/.cache/sr3/subscribe/dd_all/sr_subscribe.dd_all.anonymous.qname

$ sr3 remove subscribe/dd_all
  2021-01-24 23:57:59,800 [INFO] root remove FIXME remove! [&#39;subscribe/dd_all&#39;]
  2021-01-24 23:57:59,800 [INFO] root remove removing /home/peter/.config/sr3/subscribe/dd_all.conf

$ sr3 status
  status:
  Component/Config                         State        Run  Miss   Exp Retry
  ----------------                         -----        ---  ----   --- -----
        total running configs:   0 ( processes: 0 missing: 0 stray: 0 )
</pre></div>
</div>
</section>
<section id="components">
<h3><a class="toc-backref" href="#id27">COMPONENTS</a><a class="headerlink" href="#components" title="Permalink to this headline">¶</a></h3>
<section id="cpump-sr-cpump">
<h4><a class="toc-backref" href="#id28">CPUMP|sr_cpump</a><a class="headerlink" href="#cpump-sr-cpump" title="Permalink to this headline">¶</a></h4>
<p><em>cpump*</em> is an implementation of the <a class="reference internal" href="#shovel">shovel</a> component in C.
On an individual basis, it should be faster than a single python downloader,
with some limitations.</p>
<blockquote>
<div><ul class="simple">
<li><p>doesn’t download data, only circulates posts. (shovel, not subscribe)</p></li>
<li><p>runs as only a single instance (no multiple instances).</p></li>
<li><p>does not support any plugins.</p></li>
<li><p>does not support vip for high availability.</p></li>
<li><p>different regular expression library: POSIX vs. python.</p></li>
<li><p>does not support regex for the strip command (no non-greedy regex).</p></li>
</ul>
</div></blockquote>
<p>It can therefore usually, but not always, act as a drop-in replacement for <a class="reference internal" href="#shovel">shovel</a> and <a class="reference internal" href="#winnow">winnow</a></p>
<p>The C implementation may be easier to make available in specialized environments,
such as High Performance Computing, as it has far fewer dependencies than the python version.
It also uses far less memory for a given role.  Normally the python version
is recommended, but there are some cases where use of the C implementation is sensible.</p>
<p><strong>sr_cpump</strong> connects to a <em>broker</em> (often the same as the posting broker)
and subscribes to the notifications of interest. If _suppress_duplicates_ is active,
on reception of a post, it looks up the message’s <strong>integity</strong> field in its cache.  If it is
found, the file has already come through, so the notification is ignored. If not, then
the file is new, and the <strong>sum</strong> is added to the cache and the notification is posted.</p>
</section>
<section id="poll">
<h4><a class="toc-backref" href="#id29">POLL</a><a class="headerlink" href="#poll" title="Permalink to this headline">¶</a></h4>
<p><strong>poll</strong> is a component that connects to a remote server to
check in various directories for some files. When a file is
present, modified or created in the remote directory, the program will
notify about the new product.</p>
<p>The notification protocol is defined here <a class="reference external" href="sr3_post.7.rst">sr3_post(7)</a></p>
<p><strong>poll</strong> connects to a <em>broker</em>.  Every <em>sleep</em> seconds, it connects to
a <em>destination</em> (sftp, ftp, ftps). For each of the <em>directory</em> defined, it lists
the contents.  Polling is only intended to be used for recently modified
files. The <em>nodupe_fileAgeMax</em> option eliminates files that are too old
from consideration. When a file is found that matches a pattern given
by <em>accept</em>, <strong>poll</strong> builds a notification message for that product.</p>
<p>The message is then checked in the duplicate cache (time limited by
nodupe_ttl option.) to prevent posting of files which have already
been seen.</p>
<p><strong>poll</strong> can be used to acquire remote files in conjunction with an <a class="reference internal" href="#sarra">sarra</a>
subscribed to the posted notifications, to download and repost them from a data pump.</p>
<p>The destination option specify what is needed to connect to the remote server</p>
<p><strong>destination protocol://&lt;user&gt;&#64;&lt;server&gt;[:port]</strong></p>
<dl class="simple">
<dt>::</dt><dd><p>(default: None and it is mandatory to set it )</p>
</dd>
</dl>
<p>The <em>destination</em> should be set with the minimum required information…
<strong>sr_poll</strong>  uses <em>destination</em> setting not only when polling, but also
in the sr3_post messages produced.</p>
<p>For example, the user can set :</p>
<p><strong>destination ftp://myself&#64;myserver</strong></p>
<p>And complete the needed information in the credentials file with the line  :</p>
<p><strong>ftp://myself:mypassword&#64;myserver:2121  passive,binary</strong></p>
<p>Poll gathers information about remote files, to build messages about them.
The gather method that is built-in uses sarracenia.transfer protocols,
currently implemented are sftp, ftp, and http.</p>
<section id="repeated-scans-and-vip">
<h5><a class="toc-backref" href="#id30">Repeated Scans and VIP</a><a class="headerlink" href="#repeated-scans-and-vip" title="Permalink to this headline">¶</a></h5>
<p>When multiple servers are being co-operating to poll a remote server,
the <em>vip</em> setting is used to decide which server will actually poll.
All servers participating subscribe to where <strong>poll</strong> is posting,
and use the results to fill in the duplicate suppression cache, so
that if the VIP moves, the alternate servers have uptodate indications
of what was posted.</p>
</section>
<section id="polling-specifications">
<h5><a class="toc-backref" href="#id31">POLLING SPECIFICATIONS</a><a class="headerlink" href="#polling-specifications" title="Permalink to this headline">¶</a></h5>
<dl class="simple">
<dt>These options set what files the user wants to be notified for and where</dt><dd><p>it will be placed, and under which name.</p>
</dd>
</dl>
<ul class="simple">
<li><p><strong>filename  &lt;option&gt;         (optional)</strong></p></li>
<li><p><strong>directory &lt;path&gt;           (default: .)</strong></p></li>
<li><p><strong>accept    &lt;regexp pattern&gt; [rename=] (must be set)</strong></p></li>
<li><p><strong>reject    &lt;regexp pattern&gt; (optional)</strong></p></li>
<li><p><strong>permDefault     &lt;integer&gt;        (default: 0o400)</strong></p></li>
<li><p><strong>poll_without_vip  &lt;boolean&gt; (default: True)</strong></p></li>
<li><p><strong>nodupe_fileAgeMax &lt;duration&gt;   (default 30d)</strong></p></li>
</ul>
<p>The option <em>filename</em> can be used to set a global rename to the products.
Ex.:</p>
<p><strong>filename  rename=/naefs/grib2/</strong></p>
<p>For all posts created, the <em>rename</em> option would be set to ‘/naefs/grib2/filename’
because I specified a directory (path that ends with /).</p>
<p>The option <em>directory</em>  defines where to get the files on the server.
Combined with  <strong>accept</strong> / <strong>reject</strong>  options, the user can select the
files of interest and their directories of residence.</p>
<p>The  <strong>accept</strong>  and  <strong>reject</strong>  options use regular expressions (regexp) to match URL.
These options are processed sequentially.
The URL of a file that matches a  <strong>reject</strong>  pattern is not published.
Files matching an  <strong>accept</strong>  pattern are published.
Again a <em>rename</em>  can be added to the <em>accept</em> option… matching products
for that <em>accept</em> option would get renamed as described… unless the <em>accept</em> matches
one file, the <em>rename</em> option should describe a directory into which the files
will be placed (prepending instead of replacing the file name).</p>
<p>The directory can have some patterns. These supported patterns concern date/time .
They are fixed…</p>
<p><strong>${YYYY}         current year</strong>
<strong>${MM}           current month</strong>
<strong>${JJJ}          current julian</strong>
<strong>${YYYYMMDD}     current date</strong></p>
<p><strong>${YYYY-1D}      current year   - 1 day</strong>
<strong>${MM-1D}        current month  - 1 day</strong>
<strong>${JJJ-1D}       current julian - 1 day</strong>
<strong>${YYYYMMDD-1D}  current date   - 1 day</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>ex.   directory /mylocaldirectory/myradars
      accept    .*RADAR.*

      directory /mylocaldirectory/mygribs
      reject    .*Reg.*
      accept    .*GRIB.*

      directory /mylocaldirectory/${YYYYMMDD}/mydailies
      accept    .*observations.*
</pre></div>
</div>
<p>The <strong>permDefault</strong> option allows users to specify a linux-style numeric octal
permission mask:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">permDefault</span> <span class="mi">040</span>
</pre></div>
</div>
<p>means that a file will not be posted unless the group has read permission
(on an ls output that looks like: —r—–, like a chmod 040 &lt;file&gt; command).
The <strong>permDefault</strong> options specifies a mask, that is the permissions must be
at least what is specified.</p>
<p>As with all other components, the <strong>vip</strong> option can be used to indicate
that a poll should be active on only a single node in a cluster. Note that
as the poll will maintain state (such as the list of files that exist on the
remote hosts), by default, the vip will only keep the component from posting,
but the actual poll will still happen, which can involve a high an unnecessary
load on the nodes that do not have the vip.</p>
<p>To have the nodes which do not have the vip perform no work, for example
if the corresponding sarra components have <em>delete</em> set, so that no state
persistence is needed in the poll, set the <strong>poll_without_vip</strong> option
to <em>False</em> (or <em>off</em>). This reduces overhead forty-fold in some measured
cases.</p>
<p>files that are more than nodupe_fileAgeMax are ignored. However, this
can be modified to any specified time limit in the configurations by using
the option <em>nodupe_fileAgeMax &lt;duration&gt;</em>. By default in components
other than poll, it is disabled by being set to zero (0). As it is a
duration option, units are in seconds by default, but minutes, hours,
days, and weeks, are available. In the poll component, nodupe_fileAgeMax
defaults to 30 days.</p>
</section>
<section id="posting-specifications">
<h5><a class="toc-backref" href="#id32">POSTING SPECIFICATIONS</a><a class="headerlink" href="#posting-specifications" title="Permalink to this headline">¶</a></h5>
<p>These options set what files the user wants to be notified for and where
<strong>sr_poll</strong> polls the availability of file on a remote server by creating
an announcment for it.  Subscribers use <a class="reference external" href="#subscribe">sr_subscribe</a>
to consume the announcement and download the file (or <strong>sr_sarra</strong>).
To make files available to subscribers, <strong>sr_poll</strong> sends the announcements to
an AMQP or MQTT server, also called a broker.  Format of argument to the <em>broker</em> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">amqp</span><span class="o">|</span><span class="n">amqps</span><span class="p">]:</span><span class="o">//</span><span class="p">[</span><span class="n">user</span><span class="p">[:</span><span class="n">password</span><span class="p">]</span><span class="o">@</span><span class="p">]</span><span class="n">host</span><span class="p">[:</span><span class="n">port</span><span class="p">][</span><span class="o">/</span><span class="n">vhost</span><span class="p">]</span>
</pre></div>
</div>
<p>The announcement will have its url built from the <em>destination</em> option, with
the product’s path (<em>directory</em>/”matched file”).  There is one post per file.
The file’s size is taken from the directory “ls”… but its checksum cannot
be determined, so the “sum” header in the posting is set to “0,0.”</p>
<p>By default, sr_poll sends its post message to the broker with default exchange
(the prefix <em>xs_</em> followed by the broker username). The <em>broker</em> is mandatory.
It can be given incomplete if it is well defined in the credentials.conf file.</p>
<p>Refer to <a class="reference external" href="sr3_post.1.rst">sr3_post(1)</a> - to understand the complete notification process.
Refer to <a class="reference external" href="sr3_post.7.rst">sr3_post(7)</a> - to understand the complete notification format.</p>
<p>Here it is important to say that :</p>
<p>The <em>sum=0,0</em> is used because no checksum computation was performed. It is often
desirable to use the <em>sum=z,s</em> to have downloaders calculate a useful checksum as
they download for use by others.</p>
<p>The <em>parts=1,fsiz,1,0,0</em> is used and the file’s size is taken from the ls of the file.
Under <strong>sr_sarra</strong> these fields could be reset.</p>
</section>
<section id="advanced-features">
<h5><a class="toc-backref" href="#id33">ADVANCED FEATURES</a><a class="headerlink" href="#advanced-features" title="Permalink to this headline">¶</a></h5>
<p>The built-in Poll lists remote directories and parses the lines returned building
paramiko.SFTPAttributes structures (similar to os.stat) for each file listed.
There is a wide variety of customization available because resources to poll
are so disparate:</p>
<ul class="simple">
<li><p>one can implement a <em>sarracenia.flowcb</em> callback with a <em>poll</em> routine
to support such services, replacing the default poller.</p></li>
<li><p>Some servers have non-standard results when listing files, so one can
subclass a sarracenia.flowcb.poll callback with the <strong>on_line</strong>
entry point to normalize their responses and still be able to use the
builtin polling flow.</p></li>
<li><p>There are many http servers that provide disparately formatted
listings of files, so that sometimes rather than reformatting individual
lines, a means of overriding the parsing of an entire page is needed.
The <strong>on_html_page</strong> entry point in sarracenia.flowcb.poll can be
modified by subclassing as well.</p></li>
<li><p>There are other servers that provide different services, not covered
buy the default poll. One can implement additional <em>sarracenia.transfer</em>
classes to add understanding of them to poll.</p></li>
</ul>
<p>The output of a poll is a list of messages built from the file names
and SFTPAttributes records, which can then be filtered by elements
after <em>gather</em> in the algorithm.</p>
</section>
</section>
<section id="post-sr3-post-sr-cpost-watch">
<h4><a class="toc-backref" href="#id34">post|sr3_post|sr_cpost|watch</a><a class="headerlink" href="#post-sr3-post-sr-cpost-watch" title="Permalink to this headline">¶</a></h4>
<p><strong>sr3_post</strong> posts the availability of a file by creating an announcement.
In contrast to most other sarracenia components that act as daemons,
sr3_post is a one shot invocation which posts and exits.
To make files available to subscribers, <strong>sr3_post</strong> sends the announcements
to an AMQP or MQTT server, also called a broker.</p>
<p>This manual page is primarily concerned with the python implementation,
but there is also an implementation in C, which works nearly identically.
Differences:</p>
<blockquote>
<div><ul class="simple">
<li><p>plugins are not supported in the C implementation.</p></li>
<li><p>C implementation uses POSIX regular expressions, python3 grammar is slightly different.</p></li>
<li><p>when the <em>sleep</em> option ( used only in the C implementation) is set to &gt; 0,
it transforms sr_cpost into a daemon that works like <a class="reference internal" href="#watch">watch</a>.</p></li>
</ul>
</div></blockquote>
<p>The <em>watch</em> component is used to monitor directories for new files.
It is equivalent to post (or cpost) with the <em>sleep</em> option set to &gt;0.</p>
<section id="settings">
<h5><a class="toc-backref" href="#id35">Settings</a><a class="headerlink" href="#settings" title="Permalink to this headline">¶</a></h5>
<p>The [<em>-pbu|–post_baseUrl url,url,…</em>] option specifies the location
subscribers will download the file from.  There is usually one post per file.
Format of argument to the <em>post_baseUrl</em> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ftp</span><span class="o">|</span><span class="n">http</span><span class="o">|</span><span class="n">sftp</span><span class="p">]:</span><span class="o">//</span><span class="p">[</span><span class="n">user</span><span class="p">[:</span><span class="n">password</span><span class="p">]</span><span class="o">@</span><span class="p">]</span><span class="n">host</span><span class="p">[:</span><span class="n">port</span><span class="p">]</span><span class="o">/</span>
<span class="ow">or</span>
<span class="n">file</span><span class="p">:</span>
</pre></div>
</div>
<p>When several urls are given as a comma separated list to <em>post_baseUrl</em>, the
url´s provided are used round-robin style, to provide a coarse form of load balancing.</p>
<p>The [<em>-p|–path path1 path2 .. pathN</em>] option specifies the path of the files
to be announced. There is usually one post per file.
Format of argument to the <em>path</em> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">absolute_path_to_the</span><span class="o">/</span><span class="n">filename</span>
<span class="ow">or</span>
<span class="n">relative_path_to_the</span><span class="o">/</span><span class="n">filename</span>
</pre></div>
</div>
<p>The <em>-pipe</em> option can be specified to have sr3_post read path names from standard
input as well.</p>
<p>An example invocation of <em>sr3_post</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3_post</span> <span class="o">-</span><span class="n">pb</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">broker</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">pbu</span> <span class="n">sftp</span><span class="p">:</span><span class="o">//</span><span class="n">stanley</span><span class="nd">@mysftpserver</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">foo</span>
</pre></div>
</div>
<p>By default, sr3_post reads the file /data/shared/products/foo and calculates its checksum.
It then builds a post message, logs into broker.com as user ‘guest’ (default credentials)
and sends the post  to defaults vhost ‘/’ and default exchange. The default exchange
is the prefix <em>xs_</em> followed by the broker username, hence defaulting to ‘xs_guest’.
A subscriber can download the file /data/shared/products/foo by authenticating as user stanley
on mysftpserver.com using the sftp protocol to broker.com assuming he has proper credentials.
The output of the command is as follows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Published</span> <span class="n">xs_guest</span> <span class="n">v03</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">foo</span> <span class="s1">&#39;20150813161959.854 sftp://stanley@mysftpserver.com/ /data/shared/products/foo&#39;</span> <span class="nb">sum</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="mi">82</span><span class="n">edc8eb735fd99598a1fe04541f558d</span> <span class="n">parts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4574</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
</pre></div>
</div>
<p>In MetPX-Sarracenia, each post is published under a certain topic.
The log line starts with ‘[INFO]’, followed by the <strong>topic</strong> of the
post. Topics in <em>AMQP</em> are fields separated by dot. Note that MQTT topics use
a slash (/) as the topic separator.  The complete topic starts with
a topicPrefix (see option), version <em>v03</em>,
followed by a subtopic (see option) here the default, the file path separated with dots
<em>data.shared.products.foo</em>.</p>
<p>The second field in the log line is the message notice.  It consists of a time
stamp <em>20150813161959.854</em>, and the source URL of the file in the last 2 fields.</p>
<p>The rest of the information is stored in AMQP message headers, consisting of key=value pairs.
The <em>sum=d,82edc8eb735fd99598a1fe04541f558d</em> header gives file fingerprint (or checksum
) information.  Here, <em>d</em> means md5 checksum performed on the data, and <em>82edc8eb735fd99598a1fe04541f558d</em>
is the checksum value. The <em>parts=1,4574,1,0,0</em> state that the file is available in 1 part of 4574 bytes
(the filesize.)  The remaining <em>1,0,0</em> is not used for transfers of files with only one part.</p>
<p>Another example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3_post</span> <span class="o">-</span><span class="n">pb</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">broker</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">pbd</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">public_data</span> <span class="o">-</span><span class="n">pbu</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span> <span class="o">-</span><span class="n">p</span> <span class="n">bulletins</span><span class="o">/</span><span class="n">alphanumeric</span><span class="o">/</span><span class="n">SACN32_CWAO_123456</span>
</pre></div>
</div>
<p>By default, sr3_post reads the file /data/web/public_data/bulletins/alphanumeric/SACN32_CWAO_123456
(concatenating the post_baseDir and relative path of the source url to obtain the local file path)
and calculates its checksum. It then builds a post message, logs into broker.com as user ‘guest’
(default credentials) and sends the post to defaults vhost ‘/’ and exchange ‘xs_guest’.</p>
<p>A subscriber can download the file <a class="reference external" href="http://dd.weather.gc.ca/bulletins/alphanumeric/SACN32_CWAO_123456">http://dd.weather.gc.ca/bulletins/alphanumeric/SACN32_CWAO_123456</a> using http
without authentication on dd.weather.gc.ca.</p>
</section>
</section>
<section id="p-path-path">
<h4><a class="toc-backref" href="#id36">[-p|–path path]</a><a class="headerlink" href="#p-path-path" title="Permalink to this headline">¶</a></h4>
<p><strong>sr_post</strong> evaluates the filesystem path from the <strong>path</strong> option
and possibly the <strong>post_base_dir</strong> if the option is used.</p>
<p>If a path defines a file then this file is watched.</p>
<p>If a path defines a directory then all files in that directory are
watched…</p>
<p>If this path defines a directory, all files in that directory are
watched and should <strong>sr_watch</strong> find one (or more) directory(ies), it
watches it(them) recursively until all the tree is scanned.</p>
<p>The AMQP announcements are made of the tree fields, the announcement time,
the <strong>url</strong> option value and the resolved paths to which were withdrawn
the <em>post_base_dir</em> present and needed.</p>
</section>
<section id="blocksize-value">
<h4><a class="toc-backref" href="#id37">[–blocksize &lt;value&gt;]</a><a class="headerlink" href="#blocksize-value" title="Permalink to this headline">¶</a></h4>
<p>The value should be one of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">-</span> <span class="n">autocompute</span> <span class="n">an</span> <span class="n">appropriate</span> <span class="n">partitioning</span> <span class="n">strategy</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="mi">1</span> <span class="o">-</span> <span class="n">always</span> <span class="n">send</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">single</span> <span class="n">part</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">sz</span><span class="o">&gt;</span> <span class="o">-</span> <span class="n">used</span> <span class="n">a</span> <span class="n">fixed</span> <span class="n">partition</span> <span class="n">size</span> <span class="p">(</span><span class="n">example</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span><span class="n">M</span> <span class="p">)</span>
</pre></div>
</div>
<p>Files can be announced as multiple blocks (or parts). Each part has a separate checksum.
The parts and their checksums are stored in the cache. Partitions can traverse
the network separately, and in paralllel.  When files change, transfers are
optimized by only sending parts which have changed.</p>
<p>The autocomputation algorithm determines a blocksize that encourages a reasonable number of parts
for files of various sizes.  As the file size varies, the automatic computation will give different
results. This will result in resending information which has not changed as partitions of a different
size will have different sums.  Where large files are being appended to, it makes sense to specify a
fixed partition size.</p>
<p>In cases where a custom downloader is used that does not understand partitioning, it is necessary
to avoid having the file split into parts, so one would specify ‘1’ to force all files to be sent
as a single part.</p>
<p>The value of the <em>blocksize</em>  is an integer that may be followed by  letter designator <em>[B|K|M|G|T]</em> meaning:
for Bytes, Kilobytes, Megabytes, Gigabytes, Terabytes respectively.  All these references are powers of 2.</p>
</section>
<section id="e-fileevents-event-event">
<h4><a class="toc-backref" href="#id38">[-e|–fileEvents &lt;event|event|…&gt;]</a><a class="headerlink" href="#e-fileevents-event-event" title="Permalink to this headline">¶</a></h4>
<p>A list of file event types to monitor separated by a ‘pipe symbol’.
Available file events:  create, delete, link, modify</p>
<p>The <em>create</em>, <em>modify</em>, and <em>delete</em> events reflect what is expected: a file being created, modified, or deleted.
If <em>link</em> is set, symbolic links will be posted as links so that consumers can choose
how to process them. If it is not set, then no symbolic link events will ever be posted.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>move or rename events result in a special double post pattern, with one post as the old name
and a field <em>newname</em> set, and a second post with the new name, and a field <em>oldname</em> set.
This allows subscribers to perform an actual rename, and avoid triggering a download when possible.</p>
<p>FIXME: rename algorithm improved in v3 to avoid use of double post… just oldname.</p>
</div>
</section>
<section id="fp-force-polling-boolean">
<h4><a class="toc-backref" href="#id39">[-fp|–force_polling &lt;boolean&gt;]</a><a class="headerlink" href="#fp-force-polling-boolean" title="Permalink to this headline">¶</a></h4>
<p>By default, sr_watch selects an (OS dependent) optimal method to watch a
directory. For large trees, the optimal method can be manyfold (10x or even
100x) faster to recognize when a file has been modified. In some cases,
however, platform optimal methods do not work (such as with some network
shares, or distributed file systems), so one must use a slower but more
reliable and portable polling method.  The <em>force_polling</em> keyword causes
sr_watch to select the polling method in spite of the availability of a
normally better one.  KNOWN LIMITATION: When <em>force_polling</em> is set,
the <em>sleep</em> setting should be at least 5 seconds. It is not currently clear
why.</p>
<p>NOTE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">When</span> <span class="n">directories</span> <span class="n">are</span> <span class="n">consumed</span> <span class="n">by</span> <span class="n">processes</span> <span class="n">using</span> <span class="n">the</span> <span class="n">subscriber</span> <span class="o">*</span><span class="n">delete</span><span class="o">*</span> <span class="n">option</span><span class="p">,</span> <span class="n">they</span> <span class="n">stay</span> <span class="n">empty</span><span class="p">,</span> <span class="ow">and</span>
<span class="n">every</span> <span class="n">file</span> <span class="n">should</span> <span class="n">be</span> <span class="n">reported</span> <span class="n">on</span> <span class="n">every</span> <span class="k">pass</span><span class="o">.</span>  <span class="n">When</span> <span class="n">subscribers</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">use</span> <span class="o">*</span><span class="n">delete</span><span class="o">*</span><span class="p">,</span> <span class="n">sr_watch</span> <span class="n">needs</span> <span class="n">to</span>
<span class="n">know</span> <span class="n">which</span> <span class="n">files</span> <span class="n">are</span> <span class="n">new</span><span class="o">.</span>  <span class="n">It</span> <span class="n">does</span> <span class="n">so</span> <span class="n">by</span> <span class="n">noting</span> <span class="n">the</span> <span class="n">time</span> <span class="n">of</span> <span class="n">the</span> <span class="n">beginning</span> <span class="n">of</span> <span class="n">the</span> <span class="n">last</span> <span class="n">polling</span> <span class="k">pass</span><span class="o">.</span>
<span class="n">File</span> <span class="n">are</span> <span class="n">posted</span> <span class="k">if</span> <span class="n">their</span> <span class="n">modification</span> <span class="n">time</span> <span class="ow">is</span> <span class="n">newer</span> <span class="n">than</span> <span class="n">that</span><span class="o">.</span>  <span class="n">This</span> <span class="n">will</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">many</span> <span class="n">multiple</span> <span class="n">posts</span>
<span class="n">by</span> <span class="n">sr_watch</span><span class="p">,</span> <span class="n">which</span> <span class="n">can</span> <span class="n">be</span> <span class="n">minimized</span> <span class="k">with</span> <span class="n">the</span> <span class="n">use</span> <span class="n">of</span> <span class="n">cache</span><span class="o">.</span>   <span class="n">One</span> <span class="n">could</span> <span class="n">even</span> <span class="n">depend</span> <span class="n">on</span> <span class="n">the</span> <span class="n">cache</span>
<span class="n">entirely</span> <span class="ow">and</span> <span class="n">turn</span> <span class="n">on</span> <span class="n">the</span> <span class="o">*</span><span class="n">delete</span><span class="o">*</span> <span class="n">option</span><span class="p">,</span> <span class="n">which</span> <span class="n">will</span> <span class="n">have</span> <span class="n">sr_watch</span> <span class="n">attempt</span> <span class="n">to</span> <span class="n">post</span> <span class="n">the</span> <span class="n">entire</span> <span class="n">tree</span>
<span class="n">every</span> <span class="n">time</span> <span class="p">(</span><span class="n">ignoring</span> <span class="n">mtime</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
</section>
<section id="pos-post-on-start">
<h4><a class="toc-backref" href="#id40">[-pos|–post_on_start]</a><a class="headerlink" href="#pos-post-on-start" title="Permalink to this headline">¶</a></h4>
<p>When starting sr_watch, one can either have the program post all the files in the directories watched
or not.</p>
</section>
<section id="r-randomize">
<h4><a class="toc-backref" href="#id41">[-r|–randomize]</a><a class="headerlink" href="#r-randomize" title="Permalink to this headline">¶</a></h4>
<p>Active if <em>-r|–randomize</em> appears in the command line… or
<em>randomize</em> is set to True in the configuration file used.
If there are several posts because the file is posted
by block (the <em>blocksize</em> option was set), the block
posts are randomized meaning that they will not be posted
in order of block number.</p>
</section>
<section id="real-realpath-boolean">
<h4><a class="toc-backref" href="#id42">[-real|–realpath &lt;boolean&gt;]</a><a class="headerlink" href="#real-realpath-boolean" title="Permalink to this headline">¶</a></h4>
<p>The realpath option resolves paths given to their canonical ones, eliminating
any indirection via symlinks. The behaviour improves the ability of sr_watch to
monitor trees, but the trees may have completely different paths than the arguments
given. This option also enforces traversing of symbolic links.</p>
</section>
<section id="rn-rename-path">
<h4><a class="toc-backref" href="#id43">[-rn|–rename &lt;path&gt;]</a><a class="headerlink" href="#rn-rename-path" title="Permalink to this headline">¶</a></h4>
<p>With the  <em>rename</em>   option, the user can
suggest a destination path for its files. If the given
path ends with ‘/’ it suggests a directory path…
If it doesn’t, the option specifies a file renaming.</p>
</section>
<section id="rr-reconnect">
<h4><a class="toc-backref" href="#id44">[-rr|–reconnect]</a><a class="headerlink" href="#rr-reconnect" title="Permalink to this headline">¶</a></h4>
<p>Active if <em>-rc|–reconnect</em> appears in the command line… or
<em>reconnect</em> is set to True in the configuration file used.
<em>If there are several posts because the file is posted
by block because the *blocksize</em> option was set, there is a
reconnection to the broker everytime a post is to be sent.</p>
</section>
<section id="fs-follow-symlinks-boolean">
<h4><a class="toc-backref" href="#id45">[-fs|–follow_symlinks &lt;boolean&gt;]</a><a class="headerlink" href="#fs-follow-symlinks-boolean" title="Permalink to this headline">¶</a></h4>
<p>The <em>follow_symlinks</em> option causes symbolic links to be traversed.  If <em>follow_symlinks</em> is set
and the destination of a symbolic link is a file, then that destination file should be posted as well as the link.
If the destination of the symbolic link is a directory, then the directory should be added to those being
monitored by sr_watch.   If <em>follow_symlinks</em> is false, then no action related to the destination of the symbolic
link is taken.</p>
</section>
<section id="header-name-value">
<h4><a class="toc-backref" href="#id46">[-header &lt;name&gt;=&lt;value&gt;]</a><a class="headerlink" href="#header-name-value" title="Permalink to this headline">¶</a></h4>
<p>Add a &lt;name&gt; header with the given value to advertisements. Used to pass strings as metadata in the
advertisements to improve decision making for consumers.  Should be used sparingly. There are limits
on how many headers can be used, and minimizing the size of messages has important performance
impacts.</p>
</section>
<section id="id4">
<h4><a class="toc-backref" href="#id47">[-real|–realpath &lt;boolean&gt;]</a><a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>The realpath option resolves paths given to their canonical ones, eliminating
any indirection via symlinks. The behaviour improves the ability of sr_watch to
monitor trees, but the trees may have completely different paths than the arguments
given. This option also enforces traversing of symbolic links.</p>
</section>
<section id="id5">
<h4><a class="toc-backref" href="#id48">[-rn|–rename &lt;path&gt;]</a><a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>With the  <em>rename</em>   option, the user can
suggest a destination path for its files. If the given
path ends with ‘/’ it suggests a directory path…
If it doesn’t, the option specifies a file renaming.</p>
</section>
<section id="sub-subtopic-key">
<h4><a class="toc-backref" href="#id49">[-sub|–subtopic &lt;key&gt;]</a><a class="headerlink" href="#sub-subtopic-key" title="Permalink to this headline">¶</a></h4>
<p>The subtopic default can be overwritten with the  <em>subtopic</em>  option.</p>
</section>
<section id="sleep-time">
<h4><a class="toc-backref" href="#id50">[–sleep &lt;time&gt; ]</a><a class="headerlink" href="#sleep-time" title="Permalink to this headline">¶</a></h4>
<p>The time to wait between generating events.  When files are written frequently, it is counter productive
to produce a post for every change, as it can produce a continuous stream of changes where the transfers
cannot be done quickly enough to keep up.  In such circumstances, one can group all changes made to a file
in <em>sleep</em> time, and produce a single post.</p>
</section>
<section id="sum-sum-string">
<h4><a class="toc-backref" href="#id51">[-sum|–sum &lt;string&gt;]</a><a class="headerlink" href="#sum-sum-string" title="Permalink to this headline">¶</a></h4>
<p>All file posts include a checksum.  It is placed in the amqp message header will have as an
entry <em>sum</em> with default value ‘d,md5_checksum_on_data’.
The <em>sum</em> option tell the program how to calculate the checksum.
It is a comma separated string.  Valid checksum flags are</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">0</span><span class="o">|</span><span class="n">n</span><span class="o">|</span><span class="n">d</span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="n">N</span><span class="o">|</span><span class="n">z</span><span class="p">]</span>
<span class="n">where</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">no</span> <span class="n">checksum</span><span class="o">...</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">post</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">random</span> <span class="n">integer</span> <span class="p">(</span><span class="n">only</span> <span class="k">for</span> <span class="n">testing</span><span class="o">/</span><span class="n">debugging</span><span class="o">.</span><span class="p">)</span>
      <span class="n">d</span> <span class="p">:</span> <span class="n">do</span> <span class="n">md5sum</span> <span class="n">on</span> <span class="n">file</span> <span class="n">content</span> <span class="p">(</span><span class="n">default</span> <span class="k">for</span> <span class="n">now</span><span class="p">,</span> <span class="n">compatibility</span><span class="p">)</span>
      <span class="n">n</span> <span class="p">:</span> <span class="n">do</span> <span class="n">md5sum</span> <span class="n">checksum</span> <span class="n">on</span> <span class="n">filename</span>
      <span class="n">p</span> <span class="p">:</span> <span class="n">do</span> <span class="n">SHA512</span> <span class="n">checksum</span> <span class="n">on</span> <span class="n">filename</span> <span class="ow">and</span> <span class="n">partstr</span> <span class="p">[</span><span class="c1">#]_</span>
      <span class="n">s</span> <span class="p">:</span> <span class="n">do</span> <span class="n">SHA512</span> <span class="n">on</span> <span class="n">file</span> <span class="n">content</span> <span class="p">(</span><span class="n">default</span> <span class="ow">in</span> <span class="n">future</span><span class="p">)</span>
      <span class="n">z</span><span class="p">,</span><span class="n">a</span> <span class="p">:</span> <span class="n">calculate</span> <span class="n">checksum</span> <span class="n">value</span> <span class="n">using</span> <span class="n">algorithm</span> <span class="n">a</span> <span class="ow">and</span> <span class="n">assign</span> <span class="n">after</span> <span class="n">download</span><span class="o">.</span>
</pre></div>
</div>
<p>Other checksum algorithms can be added. See Programming Guide.</p>
<dl class="footnote brackets">
<dt class="label" id="id6"><span class="brackets">1</span></dt>
<dd><p>only implemented in C. ( see <a class="reference external" href="https://github.com/MetPX/sarracenia/issues/117">https://github.com/MetPX/sarracenia/issues/117</a> )</p>
</dd>
</dl>
</section>
<section id="file-detection-strategies">
<h4><a class="toc-backref" href="#id52">File Detection Strategies</a><a class="headerlink" href="#file-detection-strategies" title="Permalink to this headline">¶</a></h4>
<p>The fundamental job of sr_watch is to notice when files are available to be transferred.
The appropriate strategy varies according to:</p>
<blockquote>
<div><ul class="simple">
<li><p>the <strong>number of files in the tree</strong> to be monitored,</p></li>
<li><p>the <strong>minimum time to notice changes</strong> to files that is acceptable, and</p></li>
<li><p>the <strong>size of each file</strong> in the tree.</p></li>
</ul>
</div></blockquote>
<p><strong>The easiest tree to monitor is the smallest one.</strong> With a single directory to
watch where one is posting for an <em>sr_sarra</em> component, then use of the
<em>delete</em> option will keep the number of files in directory at any one point
small and minimize the time to notice new ones. In such optimal conditions,
noticing files in a hundredth of a second is reasonable to expect. Any method
will work well for such trees, but the sr_watch defaults (inotify) are usually
the lowest overhead.</p>
<p>sr_watch is sr_post with the added <em>sleep</em> option that will cause it to loop
over directories given as arguments.  sr_cpost is a C version that functions
identically, except it is faster and uses much less memory, at the cost of the
loss of plugin support.  With sr_watch (and sr_cpost) The default method of
noticing changes in directories uses OS specific mechanisms (on Linux: INOTIFY)
to recognize changes without having to scan the entire directory tree manually.
Once primed, file changes are noticed instantaneously, but requires an
initial walk across the tree, <em>a priming pass</em>.</p>
<p>For example, <strong>assume a server can examine 1500 files/second</strong>. If a <strong>medium
sized tree is 30,000 files, then it will take 20 seconds for a priming pass</strong>.
Using the fastest method available, one must assume that on startup for such a
directory tree it will take 20 seconds or so before it starts reliably posting
all files in the tree. After that initial scan, files are noticed with
sub-second latency.  So a <strong>sleep of 0.1 (check for file changes every tenth
of a second) is reasonable, as long as we accept the intial priming pass.</strong>
If one selects <strong>force_polling</strong> option, then that 20 second delay is incurred
for each polling pass, plus the time to perform the posting itself. <strong>For the
same tree, a *sleep* setting of 30 seconds would be the minimum to recommend.
Expect that files will be noticed about 1.5* the *sleep* settings on average.</strong>
In this example, about when they are about 45 seconds. Some will be picked up
sooner, others later. Apart from special cases where the default method misses
files, it is much slower on medium sized trees than the default and should not
be used if timeliness is a concern.</p>
<p>In supercomputing clusters, distributed files systems are used, and the OS
optimized methods for recognizing file modifications (INOTIFY on Linux) do not
cross node boundaries. To use sr_watch with the default strategy on a
directory in a compute cluster, one usually must have an sr_watch process
running on every node. If that is undesirable, then one can deploy it on a
single node with <em>force_polling</em> but the timing will be constrained by the
directory size.</p>
<p>As the tree being monitored grows in size, sr_watch’s latency on startup grows,
and if polling is used the latency to notice file modifications will grow as
well. For example, with a tree with 1 million files, one should expect, at best,
a startup latency of 11 minutes. If using polling, then a reasonable expectation
of the time it takes to notice new files would be in the 16 minute range.</p>
<p>If the performance above is not sufficient, then one needs to consider the use
of the shim library instead of sr_watch. First, install the C version of
Sarracenia, then set the environment for all processes writing files that
need to be posted to call it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">SR_POST_CONFIG</span><span class="o">=</span><span class="n">shimpost</span><span class="o">.</span><span class="n">conf</span>
<span class="n">export</span> <span class="n">LD_PRELOAD</span><span class="o">=</span><span class="s2">&quot;libsrshim.so.1&quot;</span>
</pre></div>
</div>
<p>where <em>shimpost.conf</em> is an sr_cpost configuration file in
the ~/.config/sarra/post/ directory. An sr_cpost configuration file is the same
as an sr_post one, except that plugins are not supported.  With the shim
library in place, whenever a file is written, the <em>accept/reject</em> clauses of
the shimpost.conf file are consulted, and if accepted, the file is posted just
as it would be by sr_watch.</p>
<p>So far, the discussion has been about the time to notice a file has changed.
Another consideration is the time to post files once they have been noticed.
There are tradeoffs based on the checksum algorithm chosen. The most robust
choice is the default: <em>s</em> or SHA-512. When using the <em>s</em> sum method, the
entire file will be read in order to calculate it’s checksum, which is
likely to determine the time to posting. The check sum will used by
downstream consumers to determine whether the file being announced is new,
or one that has already been seen, and is really handy.</p>
<p><strong>For smaller files, checksum calculation time is negligible, but it is
generally true that bigger files take longer to post.</strong> When <strong>using the
shim library</strong> method, the same process that wrote the file is the one
<strong>calculating the checksum</strong>, the likelihood of the file data being in a
locally accessible cache is quite high, so it <strong>is as inexpensive as
possible</strong>. It should also be noted that the sr_watch/sr_cpost <strong>directory
watching processes are single threaded, while when user jobs call sr_post, or
use the shim library, there can be as many processes posting files as there are
file writers.</strong></p>
<p>To shorten posting times, one can select <em>sum</em> algorithms that do not read
the entire file, such as <em>N</em> (SHA-512 of the file name only), but then one
loses the ability to differentiate between versions of the file.</p>
<dl class="simple">
<dt>note ::</dt><dd><p>should think about using N on the sr_watch, and having multi-instance shovels
recalculate checksums so that part becomes easily parallellizable. Should be
straightforward, but not yet explored as a result of use of shim library. FIXME.</p>
</dd>
</dl>
<p>A last consideration is that in many cases, other processes are writing files
to directories being monitored by sr_watch. Failing to properly set file
completion protocols is a common source of intermittent and difficult to
diagnose file transfer issues. For reliable file transfers, it is critical
that both the writer and sr_watch agree on how to represent a file that
isn’t complete.</p>
</section>
<section id="file-detection-strategy-table">
<h4><a class="toc-backref" href="#id53">File Detection Strategy Table</a><a class="headerlink" href="#file-detection-strategy-table" title="Permalink to this headline">¶</a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 43%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" colspan="3"><p>File Detection Strategies (Order: Fastest to Slowest )
Faster Methods Work for Larger Trees.</p></th>
</tr>
<tr class="row-even"><th class="head"><p>Method</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Application</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>Implicit
posting
using shim
library</p>
<p>(LD_PRELOAD)</p>
<p>(in C)</p>
</td>
<td><dl class="simple">
<dt>File delivery advertised by libsrshim</dt><dd><ul class="simple">
<li><p>requires C package.</p></li>
<li><p>export LD_PRELOAD=libsrshim.so.1</p></li>
<li><p>must tune rejects as everything
might be posted.</p></li>
<li><p>works on any size file tree.</p></li>
<li><p>very multi-threaded.</p></li>
<li><p>I/O by writer (better localized)</p></li>
<li><p>very multi-threaded (user processes)</p></li>
</ul>
</dd>
</dl>
</td>
<td><p>Many user jobs which cannot be
modified to post explicitly.</p>
<blockquote>
<div><ul class="simple">
<li><p>multi-million file trees.</p></li>
<li><p>most efficient.</p></li>
<li><p>more complicated to setup.</p></li>
<li><p>use where python3 not available.</p></li>
<li><p>no sr_watch needed.</p></li>
<li><p>no plugins.</p></li>
</ul>
</div></blockquote>
</td>
</tr>
<tr class="row-even"><td><p>Explicit
posting by
clients</p>
<p>C: sr_cpost
or
Python:
sr_post</p>
</td>
<td><p>File delivery advertised by
<a class="reference external" href="sr_post.1.rst">sr_post(1)</a>
or other sr_ components
after file writing complete.</p>
<blockquote>
<div><ul class="simple">
<li><p>poster builds checksums</p></li>
<li><p>fewer round trips (no renames)</p></li>
<li><p>only a little slower than shim.</p></li>
<li><p>no directory scanning.</p></li>
<li><p>many sr_posts can run at once.</p></li>
</ul>
</div></blockquote>
</td>
<td><p>User posts only when file is complete.</p>
<blockquote>
<div><ul class="simple">
<li><p>user has finest grain control.</p></li>
<li><p>usually best.</p></li>
<li><p>if available, do not use sr_watch.</p></li>
<li><p>requires explicit posting by user
scripts/jobs.</p></li>
</ul>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><p>sr_cpost</p>
<p>(in C)</p>
</td>
<td><p>works like watch if sleep &gt; 0</p>
<blockquote>
<div><ul class="simple">
<li><p>faster than sr_watch</p></li>
<li><p>uses less memory than sr_watch.</p></li>
<li><p>practical with a bit bigger trees.</p></li>
</ul>
</div></blockquote>
</td>
<td><ul class="simple">
<li><p>where python3 is hard to get.</p></li>
<li><p>where speed is critical.</p></li>
<li><p>where plugins not needed.</p></li>
<li><p>same issues with tree size
as sr_watch, just a little later.
(see following methods)</p></li>
</ul>
</td>
</tr>
<tr class="row-even"><td><p>sr_watch with
reject
: .*\.tmp$
(suffix)</p>
<blockquote>
<div><p>(default)</p>
</div></blockquote>
<p>(in Python)</p>
</td>
<td><p>Files transferred with a <em>.tmp</em> suffix.
When complete, renamed without suffix.
Actual suffix is settable.</p>
<blockquote>
<div><ul class="simple">
<li><p>requires extra round trips for
rename (a little slower)</p></li>
<li><p>Assume 1500 limited to files/second</p></li>
<li><p>Large trees mean long startup.</p></li>
<li><p>each node in a cluster may need
to run an instance</p></li>
<li><p>each sr_watch single threaded.</p></li>
</ul>
</div></blockquote>
</td>
<td><p>Receiving from most other systems
(.tmp support built-in)
Use to receive from Sundew.</p>
<p>best choice for most trees on a
single server or workstation. Full
plugin support.</p>
<p>works great with 10000 files
only a few seconds startup.</p>
<p>too slow for millions of files.</p>
</td>
</tr>
<tr class="row-odd"><td><p>sr_watch with
reject
^\..*
(Prefix)</p></td>
<td><p>Use Linux convention to <em>hide</em> files.
Prefix names with ‘.’
that need that. (compatibility)
same performance as previous method.</p></td>
<td><p>Sending to systems that
do not support suffix.</p></td>
</tr>
<tr class="row-even"><td><p>sr_watch with
inflight
number
(mtime)</p></td>
<td><p>Minimum age (modification time)
of the file before it is considered
complete.</p>
<blockquote>
<div><ul class="simple">
<li><p>Adds delay in every transfer.</p></li>
<li><p>Vulnerable to network failures.</p></li>
<li><p>Vulnerable to clock skew.</p></li>
</ul>
</div></blockquote>
</td>
<td><p>Last choice, guarantees delay only if
no other method works.</p>
<p>Receiving from uncooperative
sources.</p>
<p>(ok choice with PDS)</p>
<p>If a process is re-writing a file
often, can use mtime to smooth out
the i/o pattern, by slowing posts.</p>
</td>
</tr>
<tr class="row-odd"><td><p>force_polling
using reject
or mtime
methods above</p></td>
<td><p>As per above 3, but uses plain old
directory listings.</p>
<blockquote>
<div><ul class="simple">
<li><p>Large trees means slower to notice
new files</p></li>
<li><p>should work anywhere.</p></li>
</ul>
</div></blockquote>
</td>
<td><p>Only use when INOTIFY has some sort
of issue, such as cluster file
system in a supercomputer.</p>
<p>needed on NFS shares with multiple
writing nodes.</p>
</td>
</tr>
</tbody>
</table>
<section id="shim-library-usage">
<h5><a class="toc-backref" href="#id54">SHIM LIBRARY USAGE</a><a class="headerlink" href="#shim-library-usage" title="Permalink to this headline">¶</a></h5>
<p>Rather than invoking a sr3_post to post each file to publish, one can have processes automatically
post the files they right by having them use a shim library intercepting certain file i/o calls to libc
and the kernel. To activate the shim library, in the shell environment add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">SR_POST_CONFIG</span><span class="o">=</span><span class="n">shimpost</span><span class="o">.</span><span class="n">conf</span>
<span class="n">export</span> <span class="n">LD_PRELOAD</span><span class="o">=</span><span class="s2">&quot;libsrshim.so.1&quot;</span>
</pre></div>
</div>
<p>where <em>shimpost.conf</em> is an sr_cpost configuration file in
the ~/.config/sarra/post/ directory. An sr_cpost configuration file is the same
as an sr3_post one, except that plugins are not supported.  With the shim
library in place, whenever a file is written, the <em>accept/reject</em> clauses of
the shimpost.conf file are consulted, and if accepted, the file is posted just
as it would be by sr3_post. If using with ssh, where one wants files which are
scp’d to be posted, one needs to include the activation in the .bashrc and pass
it the configuration to use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expoert</span> <span class="n">LC_SRSHIM</span><span class="o">=</span><span class="n">shimpost</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Then in the ~/.bashrc on the server running the remote command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if [ &quot;$LC_SRSHIM&quot; ]; then
    export SR_POST_CONFIG=$LC_SRSHIM
    export LD_PRELOAD=&quot;libsrshim.so.1&quot;
fi
</pre></div>
</div>
<p>SSH will only pass environment variables that start with LC_ (locale) so to get it
passed with minimal effort, we use that prefix.</p>
</section>
</section>
<section id="shim-usage-notes">
<h4><a class="toc-backref" href="#id55">Shim Usage Notes</a><a class="headerlink" href="#shim-usage-notes" title="Permalink to this headline">¶</a></h4>
<p>This method of notification does require some user environment setup.
The user environment needs to the LD_PRELOAD environment variable set
prior to launch of the process. Complications that remain as we have
been testing for two years since the shim library was first implemented:</p>
<ul class="simple">
<li><p>if we want to notice files created by remote scp processes (which create non-login shells)
then the environment hook must be in .bashrc. and using an environment
variable that starts with <em>LC_</em> to have ssh transmit the configuration value without
having to modify sshd configuration in typical linux distributions.
( full discussion: <a class="reference external" href="https://github.com/MetPX/sarrac/issues/66">https://github.com/MetPX/sarrac/issues/66</a> )</p></li>
<li><p>code that has certain weaknesses, such as in FORTRAN a lack of IMPLICIT NONE
<a class="reference external" href="https://github.com/MetPX/sarracenia/issues/69">https://github.com/MetPX/sarracenia/issues/69</a> may crash when the shim library
is introduced. The correction needed in those cases has so far been to correct
the application, and not the library.
( also: <a class="reference external" href="https://github.com/MetPX/sarrac/issues/12">https://github.com/MetPX/sarrac/issues/12</a> )</p></li>
<li><p>codes using the <em>exec</em> call ot <a class="reference external" href="www.tcl.tk">tcl/tk</a>, by default considers any
output to file descriptor 2 (standard error) as an error condition.
these messages can be labelled as INFO, or WARNING priority, but it will
cause the tcl caller to indicate a fatal error has occurred.  Adding
<em>-ignorestderr</em>  to invocations of <em>exec</em> avoids such unwarranted aborts.</p></li>
<li><p>Complex shell scripts can experience an inordinate performance impact.
Since <em>high performance shell scripts</em> is an oxymoron, the best solution,
performance-wise is to re-write the scripts in a more efficient scripting
language such as python  ( <a class="reference external" href="https://github.com/MetPX/sarrac/issues/15">https://github.com/MetPX/sarrac/issues/15</a> )</p></li>
<li><p>Code bases that move large file hierarchies (e.g. <em>mv tree_with_thousands_of_files new_tree</em> )
will see a much higher cost for this operation, as it is implemented as
a renaming of each file in the tree, rather than a single operation on the root.
This is currently considered necessary because the accept/reject pattern matching
may result in a very different tree on the destination, rather than just the
same tree mirrored. See below for details.</p></li>
<li><p><em>export SR_SHIMDEBUG=1</em> will get your more output than you want. use with care.</p></li>
</ul>
<p><strong>Rename Processing</strong></p>
<p>It should be noted that file renaming is not as simple in the mirroring case as in the underlying
operating system. While the operation is a single atomic one in an operating system, when
using notifications, there are accept/reject cases that create four possible effects.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 37%" />
<col style="width: 34%" />
<col style="width: 29%" />
</colgroup>
<tbody>
<tr class="row-odd"><td></td>
<td colspan="2"><p>old name is:</p></td>
</tr>
<tr class="row-even"><td><p>New name is:</p></td>
<td><p><em>Accepted</em></p></td>
<td><p><em>Rejected</em></p></td>
</tr>
<tr class="row-odd"><td><p><em>Accepted</em></p></td>
<td><p>rename</p></td>
<td><p>copy</p></td>
</tr>
<tr class="row-even"><td><p><em>Rejected</em></p></td>
<td><p>remove</p></td>
<td><p>nothing</p></td>
</tr>
</tbody>
</table>
<p>When a file is moved, two notifications are created:</p>
<ul>
<li><p>One notification has the new name in the <em>relpath</em>, while containing and <em>oldname</em>
field pointing at the old name.  This will trigger activities in the top half of
the table, either a rename, using the oldname field, or a copy if it is not present</p>
<p>at the destination.</p>
</li>
<li><p>A second notification with the oldname in <em>relpath</em> which will be accepted
again, but this time it has the <em>newname</em> field, and process the remove action.</p></li>
</ul>
<p>While the renaming of a directory at the root of a large tree is a cheap atomic operation
in Linux/Unix, mirroring that operation requires creating a rename posting for each file
in the tree, and thus is far more expensive.</p>
</section>
<section id="sarra">
<h4><a class="toc-backref" href="#id56">SARRA</a><a class="headerlink" href="#sarra" title="Permalink to this headline">¶</a></h4>
<p><strong>sarra</strong> is a program that Subscribes to file notifications,
Acquires the files and ReAnnounces them at their new locations.
The notification protocol is defined here <a class="reference external" href="sr3_post.7.rst">sr3_post(7)</a></p>
<p><strong>sarra</strong> connects to a <em>broker</em> (often the same as the remote file server
itself) and subscribes to the notifications of interest. It uses the notification
information to download the file on the local server it’s running on.
It then posts a notification for the downloaded files on a broker (usually on the local server).</p>
<p><strong>sarra</strong> can be used to acquire files from <a class="reference external" href="sr3_post.1.rst">sr3_post(1)</a>
or <a class="reference internal" href="#watch">watch</a>  or to reproduce a web-accessible folders (WAF),
that announce its products.</p>
<p>The <strong>sr_sarra</strong> is an <a class="reference external" href="#subscribe">sr_subscribe(1)</a>  with the following presets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mirror</span> <span class="kc">True</span>
</pre></div>
</div>
<section id="specific-consuming-requirements">
<h5><a class="toc-backref" href="#id57">Specific consuming requirements</a><a class="headerlink" href="#specific-consuming-requirements" title="Permalink to this headline">¶</a></h5>
<p>If the messages are posted directly from a source, the exchange used is ‘xs_&lt;brokerSourceUsername&gt;’.
To protect against malicious users, administrators should set <em>source_from_exchange</em> to <strong>True</strong>.
Such messages may not contain a source nor an origin cluster fields
or a malicious user may set the values incorrectly.</p>
<ul class="simple">
<li><p><strong>source_from_exchange  &lt;boolean&gt; (default: False)</strong></p></li>
</ul>
<p>Upon reception, the program will set these values in the parent class (here
cluster is the value of option <strong>cluster</strong> taken from default.conf):</p>
<p>msg[‘source’]       = &lt;brokerUser&gt;
msg[‘from_cluster’] = cluster</p>
<p>overriding any values present in the message. This setting
should always be used when ingesting data from a
user exchange.</p>
</section>
</section>
<section id="sender">
<h4><a class="toc-backref" href="#id58">SENDER</a><a class="headerlink" href="#sender" title="Permalink to this headline">¶</a></h4>
<p><strong>sender</strong> is a component derived from <a class="reference internal" href="#subscribe">subscribe</a>
used to send local files to a remote server using a file transfer protocol, primarily SFTP.
<strong>sender</strong> is a standard consumer, using all the normal AMQP settings for brokers, exchanges,
queues, and all the standard client side filtering with accept, reject, and after_accept.</p>
<p>Often, a broker will announce files using a remote protocol such as HTTP,
but for the sender it is actually a local file.  In such cases, one will
see a message: <strong>ERROR: The file to send is not local.</strong>
An after_accept plugin will convert the web url into a local file one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">baseDir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">httpd</span><span class="o">/</span><span class="n">www</span>
<span class="n">flowcb</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">tolocalfile</span><span class="o">.</span><span class="n">ToLocalFile</span>
</pre></div>
</div>
<p>This after_accept plugin is part of the default settings for senders, but one
still needs to specify baseDir for it to function.</p>
<p>If a <strong>post_broker</strong> is set, <strong>sender</strong> checks if the clustername given
by the <strong>to</strong> option if found in one of the message’s destination clusters.
If not, the message is skipped.</p>
<section id="destination-unavailable">
<h5><a class="toc-backref" href="#id59">DESTINATION UNAVAILABLE</a><a class="headerlink" href="#destination-unavailable" title="Permalink to this headline">¶</a></h5>
<p>If the server to which the files are being sent is going to be unavailable for
a prolonged period, and there is a large number of messages to send to it, then
the queue will build up on the broker. As the performance of the entire broker
is affected by large queues, one needs to minimize such queues.</p>
<p>The <em>-save</em> and <em>-restore</em> options are used get the messages away from the broker
when a very large a queue will certainly build up.
The <em>-save</em> option copies the messages to a (per instance) disk file (in the same directory
that stores state and pid files), as json encoded strings, one per line.
When a queue is building up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3</span> <span class="n">stop</span> <span class="n">sender</span><span class="o">/&lt;</span><span class="n">config</span><span class="o">&gt;</span>
<span class="n">sr3</span> <span class="o">-</span><span class="n">save</span> <span class="n">start</span> <span class="n">sender</span><span class="o">/&lt;</span><span class="n">config</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>And run the sender in <em>save</em> mode (which continually writes incoming messages to disk)
in the log, a line for each message written to disk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">51</span><span class="p">,</span><span class="mi">386</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_sender</span> <span class="n">saving</span> <span class="mi">2</span> <span class="n">message</span>
     <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">peter</span><span class="o">.</span><span class="n">sarra_devdocroot</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">SASP34_LEMM_031630__LEDA_60215</span>
</pre></div>
</div>
<p>Continue in this mode until the absent server is again available.  At that point:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3</span> <span class="n">stop</span> <span class="n">sender</span><span class="o">/&lt;</span><span class="n">config</span><span class="o">&gt;</span>
<span class="n">sr3</span> <span class="o">-</span><span class="n">restore</span> <span class="n">start</span> <span class="n">sender</span><span class="o">/&lt;</span><span class="n">config</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>While restoring from the disk file, messages like the following will appear in the log:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">02</span><span class="p">,</span><span class="mi">969</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_sender</span> <span class="n">restoring</span> <span class="n">message</span> <span class="mi">29</span> <span class="n">of</span> <span class="mi">34</span><span class="p">:</span>
  <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">peter</span><span class="o">.</span><span class="n">sarra_devdocroot</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">ON_02GD022_daily_hydrometric</span><span class="o">.</span><span class="n">csv</span>
</pre></div>
</div>
<p>After the last one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">03</span><span class="p">,</span><span class="mi">112</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_sender</span> <span class="n">restore</span> <span class="n">complete</span> <span class="n">deleting</span> <span class="n">save</span>
  <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">peter</span><span class="o">/.</span><span class="n">cache</span><span class="o">/</span><span class="n">sarra</span><span class="o">/</span><span class="n">sender</span><span class="o">/</span><span class="n">tsource2send</span><span class="o">/</span><span class="n">sr_sender_tsource2send_0000</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
<p>and the sr_sender will function normally thereafter.</p>
</section>
<section id="setup-1-pump-to-pump-replication">
<h5><a class="toc-backref" href="#id60">SETUP 1 : PUMP TO PUMP REPLICATION</a><a class="headerlink" href="#setup-1-pump-to-pump-replication" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><ul class="simple">
<li><p><strong>mirror             &lt;boolean&gt;   (default: True)</strong></p></li>
<li><p><strong>baseDir      &lt;directory&gt; (None)</strong></p></li>
<li><p><strong>destination        &lt;url&gt;       (MANDATORY)</strong></p></li>
<li><p><strong>do_send            &lt;script&gt;    (None)</strong></p></li>
<li><p><strong>kbytes_ps          &lt;int&gt;       (default: 0)</strong></p></li>
<li><p><strong>post_baseDir &lt;directory&gt; (default: ‘’)</strong></p></li>
<li><p><strong>to               &lt;clustername&gt; (default: &lt;post_broker host&gt;)</strong></p></li>
<li><p><strong>on_post           &lt;script&gt;     (default: None)</strong></p></li>
<li><p><strong>post_broker        amqp{s}://&lt;user&gt;:&lt;pw&gt;&#64;&lt;brokerhost&gt;[:port]/&lt;vhost&gt;</strong></p></li>
<li><p><strong>url                &lt;url&gt;       (default: destination)</strong></p></li>
</ul>
</div></blockquote>
<p>For pump replication, <strong>mirror</strong> is set to True (default).</p>
<p><strong>baseDir</strong> supplies the directory path that, when combined with the relative
one in the selected notification gives the absolute path of the file to be sent.
The default is None which means that the path in the notification is the absolute one.</p>
<p>In a subscriber, the baseDir represents the prefix to the relative path on the upstream
server, and is used as a pattern to be replaced in the currently selected base directory
(from a <em>baseDir</em> or <em>directory</em> option) in the message fields: ‘link’, ‘oldname’, ‘newname’
which are used when mirroring symbolic links, or files that are renamed.</p>
<p>The <strong>destination</strong> defines the protocol and server to be used to deliver the products.
Its form is a partial url, for example:  <strong>ftp://myuser&#64;myhost</strong>
The program uses the file ~/.conf/sarra/credentials.conf to get the remaining details
(password and connection options).  Supported protocol are ftp, ftps and sftp. Should the
user need to implement another sending mechanism, he would provide the plugin script
through option <strong>do_send</strong>.</p>
<p>On the remote site, the <strong>post_baseDir</strong> serves the same purpose as the
<strong>baseDir</strong> on this server.  The default is None which means that the delivered path
is the absolute one.</p>
<p>Now we are ready to send the product… for example, if the selected notification looks like this :</p>
<p><strong>20150813161959.854 http://this.pump.com/ relative/path/to/IMPORTANT_product</strong></p>
<p><strong>sr_sender</strong>  performs the following pseudo-delivery:</p>
<p>Sends local file [<strong>baseDir</strong>]/relative/path/to/IMPORTANT_product
to    <strong>destination</strong>/[<strong>post_baseDir</strong>]/relative/path/to/IMPORTANT_product
(<strong>kbytes_ps</strong> is greater than 0, the process attempts to respect
this delivery speed… ftp,ftps,or sftp)</p>
<p>At this point, a pump-to-pump setup needs to send the remote notification…
(If the post_broker is not set, there will be no posting… just products replication)</p>
<p>The selected notification contains all the right information
(topic and header attributes) except for url field in the
notice… in our example :  <strong>http://this.pump.com/</strong></p>
<p>By default, <strong>sr_sender</strong> puts the <strong>destination</strong> in that field.
The user can overwrite this by specifying the option <strong>post_baseUrl</strong>. For example:</p>
<p><strong>post_baseUrl http://remote.apache.com</strong></p>
<p>The user can provide an <strong>on_post</strong> script. Just before the message is
published on the <strong>post_broker</strong>  and <strong>post_exchange</strong>, the
<strong>on_post</strong> script is called… with the <strong>sr_sender</strong> class instance as an argument.
The script can perform whatever you want… if it returns False, the message will not
be published. If True, the program will continue processing from there.</p>
</section>
<section id="destination-setup-2-metpx-sundew-like-dissemination">
<h5><a class="toc-backref" href="#id61">DESTINATION SETUP 2 : METPX-SUNDEW LIKE DISSEMINATION</a><a class="headerlink" href="#destination-setup-2-metpx-sundew-like-dissemination" title="Permalink to this headline">¶</a></h5>
<p>In this type of usage, we would not usually repost… but if the
<strong>post_broker</strong> and <strong>post_exchange</strong> (<strong>url</strong>,**on_post**) are set,
the product will be announced (with its possibly new location and new name).
Let’s reintroduce the options in a different order
with some new ones to ease explanation.</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>mirror             &lt;boolean&gt;   (default: True)</strong></p></li>
<li><p><strong>baseDir      &lt;directory&gt; (None)</strong></p></li>
<li><p><strong>destination        &lt;url&gt;       (MANDATORY)</strong></p></li>
<li><p><strong>post_baseDir &lt;directory&gt; (default: ‘’)</strong></p></li>
<li><p><strong>directory          &lt;path&gt;      (MANDATORY)</strong></p></li>
<li><p><strong>after_accept      &lt;script&gt; (default: None)</strong></p></li>
<li><p><strong>accept        &lt;regexp pattern&gt; (default: None)</strong></p></li>
<li><p><strong>reject        &lt;regexp pattern&gt; (default: None)</strong></p></li>
</ul>
</div></blockquote>
<p>There are 2 differences with the previous case :
the <strong>directory</strong>, and the <strong>filename</strong> options.</p>
<p>The <strong>baseDir</strong> is the same, and so are the
<strong>destination</strong>  and the <strong>post_baseDir</strong> options.</p>
<p>The <strong>directory</strong> option defines another “relative path” for the product
at its destination.  It is tagged to the <strong>accept</strong> options defined after it.
If another sequence of <strong>directory</strong>/<strong>accept</strong> follows in the configuration file,
the second directory is tagged to the following accepts and so on.</p>
<p>The  <strong>accept/reject</strong>  patterns apply to message notice url as above.
Here is an example, here some ordered configuration options :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">directory</span> <span class="o">/</span><span class="n">my</span><span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">important_location</span>

<span class="n">accept</span> <span class="o">.*</span><span class="n">IMPORTANT</span><span class="o">.*</span>

<span class="n">directory</span> <span class="o">/</span><span class="n">my</span><span class="o">/</span><span class="n">new</span><span class="o">/</span><span class="n">location</span><span class="o">/</span><span class="n">for_others</span>

<span class="n">accept</span> <span class="o">.*</span>
</pre></div>
</div>
<p>If the notification selected is, as above, this :</p>
<p><strong>20150813161959.854 http://this.pump.com/ relative/path/to/IMPORTANT_product</strong></p>
<p>It was selected by the first <strong>accept</strong> option. The remote relative path becomes
<strong>/my/new/important_location</strong> … and <strong>sr_sender</strong>  performs the following pseudo-delivery:</p>
<p>sends local file [<strong>baseDir</strong>]/relative/path/to/IMPORTANT_product
to    <strong>destination</strong>/[<strong>post_baseDir</strong>]/my/new/important_location/IMPORTANT_product</p>
<p>Usually this way of using <strong>sr_sender</strong> would not require posting of the product.
But if <strong>post_broker</strong> and <strong>post_exchange</strong> are provided, and <strong>url</strong> , as above, is set to
<strong>http://remote.apache.com</strong>,  then <strong>sr_sender</strong> would reconstruct :</p>
<p>Topic: <strong>v03.my.new.important_location.IMPORTANT_product</strong></p>
<p>Notice: <strong>20150813161959.854 http://remote.apache.com/ my/new/important_location/IMPORTANT_product</strong></p>
</section>
</section>
<section id="shovel">
<h4><a class="toc-backref" href="#id62">shovel</a><a class="headerlink" href="#shovel" title="Permalink to this headline">¶</a></h4>
<p>shovel copies messages on one broker (given by the <em>broker</em> option) to
another (given by the <em>post_broker</em> option.) subject to filtering
by (<em>exchange</em>, <em>subtopic</em>, and optionally, <em>accept</em>/<em>reject</em>.)</p>
<p>The <em>topicPrefix</em> option must to be set to:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>v03</strong> to shovel <a class="reference external" href="sr3_postv2.7.rst">sr3_postv2(7)</a> messages</p></li>
</ul>
</div></blockquote>
<p>shovel is a flow with the following presets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">no</span><span class="o">-</span><span class="n">download</span> <span class="kc">True</span>
<span class="n">suppress_duplicates</span> <span class="n">off</span>
</pre></div>
</div>
</section>
<section id="subscribe">
<h4><a class="toc-backref" href="#id63">subscribe</a><a class="headerlink" href="#subscribe" title="Permalink to this headline">¶</a></h4>
<p>Subscribe is the normal downloading flow component, that will connect to a broker, download
the configured files, and then forward the messages with an altered baseUrl.</p>
</section>
<section id="watch">
<h4><a class="toc-backref" href="#id64">watch</a><a class="headerlink" href="#watch" title="Permalink to this headline">¶</a></h4>
<p>Watches a directory and publishes posts when files in the directory change
( added, modified, or deleted). Its arguments are very similar to  <a class="reference external" href="sr3_post.1.rst">sr3_post</a>.
In the MetPX-Sarracenia suite, the main goal is to post the availability and readiness
of one’s files. Subscribers use  <em>sr_subscribe</em>  to consume the post and download the files.</p>
<p>Posts are sent to an AMQP server, also called a broker, specified with the option [ <em>-pb|–post_broker broker_url</em> ].</p>
<p>The [<em>-post_baseUrl|–pbu|–url url</em>] option specifies the protocol, credentials, host and port to which subscribers
will connect to get the file.</p>
<p>Format of argument to the <em>url</em> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ftp</span><span class="o">|</span><span class="n">http</span><span class="o">|</span><span class="n">sftp</span><span class="p">]:</span><span class="o">//</span><span class="p">[</span><span class="n">user</span><span class="p">[:</span><span class="n">password</span><span class="p">]</span><span class="o">@</span><span class="p">]</span><span class="n">host</span><span class="p">[:</span><span class="n">port</span><span class="p">]</span><span class="o">/</span>
<span class="ow">or</span>
<span class="p">[</span><span class="n">ftp</span><span class="o">|</span><span class="n">http</span><span class="o">|</span><span class="n">sftp</span><span class="p">]:</span><span class="o">//</span><span class="p">[</span><span class="n">user</span><span class="p">[:</span><span class="n">password</span><span class="p">]</span><span class="o">@</span><span class="p">]</span><span class="n">host</span><span class="p">[:</span><span class="n">port</span><span class="p">]</span><span class="o">/</span>
<span class="ow">or</span>
<span class="n">file</span><span class="p">:</span>
</pre></div>
</div>
<p>The [<em>-p|–path path</em>] option tells <em>sr_watch</em> what to look for.
If the <em>path</em> specifies a directory, <em>sr_watches</em> creates a post for any time
a file in that directory is created, modified or deleted.
If the <em>path</em> specifies a file,  <em>sr_watch</em>  watches only that file.
In the announcement, it is specified with the <em>path</em> of the product.
There is usually one post per file.</p>
<p>FIXME: in version 3 does it work at all without a configuration.
An example of an execution of  <em>sr_watch</em>  checking a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3_watch</span> <span class="o">-</span><span class="n">s</span> <span class="n">sftp</span><span class="p">:</span><span class="o">//</span><span class="n">stanley</span><span class="nd">@mysftpserver</span><span class="o">.</span><span class="n">com</span><span class="o">/</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">shared</span><span class="o">/</span><span class="n">products</span><span class="o">/</span><span class="n">foo</span> <span class="o">-</span><span class="n">pb</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">broker</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">action</span> <span class="n">start</span>
</pre></div>
</div>
<p>Here,  <em>sr_watch</em>  checks events on the file /data/shared/products/foo.
Default events settings reports if the file is modified or deleted.
When the file gets modified,  <em>sr_watch</em>  reads the file /data/shared/products/foo
and calculates its checksum.  It then builds a post message, logs into broker.com as user ‘guest’ (default credentials)
and sends the post to defaults vhost ‘/’ and post_exchange ‘xs_stanley’ (default exchange)</p>
<p>A subscriber can download the file /data/shared/products/foo  by logging as user stanley
on mysftpserver.com using the sftp protocol to  broker.com assuming he has proper credentials.</p>
<p>The output of the command is as follows</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">v03</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">products</span><span class="o">.</span><span class="n">foo</span> <span class="s1">&#39;20150813161959.854 sftp://stanley@mysftpserver.com/ /data/shared/products/foo&#39;</span>
      <span class="n">source</span><span class="o">=</span><span class="n">guest</span> <span class="n">parts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="nb">sum</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="n">fc473c7a2801babbd3818260f50859de</span>
</pre></div>
</div>
<p>In MetPX-Sarracenia, each post is published under a certain topic.
After the ‘[INFO]’ the next information gives the fBtopic*  of the
post. Topics in  <em>AMQP</em>  are fields separated by dot. In MetPX-Sarracenia
it is made of a  <em>topicPrefix</em>  by default : version  <em>v03</em> ,
followed by the  <em>subtopic</em>  by default : the file path separated with dots, here, <em>data.shared.products.foo</em></p>
<p>After the topic hierarchy comes the body of the notification.  It consists of a time  <em>20150813161959.854</em> ,
and the source url of the file in the last 2 fields.</p>
<p>The remaining line gives informations that are placed in the amqp message header.
Here it consists of  <em>source=guest</em> , which is the amqp user,  <em>parts=1,256,0,0,1</em> ,
which suggests to download the file in 1 part of 256 bytes (the actual filesize), trailing 1,0,0
gives the number of block, the remaining in bytes and the current
block.  <em>sum=d,fc473c7a2801babbd3818260f50859de</em>  mentions checksum information,</p>
<p>here,  <em>d</em>  means md5 checksum performed on the data, and  <em>fc473c7a2801babbd3818260f50859de</em>
is the checksum value.  When the event on a file is a deletion, sum=R,0  R stands for remove.</p>
<p>Another example watching a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3_watch</span> <span class="o">-</span><span class="n">dr</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">public_data</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span> <span class="o">-</span><span class="n">p</span> <span class="n">bulletins</span><span class="o">/</span><span class="n">alphanumeric</span><span class="o">/</span><span class="n">SACN32_CWAO_123456</span> <span class="o">-</span><span class="n">pb</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">broker</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="n">action</span> <span class="n">start</span>
</pre></div>
</div>
<p>By default, sr_watch checks the file /data/web/public_data/bulletins/alphanumeric/SACN32_CWAO_123456
(concatenating the baseDir and relative path of the source url to obtain the local file path).
If the file changes, it calculates its checksum. It then builds a post message, logs into broker.com as user ‘guest’
(default credentials) and sends the post to defaults vhost ‘/’ and post_exchange ‘sx_guest’ (default post_exchange)</p>
<p>A subscriber can download the file <a class="reference external" href="http://dd.weather.gc.ca/bulletins/alphanumeric/SACN32_CWAO_123456">http://dd.weather.gc.ca/bulletins/alphanumeric/SACN32_CWAO_123456</a> using http
without authentication on dd.weather.gc.ca.</p>
<p>An example checking a directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3_watch</span> <span class="o">-</span><span class="n">dr</span> <span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">web</span><span class="o">/</span><span class="n">public_data</span> <span class="o">-</span><span class="n">pbu</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span> <span class="o">-</span><span class="n">p</span> <span class="n">bulletins</span><span class="o">/</span><span class="n">alphanumeric</span> <span class="o">-</span><span class="n">pb</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">broker</span><span class="o">.</span><span class="n">com</span> <span class="o">-</span><span class="n">action</span> <span class="n">start</span>
</pre></div>
</div>
<p>Here, sr_watch checks for file creation(modification) in /data/web/public_data/bulletins/alphanumeric
(concatenating the baseDir and relative path of the source url to obtain the directory path).
If the file SACN32_CWAO_123456 is being created in that directory, sr_watch calculates its checksum.
It then builds a post message, logs into broker.com as user ‘guest’</p>
<p>A subscriber can download the created/modified file <a class="reference external" href="http://dd.weather.gc.ca/bulletins/alphanumeric/SACN32_CWAO_123456">http://dd.weather.gc.ca/bulletins/alphanumeric/SACN32_CWAO_123456</a> using http
without authentication on dd.weather.gc.ca.</p>
</section>
<section id="winnow">
<h4><a class="toc-backref" href="#id65">winnow</a><a class="headerlink" href="#winnow" title="Permalink to this headline">¶</a></h4>
<p>the <strong>winnow</strong> component subscribes to file notifications and reposts them, suppressing redundant
ones by comparing their fingerprints (or checksums).  The <strong>Integrity</strong> header stores a file’s
fingerprint as described in the <a class="reference external" href="sr3_post.7.rst">sr3_post(7)</a> man page.</p>
<p><strong>winnow</strong> has the following options forced:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">no</span><span class="o">-</span><span class="n">download</span> <span class="kc">True</span>
<span class="n">suppress_duplicates</span> <span class="n">on</span>
<span class="n">accept_unmatch</span> <span class="kc">True</span>
</pre></div>
</div>
<p>The suppress_duplicates lifetime can be adjusted, but it is always on.</p>
<p><strong>winnow</strong> connects to a <em>broker</em> (often the same as the posting broker)
and subscribes to the notifications of interest. On reception of a notification,
it looks up its <strong>sum</strong> in its cache.  If it is found, the file has already come through,
so the notification is ignored. If not, then the file is new, and the <strong>sum</strong> is added
to the cache and the notification is posted.</p>
<p><strong>winnow</strong> can be used to trim messages produced by  post, <a class="reference external" href="sr3_post.1.rst">sr3_post</a>, sr3_cpost, <a class="reference internal" href="#poll">poll</a> or <a class="reference internal" href="#watch">watch</a> etc… It is
used when there are multiple sources of the same data, so that clients only download the
source data once, from the first source that posted it.</p>
</section>
</section>
<section id="id11">
<h3><a class="toc-backref" href="#id66">DESCRIPTION</a><a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h3>
<section id="documentation">
<h4><a class="toc-backref" href="#id67">Documentation</a><a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h4>
<p>While manual pages provide an index or reference for all options,
new users will find the guides provide more helpful examples and walk
throughs and should start with them.</p>
<p>Users:</p>
<ul class="simple">
<li><p><a class="reference external" href="../Tutorials/Install.rst">Installation</a> - initial installation.</p></li>
<li><p><a class="reference external" href="../How2Guides/subscriber.rst">Subscriber Guide</a> - effective downloading from a pump (mostly on Linux)</p></li>
<li><p><a class="reference external" href="../Tutorials/Windows.rst">Windows User Guide</a> - Windows specific variations.</p></li>
<li><p><a class="reference external" href="../How2Guides/source.rst">Source Guide</a> - effective uploading to a pump</p></li>
<li><p><a class="reference external" href="../Explanation/SarraPluginDev.rst">Programming Guide</a> - Programming custom plugins for workflow integration.</p></li>
</ul>
<p>Administrators:</p>
<ul class="simple">
<li><p><a class="reference external" href="../How2Guides/Admin.rst">Admin Guide</a> - Configuration of Pumps</p></li>
<li><p><a class="reference external" href="../How2Guides/UPGRADING.rst">Upgrade Guide</a> - MUST READ when upgrading pumps.</p></li>
</ul>
<p>Contributors:</p>
<ul class="simple">
<li><p><a class="reference external" href="../Contribution/Development.rst">Developer Guide</a> - contributing to sarracenia development.</p></li>
</ul>
<p>Meta:</p>
<ul class="simple">
<li><p><a class="reference external" href="../Explanation/sarra.rst">Overview</a> - Introduction.</p></li>
<li><p><a class="reference external" href="../Explanation/Concepts.rst">Concepts</a> - Concepts and Glossary</p></li>
</ul>
<p>There are also other manual pages available here: <a class="reference internal" href="#see-also">See Also</a></p>
<p>Some quick hints are also available when the command line is invoked with
either the <em>help</em> action, or <em>-help</em> op <strong>help</strong> to have a component print
a list of valid options.</p>
</section>
<section id="configurations">
<h4><a class="toc-backref" href="#id68">Configurations</a><a class="headerlink" href="#configurations" title="Permalink to this headline">¶</a></h4>
<p>If one has a ready made configuration called <em>q_f71.conf</em>, it can be
added to the list of known ones with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr_subscribe</span> <span class="n">add</span> <span class="n">q_f71</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>In this case, xvan_f14 is included with examples provided, so <em>add</em> finds it in the examples
directory and copies into the active configuration one.
Each configuration file manages the consumers for a single queue on
the broker. To view the available configurations, use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr_subscribe list

  configuration examples: ( /usr/lib/python3/dist-packages/sarra/examples/subscribe )
            all.conf     all_but_cap.conf            amis.conf            aqhi.conf             cap.conf      cclean_f91.conf
      cdnld_f21.conf       cfile_f44.conf        citypage.conf       clean_f90.conf            cmml.conf cscn22_bulletins.conf
        ftp_f70.conf            gdps.conf         ninjo-a.conf           q_f71.conf           radar.conf            rdps.conf
           swob.conf           t_f30.conf      u_sftp_f60.conf

  user plugins: ( /home/peter/.config/sarra/plugins )
        destfn_am.py         destfn_nz.py       msg_tarpush.py

  general: ( /home/peter/.config/sarra )
          admin.conf     credentials.conf         default.conf

  user configurations: ( /home/peter/.config/sarra/subscribe )
     cclean_f91.conf       cdnld_f21.conf       cfile_f44.conf       clean_f90.conf         ftp_f70.conf           q_f71.conf
          t_f30.conf      u_sftp_f60.conf
</pre></div>
</div>
<p>one can then modify it using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr_subscribe edit q_f71.conf
</pre></div>
</div>
<p>(The edit command uses the EDITOR environment variable, if present.)
Once satisfied, one can start the the configuration running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr_subscibe foreground q_f71.conf
</pre></div>
</div>
<p>What goes into the files? See next section:</p>
</section>
<section id="option-syntax">
<h4><a class="toc-backref" href="#id69">Option Syntax</a><a class="headerlink" href="#option-syntax" title="Permalink to this headline">¶</a></h4>
<p>Options are placed in configuration files, one per line, in the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">option</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">debug</span> <span class="n">true</span>
<span class="n">debug</span>
</pre></div>
</div>
<p>sets the <em>debug</em> option to enable more verbose logging.  If no value is specified,
the value true is implicit, so the above are equivalent.  A second example
configuration line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">broker</span> <span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">anonymous</span><span class="nd">@dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span>
</pre></div>
</div>
<p>In the above example, <em>broker</em> is the option keyword, and the rest of the line is the
value assigned to the setting. Configuration files are a sequence of settings, one per line.
Note:</p>
<ul class="simple">
<li><p>the files are read from top to bottom, most importantly for <em>directory</em>, <em>strip</em>, <em>mirror</em>,
and <em>flatten</em> options apply to <em>accept</em> clauses that occur after them in the file.</p></li>
<li><p>The forward slash (/) as the path separator in Sarracenia configuration files on all
operating systems. Use of the backslash character as a path separator (as used in the
cmd shell on Windows) may not work properly. When files are read on Windows, the path
separator is immediately converted to the forward slash, so all pattern matching,
in accept, reject, strip etc… directives should use forward slashes when a path
separator is needed.</p></li>
</ul>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">directory</span> <span class="n">A</span>
<span class="n">accept</span> <span class="n">X</span>
</pre></div>
</div>
<p>Places files matching X in directory A.</p>
<dl class="simple">
<dt>vs::</dt><dd><p>accept X
directory A</p>
</dd>
</dl>
<p>Places files matching X in the current working directory, and the <em>directory A</em> setting
does nothing in relation to X.</p>
<p>To provide non-functional descriptions of configurations, or comments, use lines that begin with a <strong>#</strong>.</p>
<p><strong>All options are case sensitive.</strong>  <strong>Debug</strong> is not the same as <strong>debug</strong> nor <strong>DEBUG</strong>.
Those are three different options (two of which do not exist and will have no effect,
but should generate an ´unknown option warning´).</p>
<p>Options and command line arguments are equivalent.  Every command line argument
has a corresponding long version starting with ‘–’.  For example <em>-u</em> has the
long form <em>–url</em>. One can also specify this option in a configuration file.
To do so, use the long form without the ‘–’, and put its value separated by a space.
The following are all equivalent:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>url &lt;url&gt;</strong></p></li>
<li><p><strong>-u &lt;url&gt;</strong></p></li>
<li><p><strong>–url &lt;url&gt;</strong></p></li>
</ul>
</div></blockquote>
<p>Settings are interpreted in order.  Each file is read from top to bottom.
For example:</p>
<p>sequence #1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reject</span> <span class="o">.*</span>\<span class="o">.</span><span class="n">gif</span>
<span class="n">accept</span> <span class="o">.*</span>
</pre></div>
</div>
<p>sequence #2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">accept</span> <span class="o">.*</span>
<span class="n">reject</span> <span class="o">.*</span>\<span class="o">.</span><span class="n">gif</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>FIXME: does this match only files ending in ‘gif’ or should we add a $ to it?
will it match something like .gif2 ? is there an assumed .* at the end?</p>
</div>
<p>In sequence #1, all files ending in ‘gif’ are rejected. In sequence #2, the
accept .* (which accepts everything) is encountered before the reject statement,
so the reject has no effect.  Some options have global scope, rather than being
interpreted in order.  for thoses cases, a second declaration overrides the first.</p>
<p>Options to be reused in different config files can be grouped in an <em>include</em> file:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>–include &lt;includeConfigPath&gt;</strong></p></li>
</ul>
</div></blockquote>
<p>The includeConfigPath would normally reside under the same config dir of its
master configs. If a URL is supplied as an includeConfigPATH, then a remote
configuraiton will be downloaded and cached (used until an update on the server
is detected.) See <a class="reference internal" href="#remote-configurations">Remote Configurations</a> for details.</p>
<p>Environment variables, and some built-in variables can also be put on the
right hand side to be evaluated, surrounded by ${..} The built-in variables are:</p>
<blockquote>
<div><ul class="simple">
<li><p>${BROKER_USER} - the user name for authenticating to the broker (e.g. anonymous)</p></li>
<li><p>${PROGRAM}     - the name of the component (sr_subscribe, sr_shovel, etc…)</p></li>
<li><p>${CONFIG}      - the name of the configuration file being run.</p></li>
<li><p>${HOSTNAME}    - the hostname running the client.</p></li>
<li><p>${RANDID}      - a random id that will be consistent within a single invocation.</p></li>
</ul>
</div></blockquote>
<section id="option-order">
<h5><a class="toc-backref" href="#id70">Option Order</a><a class="headerlink" href="#option-order" title="Permalink to this headline">¶</a></h5>
<p>When a component is started up, a series of configuration files are read in
the following sequence:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>default.conf</p></li>
<li><p>admin.conf</p></li>
<li><p>&lt;prog&gt;.conf (subscribe.conf, audit.conf, etc…)</p></li>
<li><p>&lt;progr&gt;/&lt;config&gt;.conf</p></li>
</ol>
</div></blockquote>
<p>Settings in an individual .conf file are read in after the default.conf
file, and so can override defaults. Options specified on
the command line override configuration files.</p>
</section>
<section id="flowcallback-options">
<h5><a class="toc-backref" href="#id71">flowCallback options</a><a class="headerlink" href="#flowcallback-options" title="Permalink to this headline">¶</a></h5>
<p>Sarracenia makes extensive use of small python code snippets that customize
processing called <em>flowCallback</em> Flow_callbacks define and use additional settings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flowCallback</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Log</span>
</pre></div>
</div>
<p>There is also a shorter form to express the same thing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">callback</span> <span class="n">log</span>
</pre></div>
</div>
<p>Either way, the module refers to the sarracenia/flowcb/msg/log.py file in the
installed package. In that file, the Log class is the one searched for entry
points. The log.py file included in the package is like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sarracenia.flowcb</span> <span class="kn">import</span> <span class="n">FlowCB</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span> <span class="vm">__name__</span> <span class="p">)</span>

<span class="k">class</span> <span class="nc">Log</span><span class="p">(</span><span class="n">Plugin</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">after_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">worklist</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s2">&quot;msg/log received: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">msg</span> <span class="p">)</span>
      <span class="k">return</span> <span class="n">worklist</span>
</pre></div>
</div>
<p>It’s a normal python class, declared as a child of the sarracenia.flowcb.FlowCB
class. The methods (function names) in the plugin describe when
those routines will be called. For more details consult the
<a class="reference external" href="../Explanation/SarraPluginDev.rst">Programmer’s Guide</a></p>
<p>To add special processing of messages, create a module in the python
path, and have it include entry points.</p>
<p>There is also <em>flowCallbackPrepend</em> which adds a flowCallback class to the front
of the list (which determines relative execution order among flowCallback classes.)</p>
</section>
<section id="callback-options">
<h5><a class="toc-backref" href="#id72">callback options</a><a class="headerlink" href="#callback-options" title="Permalink to this headline">¶</a></h5>
<p>callbacks that are delivered with metpx-sr3 follow the following convention:</p>
<ul class="simple">
<li><p>they are placed in the sarracenia/flowcb  directory tree.</p></li>
<li><p>the name of the primary class is the same as the name of file containing it.</p></li>
</ul>
<p>so we provide the following syntactic sugar:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">callback</span> <span class="n">log</span>    <span class="p">(</span><span class="ow">is</span> <span class="n">equivalent</span> <span class="n">to</span> <span class="o">*</span><span class="n">flowCallback</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Log</span><span class="o">*</span> <span class="p">)</span>
</pre></div>
</div>
<p>There is similarly a <em>callback_prepend</em> to fill in.</p>
</section>
<section id="importing-extensions">
<h5><a class="toc-backref" href="#id73">Importing Extensions</a><a class="headerlink" href="#importing-extensions" title="Permalink to this headline">¶</a></h5>
<p>The <em>import</em> option works in a way familiar to Python developers,
Making them available for use by the Sarracenia core, or flowCallback.
Developers can add additional protocols for messages or
file transfer.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torr</span>
</pre></div>
</div>
<p>would be a reasonable name for a Transfer protocol to retrieve
resources with bittorrent protocol. A skeleton of such a thing
would look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">sarracenia.transfer</span>

<span class="k">class</span> <span class="nc">torr</span><span class="p">(</span><span class="n">sarracenia</span><span class="o">.</span><span class="n">transfer</span><span class="o">.</span><span class="n">Transfer</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;loading&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>For more details on implementing extensions, consult the
<a class="reference external" href="../Explanation/SarraPluginDev.rst">Programmer’s Guide</a></p>
</section>
<section id="deprecated-v2-plugins">
<h5><a class="toc-backref" href="#id74">Deprecated v2 plugins</a><a class="headerlink" href="#deprecated-v2-plugins" title="Permalink to this headline">¶</a></h5>
<p>There is and older (v2) style of plugins as well. That are usually
prefixed with the name of the plugin:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">msg_to_clusters</span> <span class="n">DDI</span>
<span class="n">msg_to_clusters</span> <span class="n">DD</span>

<span class="n">on_message</span> <span class="n">msg_to_clusters</span>
</pre></div>
</div>
<p>A setting ‘msg_to_clusters’ is needed by the <em>msg_to_clusters</em> plugin
referenced in the <em>on_message</em> the v2 plugins are a little more
cumbersome to write. They are included here for completeness, but
people should use version 3 (either flowCallback, or extensions
discussed next) when possible.</p>
<p>Reasons to use newer style plugins:</p>
<ul class="simple">
<li><p>Support for running v2 plugins is accomplished using a flowcb
called v2wrapper. It performs a lot of processing to wrap up
the v3 data structures to look like v2 ones, and then has
to propagate the changes back. It’s a bit expensive.</p></li>
<li><p>newer style extensions are ordinary python modules, unlike
v2 ones which require minor magic incantations.</p></li>
<li><p>when a v3 (flowCallback or imported) module has a syntax error,
all the tools of the python interpreter apply, providing
a lot more feedback is given to the coder. with v2, it just
says there is something wrong, much more difficult to debug.</p></li>
<li><p>v3 api is strictly more powerful than v2, as it works
on groups of messages, rather than individual ones.</p></li>
</ul>
</section>
<section id="environment-variables">
<h5><a class="toc-backref" href="#id75">Environment Variables</a><a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h5>
<p>On can also reference environment variables in configuration files,
using the <em>${ENV}</em> syntax.  If Sarracenia routines needs to make use
of an environment variable, then they can be set in configuration files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">declare</span> <span class="n">env</span> <span class="n">HTTP_PROXY</span><span class="o">=</span><span class="n">localhost</span>
</pre></div>
</div>
</section>
</section>
<section id="logs-and-monitoring">
<h4><a class="toc-backref" href="#id76">LOGS and MONITORING</a><a class="headerlink" href="#logs-and-monitoring" title="Permalink to this headline">¶</a></h4>
<ul>
<li><dl class="simple">
<dt>debug</dt><dd><p>Setting option debug is identical to use  <strong>logLevel debug</strong></p>
</dd>
</dl>
</li>
<li><p>logMessageDump  (default: off) boolean flag
if set, all fields of a message are printed, rather than just a url/path reference.</p></li>
<li><dl class="simple">
<dt>logEvents ( default after_accept,after_work,on_housekeeping )</dt><dd><p>emit standard log messages at the given points in message processing.
other values: on_start, on_stop, post, gather, … etc…</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>logLevel ( default: info )</dt><dd><p>The level of logging as expressed by python’s logging. Possible values are :  critical, error, info, warning, debug.</p>
</dd>
</dl>
</li>
<li><p>–logStdout ( default: False )  EXPERIMENTAL FOR DOCKER use case</p>
<blockquote>
<div><p>The <em>logStdout</em> disables log management. Best used on the command line, as there is
some risk of creating stub files before the configurations are completely parsed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr3</span> <span class="o">--</span><span class="n">logStdout</span> <span class="n">start</span>
</pre></div>
</div>
<p>All launched processes inherit their file descriptors from the parent. so all output is like an interactive session.</p>
<p>This is in contrast to the normal case, where each instance takes care of its logs, rotating and purging periodically.
In some cases, one wants to have other software take care of logs, such as in docker, where it is preferable for all
logging to be to standard output.</p>
<p>It has not been measured, but there is a reasonable likelihood that use of <em>logStdout</em> with large configurations (dozens
of configured instances/processes) will cause either corruption of logs, or limit the speed of execution of all processes
writing to stdout.</p>
</div></blockquote>
</li>
<li><dl class="simple">
<dt>log_reject &lt;True|False&gt; ( default: False )</dt><dd><p>print a log message when <em>rejecting</em> messages (choosing not to download the corresponding files)</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>log &lt;dir&gt; ( default: ~/.cache/sarra/log ) (on Linux)</dt><dd><p>The directory to store log files in.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>statehost &lt;False|True&gt; ( default: False )</dt><dd><p>In large data centres, the home directory can be shared among thousands of
nodes. Statehost adds the node name after the cache directory to make it
unique to each node. So each node has it’s own statefiles and logs.
example, on a node named goofy,  ~/.cache/sarra/log/ becomes ~/.cache/sarra/goofy/log.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>logrotate &lt;max_logs&gt; ( default: 5 )</dt><dd><p>Maximum number of logs archived.</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>logrotate_interval &lt;duration&gt;[&lt;time_unit&gt;] ( default: 1 )</dt><dd><p>The duration of the interval with an optional time unit (ie 5m, 2h, 3d)</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>permLog ( default: 0600 )</dt><dd><p>The permission bits to set on log files.</p>
</dd>
</dl>
</li>
</ul>
<p>See the <cite>Subscriber Guide &lt;../How2Guides/subscriber.rst&gt;</cite> for a more detailed discussion of logging
options and techniques.</p>
</section>
<section id="credentials">
<h4><a class="toc-backref" href="#id77">CREDENTIALS</a><a class="headerlink" href="#credentials" title="Permalink to this headline">¶</a></h4>
<p>One normally does not specify passwords in configuration files.  Rather they are placed
in the credentials file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr_subscribe</span> <span class="n">edit</span> <span class="n">credentials</span>
</pre></div>
</div>
<p>For every url specified that requires a password, one places
a matching entry in credentials.conf.
The broker option sets all the credential information to connect to the  <strong>RabbitMQ</strong> server</p>
<ul class="simple">
<li><p><strong>broker amqp{s}://&lt;user&gt;:&lt;pw&gt;&#64;&lt;brokerhost&gt;[:port]/&lt;vhost&gt;</strong></p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">default</span><span class="p">:</span> <span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">anonymous</span><span class="p">:</span><span class="n">anonymous</span><span class="nd">@dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span> <span class="p">)</span>
</pre></div>
</div>
<p>For all <strong>sarracenia</strong> programs, the confidential parts of credentials are stored
only in ~/.config/sarra/credentials.conf.  This includes the destination and the broker
passwords and settings needed by components.  The format is one entry per line.  Examples:</p>
<ul class="simple">
<li><p><strong>amqp://user1:password1&#64;host/</strong></p></li>
<li><p><strong>amqps://user2:password2&#64;host:5671/dev</strong></p></li>
<li><p><strong>amqps://usern:passwd&#64;host/ login_method=PLAIN</strong></p></li>
<li><p><strong>sftp://user5:password5&#64;host</strong></p></li>
<li><p><strong>sftp://user6:password6&#64;host:22  ssh_keyfile=/users/local/.ssh/id_dsa</strong></p></li>
<li><p><strong>ftp://user7:password7&#64;host  passive,binary</strong></p></li>
<li><p><strong>ftp://user8:password8&#64;host:2121  active,ascii</strong></p></li>
<li><p><strong>ftps://user7:De%3Aize&#64;host  passive,binary,tls</strong></p></li>
<li><p><strong>ftps://user8:%2fdot8&#64;host:2121  active,ascii,tls,prot_p</strong></p></li>
<li><p><strong>https://ladsweb.modaps.eosdis.nasa.gov/ bearer_token=89APCBF0-FEBE-11EA-A705-B0QR41911BF4</strong></p></li>
</ul>
<p>In other configuration files or on the command line, the url simply lacks the
password or key specification.  The url given in the other files is looked
up in credentials.conf.</p>
<section id="credential-details">
<h5><a class="toc-backref" href="#id78">Credential Details</a><a class="headerlink" href="#credential-details" title="Permalink to this headline">¶</a></h5>
<p>You may need to specify additional options for specific credential entries. These details can be added after the end of the URL, with multiple details separated by commas (see examples above).</p>
<p>Supported details:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ssh_keyfile=&lt;path&gt;</span></code> - (SFTP) Path to SSH keyfile</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">passive</span></code> - (FTP) Use passive mode</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">active</span></code> - (FTP) Use active mode</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">binary</span></code> - (FTP) Use binary mode</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ascii</span></code> - (FTP) Use ASCII mode</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssl</span></code> - (FTP) Use SSL/standard FTP</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">tls</span></code> - (FTP) Use FTPS with TLS</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">prot_p</span></code> - (FTPS) Use a secure data connection for TLS connections (otherwise, clear text is used)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bearer_token=&lt;token&gt;</span></code> (or <code class="docutils literal notranslate"><span class="pre">bt=&lt;token&gt;</span></code>) - (HTTP) Bearer token for authentication</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">login_method=&lt;PLAIN|AMQPLAIN|EXTERNAL|GSSAPI&gt;</span></code> - (AMQP) By default, the login method will be automatically determined. This can be overriden by explicity specifying a login method, which may be required if a broker supports multiple methods and an incorrect one is automatically selected.</p></li>
</ul>
<dl>
<dt>Note::</dt><dd><p>SFTP credentials are optional, in that sarracenia will look in the .ssh directory
and use the normal SSH credentials found there.</p>
<p>These strings are URL encoded, so if an account has a password with a special
character, its URL encoded equivalent can be supplied.  In the last example above,
<strong>%2f</strong> means that the actual password isi: <strong>/dot8</strong>
The next to last password is:  <strong>De:olonize</strong>. ( %3a being the url encoded value for a colon character. )</p>
</dd>
</dl>
</section>
</section>
</section>
<section id="consumer">
<h3><a class="toc-backref" href="#id79">CONSUMER</a><a class="headerlink" href="#consumer" title="Permalink to this headline">¶</a></h3>
<p>Most Metpx Sarracenia components loop on reception and consumption of sarracenia
AMQP messages.  Usually, the messages of interest are <a class="reference external" href="sr3_post.7.rst">sr3_post(7)</a>
messages, announcing the availability of a file by publishing its URL ( or a part
of a file ), but there are also <a class="reference external" href="#report">sr_report(7)</a> messages which
can be processed using the same tools. AMQP messages are published to an exchange
on a broker (AMQP server). The exchange delivers messages to queues. To receive
messages, one must provide the credentials to connect to the broker (AMQP message
pump). Once connected, a consumer needs to create a queue to hold pending messages.
The consumer must then bind the queue to one or more exchanges so that they put
messages in its queue.</p>
<p>Once the bindings are set, the program can receive messages. When a message is received,
further filtering is possible using regular expressions onto the AMQP messages.
After a message passes this selection process, and other internal validation, the
component can run an <strong>after_accept</strong> plugin script to perform additional message
processing. If this plugin returns False, the message is discarded. If True,
processing continues.</p>
<p>The following sections explains all the options to set this “consuming” part of
sarracenia programs.</p>
<section id="setting-the-broker">
<h4><a class="toc-backref" href="#id80">Setting the Broker</a><a class="headerlink" href="#setting-the-broker" title="Permalink to this headline">¶</a></h4>
<p><strong>broker [amqp|mqtt]{s}://&lt;user&gt;:&lt;password&gt;&#64;&lt;brokerhost&gt;[:port]/&lt;vhost&gt;</strong></p>
<p>A URI is used to configure a connection to a message pump, either
an MQTT or an AMQP broker. Some Sarracenia components set a reasonable default for
that option.  provide the normal user,host,port of connections. In most configuration files,
the password is missing. The password is normally only included in the credentials.conf file.</p>
<p>Sarracenia work has not used vhosts, so <strong>vhost</strong> should almost always be <strong>/</strong>.</p>
<p>for more info on the AMQP URI format: ( <a class="reference external" href="https://www.rabbitmq.com/uri-spec.html">https://www.rabbitmq.com/uri-spec.html</a> )</p>
<p>either in the default.conf or each specific configuration file.
The broker option tell each component which broker to contact.</p>
<p><strong>broker [amqp|mqtt]{s}://&lt;user&gt;:&lt;pw&gt;&#64;&lt;brokerhost&gt;[:port]/&lt;vhost&gt;</strong></p>
<dl class="simple">
<dt>::</dt><dd><p>(default: None and it is mandatory to set it )</p>
</dd>
</dl>
<p>Once connected to an AMQP broker, the user needs to bind a queue
to exchanges and topics to determine the messages of interest.</p>
</section>
<section id="creating-the-queue">
<h4><a class="toc-backref" href="#id81">Creating the Queue</a><a class="headerlink" href="#creating-the-queue" title="Permalink to this headline">¶</a></h4>
<p>Once connected to an AMQP broker, the user needs to create a queue.</p>
<p>Setting the queue on broker :</p>
<ul class="simple">
<li><p><strong>queue         &lt;name&gt;         (default: q_&lt;brokerUser&gt;.&lt;programName&gt;.&lt;configName&gt;)</strong></p></li>
<li><p><strong>durable       &lt;boolean&gt;      (default: True)</strong></p></li>
<li><p><strong>expire        &lt;duration&gt;      (default: 5m  == five minutes. RECOMMEND OVERRIDING)</strong></p></li>
<li><p><strong>message_ttl   &lt;duration&gt;      (default: None)</strong></p></li>
<li><p><strong>prefetch      &lt;N&gt;            (default: 1)</strong></p></li>
<li><p><strong>reset         &lt;boolean&gt;      (default: False)</strong></p></li>
<li><p><strong>restore       &lt;boolean&gt;      (default: False)</strong></p></li>
<li><p><strong>restore_to_queue &lt;queuename&gt; (default: None)</strong></p></li>
<li><p><strong>save          &lt;boolean&gt;      (default: False)</strong></p></li>
<li><p><strong>declare_queue &lt;boolean&gt;      (default: True)</strong></p></li>
<li><p><strong>bind_queue    &lt;boolean&gt;      (default: True)</strong></p></li>
</ul>
<p>Usually components guess reasonable defaults for all these values
and users do not need to set them.  For less usual cases, the user
may need to override the defaults.  The queue is where the notifications
are held on the server for each subscriber.</p>
<section id="queue-queue-name-qn-name">
<h5><a class="toc-backref" href="#id82">[ queue|queue_name|qn &lt;name&gt;]</a><a class="headerlink" href="#queue-queue-name-qn-name" title="Permalink to this headline">¶</a></h5>
<p>By default, components create a queue name that should be unique. The
default queue_name components create follows the following convention:</p>
<blockquote>
<div><p><strong>q_&lt;brokerUser&gt;.&lt;programName&gt;.&lt;configName&gt;.&lt;random&gt;.&lt;random&gt;</strong></p>
</div></blockquote>
<p>Where:</p>
<ul class="simple">
<li><p><em>brokerUser</em> is the username used to connect to the broker (often: <em>anonymous</em> )</p></li>
<li><p><em>programName</em> is the component using the queue (e.g. <em>sr_subscribe</em> ),</p></li>
<li><p><em>configName</em> is the configuration file used to tune component behaviour.</p></li>
<li><p><em>random</em> is just a series of characters chosen to avoid clashes from multiple
people using the same configurations</p></li>
</ul>
<p>Users can override the default provided that it starts with <strong>q_&lt;brokerUser&gt;</strong>.</p>
<p>When multiple instances are used, they will all use the same queue, for trivial
multi-tasking. If multiple computers have a shared home file system, then the
queue_name is written to:</p>
<blockquote>
<div><p>~/.cache/sarra/&lt;programName&gt;/&lt;configName&gt;/&lt;programName&gt;_&lt;configName&gt;_&lt;brokerUser&gt;.qname</p>
</div></blockquote>
<p>Instances started on any node with access to the same shared file will use the
same queue. Some may want use the <em>queue_name</em> option as a more explicit method
of sharing work across multiple nodes.</p>
</section>
<section id="durable-boolean-default-true">
<h5><a class="toc-backref" href="#id83">durable &lt;boolean&gt; (default: True)</a><a class="headerlink" href="#durable-boolean-default-true" title="Permalink to this headline">¶</a></h5>
<p>The  <strong>durable</strong> option, if set to True, means writes the queue
on disk if the broker is restarted.</p>
</section>
<section id="expire-duration-default-5m-five-minutes-recommend-overriding">
<h5><a class="toc-backref" href="#id84">expire &lt;duration&gt; (default: 5m  == five minutes. RECOMMEND OVERRIDING)</a><a class="headerlink" href="#expire-duration-default-5m-five-minutes-recommend-overriding" title="Permalink to this headline">¶</a></h5>
<p>The  <strong>expire</strong>  option is expressed as a duration… it sets how long should live
a queue without connections.</p>
<p>A raw integer is expressed in seconds, if the suffix m,h,d,w
are used, then the interval is in minutes, hours, days, or weeks. After the queue expires,
the contents are dropped, and so gaps in the download data flow can arise.  A value of
1d (day) or 1w (week) can be appropriate to avoid data loss. It depends on how long
the subscriber is expected to shutdown, and not suffer data loss.</p>
<p>if no units are given, then a decimal number of seconds can be provided, such as
to indicate 0.02 to specify a duration of 20 milliseconds.</p>
<p>The <strong>expire</strong> setting must be overridden for operational use.
The default is set low because it defines how long resources on the broker will be assigned,
and in early use (when default was 1 week) brokers would often get overloaded with very
long queues for left-over experiments.</p>
</section>
<section id="message-ttl-duration-default-none">
<h5><a class="toc-backref" href="#id85">message_ttl &lt;duration&gt;  (default: None)</a><a class="headerlink" href="#message-ttl-duration-default-none" title="Permalink to this headline">¶</a></h5>
<p>The  <strong>message_ttl</strong>  option set the time a message can live in the queue.
Past that time, the message is taken out of the queue by the broker.</p>
</section>
<section id="prefetch-n-default-1">
<h5><a class="toc-backref" href="#id86">prefetch &lt;N&gt; (default: 1)</a><a class="headerlink" href="#prefetch-n-default-1" title="Permalink to this headline">¶</a></h5>
<p>The <strong>prefetch</strong> option sets the number of messages to fetch at one time.
When multiple instances are running and prefetch is 4, each instance will obtain up to four
messages at a time.  To minimize the number of messages lost if an instance dies and have
optimal load sharing, the prefetch should be set as low as possible.  However, over long
haul links, it is necessary to raise this number, to hide round-trip latency, so a setting
of 10 or more may be needed.</p>
</section>
<section id="reset-boolean-default-false">
<h5><a class="toc-backref" href="#id87">reset &lt;boolean&gt; (default: False)</a><a class="headerlink" href="#reset-boolean-default-false" title="Permalink to this headline">¶</a></h5>
<p>When <strong>reset</strong> is set, and a component is (re)started, its queue is
deleted (if it already exists) and recreated according to the component’s
queue options.  This is when a broker option is modified, as the broker will
refuse access to a queue declared with options that differ from what was
set at creation.  It can also be used to discard a queue quickly when a receiver
has been shut down for a long period. If duplicate suppression is active, then
the reception cache is also discarded.</p>
<p>The AMQP protocol defines other queue options which are not exposed
via sarracenia, because sarracenia itself picks appropriate values.</p>
</section>
<section id="save-restore">
<h5><a class="toc-backref" href="#id88">save/restore</a><a class="headerlink" href="#save-restore" title="Permalink to this headline">¶</a></h5>
<p>The <strong>save</strong> option is used to read messages from the queue and write them
to a local file, saving them for future processing, rather than processing
them immediately.  See the <a class="reference internal" href="#sender-destination-unavailable">Sender Destination Unavailable</a> section for more details.
The <strong>restore</strong> option implements the reverse function, reading from the file
for processing.</p>
<p>If <strong>restore_to_queue</strong> is specified, then rather than triggering local
processing, the messages restored are posted to a temporary exchange
bound to the given queue.  For an example, see <a class="reference internal" href="#shovel-save-restore">Shovel Save/Restore</a></p>
</section>
<section id="declare-queue-bind-queue">
<h5><a class="toc-backref" href="#id89">declare_queue/bind_queue</a><a class="headerlink" href="#declare-queue-bind-queue" title="Permalink to this headline">¶</a></h5>
<p>On startup, by default, Sarracenia redeclares resources and bindings to ensure they
are uptodate.  If the queue already exists, These flags can be
set to False, so no attempt to declare the queue is made, or it´s bindings.
These options are useful on brokers that do not permit users to declare their queues.</p>
</section>
</section>
<section id="amqp-queue-bindings">
<h4><a class="toc-backref" href="#id90">AMQP QUEUE BINDINGS</a><a class="headerlink" href="#amqp-queue-bindings" title="Permalink to this headline">¶</a></h4>
<p>Once one has a queue, it must be bound to an exchange.
Users almost always need to set these options. Once a queue exists
on the broker, it must be bound to an exchange. Bindings define which
messages (URL notifications) the program receives. The root of the topic
tree is fixed to indicate the protocol version and type of the
message (but developers can override it with the <strong>topicPrefix</strong>
option.)</p>
<p>These options define which messages (URL notifications) the program receives:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>exchange      &lt;name&gt;         (default: xpublic)</strong></p></li>
<li><p><strong>exchange_suffix      &lt;name&gt;  (default: None)</strong></p></li>
<li><p><strong>topicPrefix  &lt;amqp pattern&gt; (default: v03 – developer option)</strong></p></li>
<li><p><strong>subtopic      &lt;amqp pattern&gt; (no default, must appear after exchange)</strong></p></li>
</ul>
</div></blockquote>
<section id="exchange-name-default-xpublic-and-exchange-suffix">
<h5><a class="toc-backref" href="#id91">exchange &lt;name&gt; (default: xpublic) and exchange_suffix</a><a class="headerlink" href="#exchange-name-default-xpublic-and-exchange-suffix" title="Permalink to this headline">¶</a></h5>
<p>The convention on data pumps is to use the <em>xpublic</em> exchange. Users can establish
private data flow for their own processing. Users can declare their own exchanges
that always begin with <em>xs_&lt;username&gt;</em>, so to save having to specify that each
time, one can just set <em>exchange_suffix kk</em> which will result in the exchange
being set to <em>xs_&lt;username&gt;_kk</em> (overriding the <em>xpublic</em> default).
These settings must appear in the configuration file before the corresponding
<em>topicPrefix</em> and <em>subtopic</em> settings.</p>
</section>
<section id="subtopic-amqp-pattern-default">
<h5><a class="toc-backref" href="#id92">subtopic &lt;amqp pattern&gt; (default: #)</a><a class="headerlink" href="#subtopic-amqp-pattern-default" title="Permalink to this headline">¶</a></h5>
<p>Within an exchange’s postings, the subtopic setting narrows the product selection.
To give a correct value to the subtopic,
one has the choice of filtering using <strong>subtopic</strong> with only AMQP’s limited wildcarding and
length limited to 255 encoded bytes, or the more powerful regular expression
based  <strong>accept/reject</strong>  mechanisms described below. The difference being that the
AMQP filtering is applied by the broker itself, saving the notices from being delivered
to the client at all. The  <strong>accept/reject</strong>  patterns apply to messages sent by the
broker to the subscriber. In other words,  <strong>accept/reject</strong>  are client side filters,
whereas <strong>subtopic</strong> is server side filtering.</p>
<p>It is best practice to use server side filtering to reduce the number of announcements sent
to the client to a small superset of what is relevant, and perform only a fine-tuning with the
client side mechanisms, saving bandwidth and processing for all.</p>
<p>topicPrefix is primarily of interest during protocol version transitions,
where one wishes to specify a non-default protocol version of messages to
subscribe to.</p>
<p>Usually, the user specifies one exchange, and several subtopic options.
<strong>Subtopic</strong> is what is normally used to indicate messages of interest.
To use the subtopic to filter the products, match the subtopic string with
the relative path of the product.</p>
<p>For example, consuming from DD, to give a correct value to subtopic, one can
browse the our website  <strong>http://dd.weather.gc.ca</strong> and write down all directories
of interest.  For each directory tree of interest, write a  <strong>subtopic</strong>
option as follow:</p>
<blockquote>
<div><p><strong>subtopic  directory1.*.subdirectory3.*.subdirectory5.#</strong></p>
</div></blockquote>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">where</span><span class="p">:</span>
      <span class="o">*</span>                <span class="n">matches</span> <span class="n">a</span> <span class="n">single</span> <span class="n">directory</span> <span class="n">name</span>
      <span class="c1">#                matches any remaining tree of directories.</span>
</pre></div>
</div>
<dl>
<dt>note:</dt><dd><p>When directories have these wild-cards, or spaces in their names, they
will be URL-encoded ( ‘#’ becomes %23 )
When directories have periods in their name, this will change
the topic hierarchy.</p>
<dl class="simple">
<dt>FIXME:</dt><dd><p>hash marks are URL substituted, but did not see code for other values.
Review whether asterisks in directory names in topics should be URL-encoded.
Review whether periods in directory names in topics should be URL-encoded.</p>
</dd>
</dl>
</dd>
</dl>
<p>One can use multiple bindings to multiple exchanges as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exchange</span> <span class="n">A</span>
<span class="n">subtopic</span> <span class="n">directory1</span><span class="o">.*.</span><span class="n">directory2</span><span class="o">.</span><span class="c1">#</span>

<span class="n">exchange</span> <span class="n">B</span>
<span class="n">subtopic</span> <span class="o">*.</span><span class="n">directory4</span><span class="o">.</span><span class="c1">#</span>
</pre></div>
</div>
<p>Will declare two separate bindings to two different exchanges, and two different file trees.
While default binding is to bind to everything, some brokers might not permit
clients to set bindings, or one might want to use existing bindings.
One can turn off queue binding as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subtopic</span> <span class="kc">None</span>
</pre></div>
</div>
<p>(False, or off will also work.)</p>
</section>
</section>
<section id="client-side-filtering">
<h4><a class="toc-backref" href="#id93">Client-side Filtering</a><a class="headerlink" href="#client-side-filtering" title="Permalink to this headline">¶</a></h4>
<p>We have selected our messages through <strong>exchange</strong>, <strong>subtopic</strong> and
perhaps patterned  <strong>subtopic</strong> with AMQP’s limited wildcarding which
is all done by the broker (server-side). The broker puts the
corresponding messages in our queue. The subscribed component
downloads these messages.  Once the message is downloaded, Sarracenia
clients apply more flexible client side filtering using regular expressions.</p>
<section id="brief-introduction-to-regular-expressions">
<h5><a class="toc-backref" href="#id94">Brief Introduction to Regular Expressions</a><a class="headerlink" href="#brief-introduction-to-regular-expressions" title="Permalink to this headline">¶</a></h5>
<p>Regular expressions are a very powerful way of expressing pattern matches.
They provide extreme flexibility, but in these examples we will only use a
very trivial subset: The . is a wildcard matching any single character. If it
is followed by an occurrence count, it indicates how many letters will match
the pattern. The * (asterisk) character, means any number of occurrences.
So:</p>
<blockquote>
<div><ul class="simple">
<li><p>.* means any sequence of characters of any length. In other words, match anything.</p></li>
<li><p>cap.* means any sequence of characters that starts with cap.</p></li>
<li><p>.*CAP.* means any sequence of characters with CAP somewhere in it.</p></li>
<li><p>.*cap means any sequence of characters that ends with CAP.  In the case
where multiple portions of the string could match, the longest one is selected.</p></li>
<li><p>.*?cap same as above, but <em>non-greedy</em>, meaning the shortest match is chosen.</p></li>
</ul>
</div></blockquote>
<p>Please consult various internet resources for more information on the full
variety of matching possible with regular expressions:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/library/re.html">https://docs.python.org/3/library/re.html</a></p></li>
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Regular_expression">https://en.wikipedia.org/wiki/Regular_expression</a></p></li>
<li><p><a class="reference external" href="http://www.regular-expressions.info/">http://www.regular-expressions.info/</a></p></li>
</ul>
</div></blockquote>
</section>
<section id="accept-reject-and-accept-unmatch">
<h5><a class="toc-backref" href="#id95">accept, reject and accept_unmatch</a><a class="headerlink" href="#accept-reject-and-accept-unmatch" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li><p><strong>accept    &lt;regexp pattern&gt; (optional)</strong></p></li>
<li><p><strong>reject    &lt;regexp pattern&gt; (optional)</strong></p></li>
<li><p><strong>accept_unmatch   &lt;boolean&gt; (default: False)</strong></p></li>
<li><p><strong>baseUrl_relPath   &lt;boolean&gt; (default: False)</strong></p></li>
</ul>
<p>The  <strong>accept</strong>  and  <strong>reject</strong>  options process regular expressions (regexp).
The regexp is applied to the the message’s URL for a match.</p>
<p>If the message’s URL of a file matches a <strong>reject</strong>  pattern, the message
is acknowledged as consumed to the broker and skipped.</p>
<p>One that matches an <strong>accept</strong> pattern is processed by the component.</p>
<p>In many configurations, <strong>accept</strong> and <strong>reject</strong> options are mixed
with the <strong>directory</strong> option.  They then relate accepted messages
to the <strong>directory</strong> value they are specified under.</p>
<p>After all <strong>accept</strong> / <strong>reject</strong>  options are processed, normally
the message is acknowledged as consumed and skipped. To override that
default, set <strong>accept_unmatch</strong> to True. The <strong>accept/reject</strong>
settings are interpreted in order. Each option is processed orderly
from top to bottom. For example:</p>
<p>sequence #1:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reject</span> <span class="o">.*</span>\<span class="o">.</span><span class="n">gif</span>
<span class="n">accept</span> <span class="o">.*</span>
</pre></div>
</div>
<p>sequence #2:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">accept</span> <span class="o">.*</span>
<span class="n">reject</span> <span class="o">.*</span>\<span class="o">.</span><span class="n">gif</span>
</pre></div>
</div>
<p>In sequence #1, all files ending in ‘gif’ are rejected.  In sequence #2, the accept .* (which
accepts everything) is encountered before the reject statement, so the reject has no effect.</p>
<p>It is best practice to use server side filtering to reduce the number of announcements sent
to the component to a small superset of what is relevant, and perform only a fine-tuning with the
client side mechanisms, saving bandwidth and processing for all. More details on how
to apply the directives follow:</p>
<p>Normally the relative path (appended to the base directory) for files which are downloaded
will be set according to the relPath header included in the message.  if <em>baseUrl_relPath</em>
is set, however, the message’s relPath will be prepended with the sub-directories from
the message’s baseUrl field.</p>
</section>
</section>
<section id="acceleration">
<h4><a class="toc-backref" href="#id96">ACCELERATION</a><a class="headerlink" href="#acceleration" title="Permalink to this headline">¶</a></h4>
<p>Some protocols permit an binary downloader to be used in place of the default
pure python code. There is overhead in spawning a binary downloader, and so
for smaller files it is faster and/or more efficient to use built-in processing.</p>
<section id="accel-treshold-byte-count-default-0-disabled">
<h5><a class="toc-backref" href="#id97">accel_treshold &lt;byte count&gt; (default: 0- disabled.)</a><a class="headerlink" href="#accel-treshold-byte-count-default-0-disabled" title="Permalink to this headline">¶</a></h5>
<p>The accel_threshold indicates the minimum size of file being transferred for
which a binary downloader will be launched.</p>
</section>
<section id="accel-xx-command">
<h5><a class="toc-backref" href="#id98">accel_xx_command</a><a class="headerlink" href="#accel-xx-command" title="Permalink to this headline">¶</a></h5>
<p>Can specify alternate binaries for downloaders to tune for specific cases.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 52%" />
<col style="width: 48%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Option</p></td>
<td><p>Defaul value</p></td>
</tr>
<tr class="row-even"><td><p>accel_wget_command</p></td>
<td><p>/usr/bin/wget %s -O %d</p></td>
</tr>
<tr class="row-odd"><td><p>accel_scp_command</p></td>
<td><p>/usr/bin/scp %s %d</p></td>
</tr>
<tr class="row-even"><td><p>accel_cp_command</p></td>
<td><p>/usr/bin/cp  %s %d</p></td>
</tr>
<tr class="row-odd"><td><p>accel_ftpget_command</p></td>
<td><p>/usr/bin/ncftpget %s %d</p></td>
</tr>
<tr class="row-even"><td><p>accel_ftpput_command</p></td>
<td><p>/usr/bin/ncftpput %s %d</p></td>
</tr>
</tbody>
</table>
<p>use the %s to stand-in for the name of the source file, and %d for the
file being written.  An example setting to override with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">accel_cp_command</span> <span class="n">dd</span> <span class="k">if</span><span class="o">=%</span><span class="n">s</span> <span class="n">of</span><span class="o">=%</span><span class="n">d</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4096</span><span class="n">k</span>
</pre></div>
</div>
</section>
</section>
<section id="delivery-specifications">
<h4><a class="toc-backref" href="#id99">DELIVERY SPECIFICATIONS</a><a class="headerlink" href="#delivery-specifications" title="Permalink to this headline">¶</a></h4>
<p>These options set what files the user wants and where it will be placed,
and under which name.</p>
<ul class="simple">
<li><p><strong>accel_threshold  &lt;byte count&gt; (default: 0)</strong></p></li>
<li><p><strong>accept    &lt;regexp pattern&gt; (must be set)</strong></p></li>
<li><p><strong>accept_unmatch   &lt;boolean&gt; (default: off)</strong></p></li>
<li><p><strong>acceptSizeWrong   &lt;boolean&gt; (default: off)</strong></p></li>
<li><p><strong>attempts     &lt;count&gt;          (default: 3)</strong></p></li>
<li><p><strong>batch     &lt;count&gt;          (default: 100)</strong></p></li>
<li><p><strong>permDefault     &lt;octalint&gt;       (default: 0 - umask)</strong></p></li>
<li><p><strong>permLog &lt;octalint&gt;       (default: 0755)</strong></p></li>
<li><p><strong>delete    &lt;boolean&gt;&gt;       (default: off)</strong></p></li>
<li><p><strong>directory &lt;path&gt;           (default: .)</strong></p></li>
<li><p><strong>discard   &lt;boolean&gt;        (default: off)</strong></p></li>
<li><p><strong>download  &lt;boolean&gt;        (default: on)</strong></p></li>
<li><p><strong>baseDir &lt;path&gt;       (default: /)</strong></p></li>
<li><p><strong>flatten   &lt;string&gt;         (default: ‘/’)</strong></p></li>
<li><p><strong>housekeeping &lt;count&gt;                 (default: 300 seconds)</strong></p></li>
<li><p><strong>inline   &lt;boolean&gt;         (default: False)</strong></p></li>
<li><p><strong>inline_max   &lt;counts&gt;         (default: 1024)</strong></p></li>
<li><p><strong>inline_only   &lt;boolean&gt;       (default: False)</strong></p></li>
<li><p><strong>inplace       &lt;boolean&gt;        (default: On)</strong></p></li>
<li><p><strong>kbytes_ps &lt;count&gt;               (default: 0)</strong></p></li>
<li><p><strong>inflight  &lt;string&gt;         (default: .tmp or NONE if post_broker set)</strong></p></li>
<li><p><strong>messageCountMax &lt;count&gt; (default: 0 == DISABLED)</strong></p></li>
<li><p><strong>messageRateMax &lt;float&gt;   (default: 0 == DISABLED)</strong></p></li>
<li><p><strong>messageRateMin &lt;float&gt;   (default: 0 == DISABLED)</strong></p></li>
<li><p><strong>mirror    &lt;boolean&gt;        (default: off)</strong></p></li>
<li><p><strong>nodupe   &lt;off|on|999[smhdw]&gt;     (default: off)</strong></p></li>
<li><p><strong>nodupe_basis   &lt;data|name|path&gt;     (default: path)</strong></p></li>
<li><p><strong>outlet    post|json|url    (default: post)</strong></p></li>
<li><p><strong>overwrite &lt;boolean&gt;        (default: off)</strong></p></li>
<li><p><strong>permCopy &lt;boolean&gt;  (default: on)</strong></p></li>
<li><p><strong>timeCopy &lt;boolean&gt;  (default: on)</strong></p></li>
<li><p><strong>reject    &lt;regexp pattern&gt; (optional)</strong></p></li>
<li><p><strong>retry    &lt;boolean&gt;         (default: On)</strong>  (FIXME: OPTION UNIMPLEMENTED. Always on!)</p></li>
<li><p><strong>retry_ttl    &lt;duration&gt;         (default: same as expire)</strong></p></li>
<li><p><strong>source_from_exchange  &lt;boolean&gt; (default: off)</strong></p></li>
<li><p><strong>strip     &lt;count|regexp&gt;   (default: 0)</strong></p></li>
<li><p><strong>timeout     &lt;float&gt;         (default: 0)</strong></p></li>
<li><p><strong>tls_rigour   &lt;lax|medium|strict&gt;  (default: medium)</strong></p></li>
<li><p><strong>xattr_disable  &lt;boolean&gt;  (default: off)</strong></p></li>
</ul>
<section id="attempts-count-default-3">
<h5><a class="toc-backref" href="#id100">attempts &lt;count&gt; (default: 3)</a><a class="headerlink" href="#attempts-count-default-3" title="Permalink to this headline">¶</a></h5>
<p>The <strong>attempts</strong> option indicates how many times to
attempt downloading the data before giving up.  The default of 3 should be appropriate
in most cases.  When the <strong>retry</strong> option is false, the file is then dropped immediately.</p>
<p>When The <strong>retry</strong> option is set (default), a failure to download after prescribed number
of <strong>attempts</strong> (or send, in a sender) will cause the message to be added to a queue file
for later retry.  When there are no messages ready to consume from the AMQP queue,
the retry queue will be queried.</p>
</section>
<section id="acceptsizewrong-boolean-default-false">
<h5><a class="toc-backref" href="#id101">acceptSizeWrong: &lt;boolean&gt; (default: False)</a><a class="headerlink" href="#acceptsizewrong-boolean-default-false" title="Permalink to this headline">¶</a></h5>
</section>
<section id="retry-ttl-duration-default-same-as-expire">
<h5><a class="toc-backref" href="#id102">retry_ttl &lt;duration&gt; (default: same as expire)</a><a class="headerlink" href="#retry-ttl-duration-default-same-as-expire" title="Permalink to this headline">¶</a></h5>
<p>The <strong>retry_ttl</strong> (retry time to live) option indicates how long to keep trying to send
a file before it is aged out of a the queue.  Default is two days.  If a file has not
been transferred after two days of attempts, it is discarded.</p>
</section>
<section id="timeout-float-default-0">
<h5><a class="toc-backref" href="#id103">timeout &lt;float&gt; (default: 0)</a><a class="headerlink" href="#timeout-float-default-0" title="Permalink to this headline">¶</a></h5>
<p>The <strong>timeout</strong> option, sets the number of seconds to wait before aborting a
connection or download transfer (applied per buffer during transfer).</p>
</section>
<section id="inflight-string-default-tmp-or-none-if-post-broker-set">
<h5><a class="toc-backref" href="#id104">inflight &lt;string&gt; (default: .tmp or NONE if post_broker set)</a><a class="headerlink" href="#inflight-string-default-tmp-or-none-if-post-broker-set" title="Permalink to this headline">¶</a></h5>
<p>The  <strong>inflight</strong>  option sets how to ignore files when they are being transferred
or (in mid-flight betweeen two systems). Incorrect setting of this option causes
unreliable transfers, and care must be taken.  See <a class="reference internal" href="#delivery-completion-inflight">Delivery Completion (inflight)</a>
for more details.</p>
<p>The value can be a file name suffix, which is appended to create a temporary name during
the transfer.  If <strong>inflight</strong>  is set to <strong>.</strong>, then it is a prefix, to conform with
the standard for “hidden” files on unix/linux.
If <strong>inflight</strong>  ends in / (example: <em>tmp/</em> ), then it is a prefix, and specifies a
sub-directory of the destination into which the file should be written while in flight.</p>
<p>Whether a prefix or suffix is specified, when the transfer is
complete, the file is renamed to its permanent name to allow further processing.</p>
<p>When posting a file with sr3_post, sr_cpost, or sr3_watch, the  <strong>inflight</strong>  option
can also be specified as a time interval, for example, 10 for 10 seconds.
When set to a time interval, file posting process ensures that it waits until
the file has not been modified in that interval. So a file will
not be processed until it has stayed the same for at least 10 seconds.
If you see the error message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inflight</span> <span class="n">setting</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span> <span class="ow">not</span> <span class="k">for</span> <span class="n">remote</span>
</pre></div>
</div>
<p>It is because the time interval setting is only supported by sr3_post/sr_cpost/sr3_watch.
in looking at local files before generating a post, it is not used as say, a means
of delaying sending files.</p>
<p>Lastly, <strong>inflight</strong> can be set to <em>NONE</em>, which case the file is written directly
with the final name, where the recipient will wait to receive a post notifying it
of the file’s arrival.  This is the fastest, lowest overhead option when it is available.
It is also the default when a <em>post_broker</em> is given, indicating that some
other process is to be notified after delivery.</p>
</section>
<section id="delete-boolean-default-off">
<h5><a class="toc-backref" href="#id105">delete &lt;boolean&gt; (default: off)</a><a class="headerlink" href="#delete-boolean-default-off" title="Permalink to this headline">¶</a></h5>
<p>When the <strong>delete</strong> option is set, after a download has completed successfully, the subscriber
will delete the file at the upstream source.  Default is false.</p>
</section>
<section id="batch-count-default-100">
<h5><a class="toc-backref" href="#id106">batch &lt;count&gt; (default: 100)</a><a class="headerlink" href="#batch-count-default-100" title="Permalink to this headline">¶</a></h5>
<p>The <strong>batch</strong> option is used to indicate how many files should be transferred
over a connection, before it is torn down, and re-established.  On very low
volume transfers, where timeouts can occur between transfers, this should be
lowered to 1.  For most usual situations the default is fine. For higher volume
cases, one could raise it to reduce transfer overhead. It is only used for file
transfer protocols, not HTTP ones at the moment.</p>
</section>
<section id="directory-path-default">
<h5><a class="toc-backref" href="#id107">directory &lt;path&gt; (default: .)</a><a class="headerlink" href="#directory-path-default" title="Permalink to this headline">¶</a></h5>
<p>The <em>directory</em> option defines where to put the files on your server.
Combined with  <strong>accept</strong> / <strong>reject</strong>  options, the user can select the
files of interest and their directories of residence (see the  <strong>mirror</strong>
option for more directory settings).</p>
<p>The  <strong>accept</strong>  and  <strong>reject</strong>  options use regular expressions (regexp) to match URL.
These options are processed sequentially.
The URL of a file that matches a  <strong>reject</strong>  pattern is never downloaded.
One that matches an  <strong>accept</strong>  pattern is downloaded into the directory
declared by the closest  <strong>directory</strong>  option above the matching  <strong>accept</strong> option.
<strong>accept_unmatch</strong> is used to decide what to do when no reject or accept clauses matched.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ex</span><span class="o">.</span>   <span class="n">directory</span> <span class="o">/</span><span class="n">mylocaldirectory</span><span class="o">/</span><span class="n">myradars</span>
      <span class="n">accept</span>    <span class="o">.*</span><span class="n">RADAR</span><span class="o">.*</span>

      <span class="n">directory</span> <span class="o">/</span><span class="n">mylocaldirectory</span><span class="o">/</span><span class="n">mygribs</span>
      <span class="n">reject</span>    <span class="o">.*</span><span class="n">Reg</span><span class="o">.*</span>
      <span class="n">accept</span>    <span class="o">.*</span><span class="n">GRIB</span><span class="o">.*</span>
</pre></div>
</div>
</section>
<section id="mirror-boolean-default-off">
<h5><a class="toc-backref" href="#id108">mirror &lt;boolean&gt; (default: off)</a><a class="headerlink" href="#mirror-boolean-default-off" title="Permalink to this headline">¶</a></h5>
<p>The  <strong>mirror</strong>  option can be used to mirror the dd.weather.gc.ca tree of the files.
If set to  <strong>True</strong>  the directory given by the  <strong>directory</strong>  option
will be the basename of a tree. Accepted files under that directory will be
placed under the subdirectory tree leaf where it resides under dd.weather.gc.ca.
For example retrieving the following url, with options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span><span class="n">radar</span><span class="o">/</span><span class="n">PRECIP</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">WGJ</span><span class="o">/</span><span class="mi">201312141900</span><span class="n">_WGJ_PRECIP_SNOW</span><span class="o">.</span><span class="n">gif</span>

  <span class="n">mirror</span>    <span class="kc">True</span>
  <span class="n">directory</span> <span class="o">/</span><span class="n">mylocaldirectory</span>
  <span class="n">accept</span>    <span class="o">.*</span><span class="n">RADAR</span><span class="o">.*</span>
</pre></div>
</div>
<p>would result in the creation of the directories and the file
/mylocaldirectory/radar/PRECIP/GIF/WGJ/201312141900_WGJ_PRECIP_SNOW.gif
mirror settings can be changed between directory options.</p>
</section>
<section id="strip-count-regexp-default-0">
<h5><a class="toc-backref" href="#id109">strip &lt;count|regexp&gt; (default: 0)</a><a class="headerlink" href="#strip-count-regexp-default-0" title="Permalink to this headline">¶</a></h5>
<p>You can modify the relative mirrored directories with the <strong>strip</strong> option.
If set to N  (an integer) the first ‘N’ directories from the relative path
are removed. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span><span class="n">radar</span><span class="o">/</span><span class="n">PRECIP</span><span class="o">/</span><span class="n">GIF</span><span class="o">/</span><span class="n">WGJ</span><span class="o">/</span><span class="mi">201312141900</span><span class="n">_WGJ_PRECIP_SNOW</span><span class="o">.</span><span class="n">gif</span>

  <span class="n">mirror</span>    <span class="kc">True</span>
  <span class="n">strip</span>     <span class="mi">3</span>
  <span class="n">directory</span> <span class="o">/</span><span class="n">mylocaldirectory</span>
  <span class="n">accept</span>    <span class="o">.*</span><span class="n">RADAR</span><span class="o">.*</span>
</pre></div>
</div>
<p>would result in the creation of the directories and the file
/mylocaldirectory/WGJ/201312141900_WGJ_PRECIP_SNOW.gif
when a regexp is provide in place of a number, it indicates a pattern to be removed
from the relative path.  For example if:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>strip  .*?GIF/
</pre></div>
</div>
<p>Will also result in the file being placed the same location.
Note that strip settings can be changed between directory options.</p>
<dl>
<dt>NOTE::</dt><dd><p>with <strong>strip</strong>, use of <strong>?</strong> modifier (to prevent regular expression <em>greediness</em> ) is often helpful.
It ensures the shortest match is used.</p>
<p>For example, given a file name:  radar/PRECIP/GIF/WGJ/201312141900_WGJ_PRECIP_SNOW.GIF
The expression:  .*?GIF   matches: radar/PRECIP/GIF
whereas the expression: .*GIF matches the entire name.</p>
</dd>
</dl>
</section>
<section id="flatten-string-default">
<h5><a class="toc-backref" href="#id110">flatten &lt;string&gt; (default: ‘/’)</a><a class="headerlink" href="#flatten-string-default" title="Permalink to this headline">¶</a></h5>
<p>The  <strong>flatten</strong>  option is use to set a separator character. The default value ( ‘/’ )
nullifies the effect of this option.  This character replaces the ‘/’ in the url
directory and create a “flatten” filename from its dd.weather.gc.ca path.
For example retrieving the following url, with options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span><span class="n">model_gem_global</span><span class="o">/</span><span class="mi">25</span><span class="n">km</span><span class="o">/</span><span class="n">grib2</span><span class="o">/</span><span class="n">lat_lon</span><span class="o">/</span><span class="mi">12</span><span class="o">/</span><span class="mi">015</span><span class="o">/</span><span class="n">CMC_glb_TMP_TGL_2_latlon</span><span class="mf">.24</span><span class="n">x</span><span class="mf">.24_2013121612</span><span class="n">_P015</span><span class="o">.</span><span class="n">grib2</span>

  <span class="n">flatten</span>   <span class="o">-</span>
  <span class="n">directory</span> <span class="o">/</span><span class="n">mylocaldirectory</span>
  <span class="n">accept</span>    <span class="o">.*</span><span class="n">model_gem_global</span><span class="o">.*</span>
</pre></div>
</div>
<p>would result in the creation of the filepath:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">mylocaldirectory</span><span class="o">/</span><span class="n">model_gem_global</span><span class="o">-</span><span class="mi">25</span><span class="n">km</span><span class="o">-</span><span class="n">grib2</span><span class="o">-</span><span class="n">lat_lon</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">015</span><span class="o">-</span><span class="n">CMC_glb_TMP_TGL_2_latlon</span><span class="mf">.24</span><span class="n">x</span><span class="mf">.24_2013121612</span><span class="n">_P015</span><span class="o">.</span><span class="n">grib2</span>
</pre></div>
</div>
<p>One can also specify variable substitutions to be performed on arguments to the directory
option, with the use of <em>${..}</em> notation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SOURCE</span>   <span class="o">-</span> <span class="n">the</span> <span class="n">amqp</span> <span class="n">user</span> <span class="n">that</span> <span class="n">injected</span> <span class="n">data</span> <span class="p">(</span><span class="n">taken</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">message</span><span class="o">.</span><span class="p">)</span>
<span class="n">BD</span>       <span class="o">-</span> <span class="n">the</span> <span class="n">base</span> <span class="n">directory</span>
<span class="n">BUP</span>      <span class="o">-</span> <span class="n">the</span> <span class="n">path</span> <span class="n">component</span> <span class="n">of</span> <span class="n">the</span> <span class="n">baseUrl</span> <span class="p">(</span><span class="ow">or</span><span class="p">:</span> <span class="n">baseUrlPath</span><span class="p">)</span>
<span class="n">BUPL</span>     <span class="o">-</span> <span class="n">the</span> <span class="n">last</span> <span class="n">element</span> <span class="n">of</span> <span class="n">the</span> <span class="n">baseUrl</span> <span class="n">path</span><span class="o">.</span> <span class="p">(</span><span class="ow">or</span><span class="p">:</span> <span class="n">baseUrlPathLast</span><span class="p">)</span>
<span class="n">PBD</span>      <span class="o">-</span> <span class="n">the</span> <span class="n">post</span> <span class="n">base</span> <span class="nb">dir</span>
<span class="n">YYYYMMDD</span> <span class="o">-</span> <span class="n">the</span> <span class="n">current</span> <span class="n">daily</span> <span class="n">timestamp</span><span class="o">.</span>
<span class="n">HH</span>       <span class="o">-</span> <span class="n">the</span> <span class="n">current</span> <span class="n">hourly</span> <span class="n">timestamp</span><span class="o">.</span>
<span class="o">*</span><span class="n">var</span><span class="o">*</span>    <span class="o">-</span> <span class="nb">any</span> <span class="n">environment</span> <span class="n">variable</span><span class="o">.</span>
</pre></div>
</div>
<p>The YYYYMMDD and HH time stamps refer to the time at which the data is processed by
the component, it is not decoded or derived from the content of the files delivered.
All date/times in Sarracenia are in UTC.</p>
<p>Refer to <em>source_from_exchange</em> for a common example of usage.  Note that any sarracenia
built-in value takes precedence over a variable of the same name in the environment.
Note that flatten settings can be changed between directory options.</p>
</section>
<section id="basedir-path-default">
<h5><a class="toc-backref" href="#id111">baseDir &lt;path&gt; (default: /)</a><a class="headerlink" href="#basedir-path-default" title="Permalink to this headline">¶</a></h5>
<p><strong>baseDir</strong> supplies the directory path that, when combined with the relative
one in the selected notification gives the absolute path of the file to be sent.
The default is None which means that the path in the notification is the absolute one.</p>
<dl class="simple">
<dt><strong>FIXME</strong>::</dt><dd><p>cannot explain this… do not know what it is myself. This is taken from sender.
in a subscriber, if it is set… will it download? or will it assume it is local?
in a sender.</p>
</dd>
</dl>
</section>
<section id="inline-boolean-default-false">
<h5><a class="toc-backref" href="#id112">inline &lt;boolean&gt; (default: False)</a><a class="headerlink" href="#inline-boolean-default-false" title="Permalink to this headline">¶</a></h5>
<p>When posting messages, The <strong>inline</strong> option is used to have the file content
included in the post. This can be efficient when sending small files over high
latency links, a number of round trips can be saved by avoiding the retrieval
of the data using the URL.  One should only inline relatively small files,
so when <strong>inline</strong> is active, only files smaller than <strong>inline_max</strong> bytes
(default: 1024) will actually have their content included in the post messages.
If <strong>inline_only</strong> is set, and a file is larger than inline_max, the file
will not be posted.</p>
</section>
<section id="inplace-boolean-default-on">
<h5><a class="toc-backref" href="#id113">inplace &lt;boolean&gt; (default: On)</a><a class="headerlink" href="#inplace-boolean-default-on" title="Permalink to this headline">¶</a></h5>
<p>Large files may be sent as a series of parts, rather than all at once.
When downloading, if <strong>inplace</strong> is true, these parts will be appended to the file
in an orderly fashion. Each part, after it is inserted in the file, is announced to subscribers.
This can be set to false for some deployments of sarracenia where one pump will
only ever see a few parts, and not the entirety, of multi-part files.</p>
<p>The <strong>inplace</strong> option defaults to True.
Depending of <strong>inplace</strong> and if the message was a part, the path can
change again (adding a part suffix if necessary).</p>
</section>
<section id="outlet-post-json-url-default-post">
<h5><a class="toc-backref" href="#id114">outlet post|json|url (default: post)</a><a class="headerlink" href="#outlet-post-json-url-default-post" title="Permalink to this headline">¶</a></h5>
<p>The <strong>outlet</strong> option is used to allow writing of posts to file instead of
posting to a broker. The valid argument values are:</p>
<p><strong>post:</strong></p>
<blockquote>
<div><p>post messages to an post_exchange</p>
<p><strong>post_broker amqp{s}://&lt;user&gt;:&lt;pw&gt;&#64;&lt;brokerhost&gt;[:port]/&lt;vhost&gt;</strong>
<strong>post_exchange     &lt;name&gt;         (MANDATORY)</strong>
<strong>post_topicPrefix &lt;string&gt;       (default: “v03”)</strong>
<strong>on_post           &lt;script&gt;       (default: None)</strong></p>
<p>The <strong>post_broker</strong> defaults to the input broker if not provided.
Just set it to another broker if you want to send the notifications
elsewhere.</p>
<p>The <strong>post_exchange</strong> must be set by the user. This is the exchange under
which the notifications will be posted.</p>
</div></blockquote>
<p><strong>json:</strong></p>
<blockquote>
<div><p>write each message to standard output, one per line in the same json format used for
queue save/restore by the python implementation.</p>
</div></blockquote>
<p><strong>url:</strong></p>
<blockquote>
<div><p>just output the retrieval URL to standard output.</p>
</div></blockquote>
<p>FIXME: The <strong>outlet</strong> option came from the C implementation ( <em>sr_cpump</em>  ) and it has not
been used much in the python implementation.</p>
</section>
<section id="overwrite-boolean-default-off">
<h5><a class="toc-backref" href="#id115">overwrite &lt;boolean&gt; (default: off)</a><a class="headerlink" href="#overwrite-boolean-default-off" title="Permalink to this headline">¶</a></h5>
<p>The  <strong>overwrite</strong>  option,if set to false, avoid unnecessary downloads under these conditions :</p>
<p>1- the file to be downloaded is already on the user’s file system at the right place and</p>
<p>2- the checksum of the amqp message matched the one of the file.</p>
<p>The default is False.</p>
</section>
<section id="discard-boolean-default-off">
<h5><a class="toc-backref" href="#id116">discard &lt;boolean&gt; (default: off)</a><a class="headerlink" href="#discard-boolean-default-off" title="Permalink to this headline">¶</a></h5>
<p>The  <strong>discard</strong>  option,if set to true, deletes the file once downloaded. This option can be
usefull when debugging or testing a configuration.</p>
</section>
<section id="source-from-exchange-boolean-default-off">
<h5><a class="toc-backref" href="#id117">source_from_exchange &lt;boolean&gt; (default: off)</a><a class="headerlink" href="#source-from-exchange-boolean-default-off" title="Permalink to this headline">¶</a></h5>
<p>The <strong>source_from_exchange</strong> option is mainly for use by administrators.
If messages received are posted directly from a source, the exchange used
is ‘xs_&lt;brokerSourceUsername&gt;’. Such messages could be missing <em>source</em> and <em>from_cluster</em>
headings, or a malicious user may set the values incorrectly.
To protect against both problems, administrators should set the <strong>source_from_exchange</strong> option.</p>
<p>When the option is set, values in the message for the <em>source</em> and <em>from_cluster</em> headers will then be overridden:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>       <span class="o">=</span> <span class="o">&lt;</span><span class="n">brokerUser</span><span class="o">&gt;</span>
<span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;from_cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster</span>
</pre></div>
</div>
<p>replacing any values present in the message. This setting should always be used when ingesting data from a
user exchange. These fields are used to return reports to the origin of injected data.
It is commonly combined with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>*mirror true*
*source_from_exchange true*
*directory ${PBD}/${YYYYMMDD}/${SOURCE}*
</pre></div>
</div>
<p>To have data arrive in the standard format tree.</p>
</section>
<section id="housekeeping-count-default-300-seconds">
<h5><a class="toc-backref" href="#id118">housekeeping &lt;count&gt; (default: 300 seconds)</a><a class="headerlink" href="#housekeeping-count-default-300-seconds" title="Permalink to this headline">¶</a></h5>
<p>The <strong>housekeeping</strong> option sets how often to execute periodic processing as determined by
the list of on_housekeeping plugins. By default, it prints a log message every houskeeping interval.</p>
</section>
<section id="shim-defer-posting-to-exit-experimental">
<h5><a class="toc-backref" href="#id119">shim_defer_posting_to_exit (EXPERIMENTAL)</a><a class="headerlink" href="#shim-defer-posting-to-exit-experimental" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>(option specific to libsrshim)
Postpones file posting until the process exits.
In cases where the same file is repeatedly opened and appended to, this
setting can avoid redundant posts.  (default: False)</p>
</div></blockquote>
</section>
<section id="shim-post-minterval-interval-experimental">
<h5><a class="toc-backref" href="#id120">shim_post_minterval <em>interval</em> (EXPERIMENTAL)</a><a class="headerlink" href="#shim-post-minterval-interval-experimental" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>(option specific to libsrshim)
If a file is opened for writing and closed multiple times within the interval,
it will only be posted once. When a file is written to many times, particularly
in a shell script, it makes for many posts, and shell script affects performance.
subscribers will not be able to make copies quickly enough in any event, so
there is little benefit, in say, 100 posts of the same file in the same second.
It is wise set an upper limit on the frequency of posting a given file. (default: 5s)
Note: if a file is still open, or has been closed after its previous post, then
during process exit processing it will be posted again, even if the interval
is not respected, in order to provide the most accurate final post.</p>
</div></blockquote>
</section>
<section id="shim-skip-parent-open-files-experimental">
<h5><a class="toc-backref" href="#id121">shim_skip_parent_open_files (EXPERIMENTAL)</a><a class="headerlink" href="#shim-skip-parent-open-files-experimental" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div><p>(option specific to libsrshim)
The shim_skip_ppid_open_files option means that a process checks
whether the parent process has the same file open, and does not
post if that is the case. (default: True)</p>
</div></blockquote>
</section>
<section id="suppress-duplicates-off-on-999-smhdw-default-off">
<h5><a class="toc-backref" href="#id122">suppress_duplicates &lt;off|on|999[smhdw]&gt; (default: off)</a><a class="headerlink" href="#suppress-duplicates-off-on-999-smhdw-default-off" title="Permalink to this headline">¶</a></h5>
<p>When <strong>suppress_duplicates</strong> (also <strong>cache</strong> ) is set to a non-zero time interval, each new message
is compared against ones received within that interval, to see if it is a duplicate.
Duplicates are not processed further. What is a duplicate? A file with the same name (including
parts header) and checksum. Every <em>hearbeat</em> interval, a cleanup process looks for files in the
cache that have not been referenced in <strong>cache</strong> seconds, and deletes them, in order to keep
the cache size limited. Different settings are appropriate for different use cases.</p>
<p>A raw integer interval is in seconds, if the suffix m,h,d, or w are used, then the interval
is in minutes, hours, days, or weeks. After the interval expires the contents are
dropped, so duplicates separated by a large enough interval will get through.
A value of 1d (day) or 1w (week) can be appropriate.  Setting the option without specifying
a time will result in 300 seconds (or 5 minutes) being the expiry interval.</p>
<p><strong>Use of the cache is incompatible with the default *parts 0* strategy</strong>, one must specify an
alternate strategy.  One must use either a fixed blocksize, or always never partition files.
One must avoid the dynamic algorithm that will change the partition size used as a file grows.</p>
<p><strong>Note that the duplicate suppresion store is local to each instance</strong>. When N
instances share a queue, the first time a posting is received, it could be
picked by one instance, and if a duplicate one is received it would likely
be picked up by another instance. <strong>For effective duplicate suppression with instances</strong>,
one must <strong>deploy two layers of subscribers</strong>. Use
a <strong>first layer of subscribers (sr_shovels)</strong> with duplicate suppression turned
off and output with <em>post_exchange_split</em>, which route posts by checksum to
a <strong>second layer of subscibers (sr_winnow) whose duplicate suppression caches are active.</strong></p>
</section>
<section id="suppress-duplicates-basis-data-name-path-default-path">
<h5><a class="toc-backref" href="#id123">suppress_duplicates_basis &lt;data|name|path&gt; (default: path)</a><a class="headerlink" href="#suppress-duplicates-basis-data-name-path-default-path" title="Permalink to this headline">¶</a></h5>
<p>A keyword option (alternative: <em>cache_basis</em> ) to identify which files are compared for
duplicate suppression purposes. Normally, the duplicate suppression uses the entire path
to identify files which have not changed. This allows for files with identical
content to be posted in different directories and not be suppressed. In some
cases, suppression of identical files should be done regardless of where in
the tree the file resides.  Set ‘name’ for files of identical name, but in
different directories to be considered duplicates. Set to ‘data’ for any file,
regardless of name, to be considered a duplicate if the checksum matches.</p>
<p>This is implemented as an alias for:</p>
<blockquote>
<div><p>callback_prepend nodupe.name</p>
</div></blockquote>
<p>or:</p>
<blockquote>
<div><p>callback_prepend nodupe.data</p>
</div></blockquote>
</section>
<section id="kbytes-ps-count-default-0">
<h5><a class="toc-backref" href="#id124">kbytes_ps &lt;count&gt; (default: 0)</a><a class="headerlink" href="#kbytes-ps-count-default-0" title="Permalink to this headline">¶</a></h5>
<p><strong>kbytes_ps</strong> is greater than 0, the process attempts to respect this delivery
speed in kilobytes per second… ftp,ftps,or sftp)</p>
<p><strong>FIXME</strong>: kbytes_ps… only implemented by sender? or subscriber as well, data only, or messages also?</p>
</section>
<section id="messagecountmax-count-default-0">
<h5><a class="toc-backref" href="#id125">messageCountMax &lt;count&gt; (default: 0)</a><a class="headerlink" href="#messagecountmax-count-default-0" title="Permalink to this headline">¶</a></h5>
<p>If <strong>messageCountMax</strong> is greater than zero, the flow will exit after processing the given
number of messages.  This is normally used only for debugging.</p>
</section>
<section id="messageratemax-float-default-0">
<h5><a class="toc-backref" href="#id126">messageRateMax &lt;float&gt; (default: 0)</a><a class="headerlink" href="#messageratemax-float-default-0" title="Permalink to this headline">¶</a></h5>
<p>if <strong>messageRateMax</strong> is greater than zero, the flow attempts to respect this delivery
speed in terms of messages per second. Note that the throttle is on messages obtained or generated
per second, prior to accept/reject filtering. the flow will sleep to limit the processing rate.</p>
</section>
<section id="messageratemin-float-default-0">
<h5><a class="toc-backref" href="#id127">messageRateMin &lt;float&gt; (default: 0)</a><a class="headerlink" href="#messageratemin-float-default-0" title="Permalink to this headline">¶</a></h5>
<p>if <strong>messageRateMin</strong> is greater than zero, and the flow detected is lower than this rate,
a warning message will be produced:</p>
</section>
<section id="timecopy-default-on">
<h5><a class="toc-backref" href="#id128">timeCopy (default: on)</a><a class="headerlink" href="#timecopy-default-on" title="Permalink to this headline">¶</a></h5>
<p>On unix-like systems, when the <em>ls</em> commend or a file browser shows modification or
access times, it is a display of the posix <em>st_atime</em>, and <em>st_ctime</em> elements of a
struct struct returned by stat(2) call.  When <em>timeCopy</em> is on, headers
reflecting these values in the messages are used to restore the access and modification
times respectively on the subscriber system. To document delay in file reception,
this option can be turned off, and then file times on source and destination compared.</p>
<p>When set in a posting component, it has the effect of eliding the <em>atime</em> and <em>mtime</em>
headers from the messages.</p>
</section>
<section id="permdefault-permdirdefault-permlog-permcopy">
<h5><a class="toc-backref" href="#id129">permDefault, permDirDefault, permLog, permCopy</a><a class="headerlink" href="#permdefault-permdirdefault-permlog-permcopy" title="Permalink to this headline">¶</a></h5>
<p>Permission bits on the destination files written are controlled by the <em>permCopy</em> directives.
<em>permCopy</em> will apply the mode permissions posted by the source of the file.
If no source mode is available, the <em>permDefault</em> will be applied to files, and the
<em>permLog</em> will be applied to directories. If no default is specified,
then the operating system  defaults (on linux, controlled by umask settings)
will determine file permissions. (Note that the <em>chmod</em> option is interpreted as a synonym
for <em>permDefault</em>, and <em>chmod_dir</em> is a synonym for <em>permDirDefault</em>).</p>
<p>When set in a posting component, it has the effect of eliding the <em>mode</em>
header from the messages.</p>
</section>
<section id="tls-rigour-default-medium">
<h5><a class="toc-backref" href="#id130">tls_rigour (default: medium)</a><a class="headerlink" href="#tls-rigour-default-medium" title="Permalink to this headline">¶</a></h5>
<p>tls_rigour can be set to: <em>lax, medium, or strict</em>, and gives a hint to the
application of how to configure TLS connections. TLS, or Transport Level
Security (used to be called Secure Socket Layer (SSL)) is the wrapping of
normal TCP sockets in standard encryption. There are many aspects of TLS
negotiations, hostname checking, Certificate checking, validation, choice of
ciphers. What is considered secure evolves over time, so settings which, a few
years ago, were considered secure, are currently aggressively deprecated. This
situation naturally leads to difficulties in communication due to different
levels of compliance with whatever is currently defined as rigourous encryption.</p>
<p>If a site being connected to, has, for example, and expired certificate, and
it is nevertheless necessary to use it, then set tls_rigour to <em>lax</em> and
the connection should succeed regardless.</p>
</section>
<section id="xattr-disable-default-off">
<h5><a class="toc-backref" href="#id131">xattr_disable (default: off)</a><a class="headerlink" href="#xattr-disable-default-off" title="Permalink to this headline">¶</a></h5>
<p>By default, on receipt of files, the mtime and checksum are written to a file’s
extended attributes (on unix/linux/mac) or to alternate data stream called <em>sr_.json</em>
(on windows on NTFS.) This can save re-reading the file to re-calculate the checksum.
Some use cases may not want files to have Alternate Data Streams or extended
attributes to be used.</p>
</section>
</section>
<section id="delivery-completion-inflight">
<h4><a class="toc-backref" href="#id132">Delivery Completion (inflight)</a><a class="headerlink" href="#delivery-completion-inflight" title="Permalink to this headline">¶</a></h4>
<p>Failing to properly set file completion protocols is a common source of intermittent and
difficult-to-diagnose file transfer issues. For reliable file transfers, it is
critical that both the sender and receiver agree on how to represent a file that isn’t complete.
The <em>inflight</em> option (meaning a file is <em>in flight</em> between the sender and the receiver) supports
many protocols appropriate for different situations:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 43%" />
<col style="width: 42%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head" colspan="3"><p>Delivery Completion Protocols (in Order of Preference)</p></th>
</tr>
<tr class="row-even"><th class="head"><p>Method</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Application</p></th>
</tr>
</thead>
<tbody>
<tr class="row-odd"><td><p>NONE</p></td>
<td><p>File sent with right name.
Send <a class="reference external" href="sr3_post.7.rst">sr3_post(7)</a>
by AMQP after file is complete.</p>
<blockquote>
<div><ul class="simple">
<li><p>fewer round trips (no renames)</p></li>
<li><p>least overhead / highest speed</p></li>
</ul>
</div></blockquote>
</td>
<td><p>Sending to Sarracenia, and
post only when file is complete</p>
<dl class="simple">
<dt>(Best when available)</dt><dd><ul class="simple">
<li><p>Default on sr_sarra.</p></li>
<li><p>Default on sr_subscribe and sender
when post_broker is set.</p></li>
</ul>
</dd>
</dl>
</td>
</tr>
<tr class="row-even"><td><p>.tmp
(Suffix)</p></td>
<td><p>Files transferred with a <em>.tmp</em> suffix.
When complete, renamed without suffix.
Actual suffix is settable.</p>
<blockquote>
<div><ul class="simple">
<li><p>requires extra round trips for
rename (a little slower)</p></li>
</ul>
</div></blockquote>
</td>
<td><p>sending to most other systems
(.tmp support built-in)
Use to send to Sundew</p>
<dl class="simple">
<dt>(usually a good choice)</dt><dd><ul class="simple">
<li><p>default when no post broker set</p></li>
</ul>
</dd>
</dl>
</td>
</tr>
<tr class="row-odd"><td><p>tmp/
(subdir)</p></td>
<td><p>Files transferred to a subdir.
When complete, renamed to parent dir.
Actual subdir is settable.</p>
<p>same performance as Suffix method.</p>
</td>
<td><p>sending to some other systems</p></td>
</tr>
<tr class="row-even"><td><p>.
(Prefix)</p></td>
<td><p>Use Linux convention to <em>hide</em> files.
Prefix names with ‘.’
that need that. (compatibility)
same performance as Suffix method.</p></td>
<td><p>Sending to systems that
do not support suffix.</p></td>
</tr>
<tr class="row-odd"><td><p>number
(mtime)</p></td>
<td><p>Minimum age (modification time)
of the file before it is considered
complete.</p>
<p>Adds delay in every transfer.
Vulnerable to network failures.
Vulnerable to clock skew.</p>
</td>
<td><p>Last choice
guaranteed delay added</p>
<p>Receiving from uncooperative
sources.</p>
<p>(ok choice with PDS)</p>
</td>
</tr>
</tbody>
</table>
<p>By default ( when no <em>inflight</em> option is given ), if the post_broker is set, then a value of NONE
is used because it is assumed that it is delivering to another broker. If no post_broker
is set, the value of ‘.tmp’ is assumed as the best option.</p>
<p>NOTES:</p>
<blockquote>
<div><p>On versions of sr_sender prior to 2.18, the default was NONE, but was documented as ‘.tmp’
To ensure compatibility with later versions, it is likely better to explicitly write
the <em>inflight</em> setting.</p>
<p><em>inflight</em> was renamed from the old <em>lock</em> option in January 2017. For compatibility with
older versions, can use <em>lock</em>, but name is deprecated.</p>
<p>The old <em>PDS</em> software (which predates MetPX Sundew) only supports FTP. The completion protocol
used by <em>PDS</em> was to send the file with permission 000 initially, and then chmod it to a
readable file. This cannot be implemented with SFTP protocol, and is not supported at all
by Sarracenia.</p>
</div></blockquote>
<section id="frequent-configuration-errors">
<h5><a class="toc-backref" href="#id133">Frequent Configuration Errors</a><a class="headerlink" href="#frequent-configuration-errors" title="Permalink to this headline">¶</a></h5>
<p><strong>Setting NONE when sending to Sundew.</strong></p>
<blockquote>
<div><p>The proper setting here is ‘.tmp’.  Without it, almost all files will get through correctly,
but incomplete files will occasionally picked up by Sundew.</p>
</div></blockquote>
<p><strong>Using mtime method to receive from Sundew or Sarracenia:</strong></p>
<blockquote>
<div><p>Using mtime is last resort. This approach injects delay and should only be used when one
has no influence to have the other end of the transfer use a better method.</p>
<p>mtime is vulnerable to systems whose clocks differ (causing incomplete files to be picked up.)</p>
<p>mtime is vulnerable to slow transfers, where incomplete files can be picked up because of a
networking issue interrupting or delaying transfers.</p>
<p>Sources may not to include mtime data in their posts ( <em>timeCopy</em> option on post.)</p>
</div></blockquote>
<p><strong>Setting NONE when delivering to non-Sarracenia destination.</strong></p>
<blockquote>
<div><p>NONE is to be used when there is some other means to figure out if a file is delivered.
For example, when sending to another pump, the sender will post the announcement to
the destination after the file is complete, so there is no danger of it being
picked up early.</p>
<p>When used inappropriately, there will occasionally be incomplete files delivered.</p>
</div></blockquote>
</section>
</section>
</section>
<section id="on-windows">
<h3><a class="toc-backref" href="#id134">On Windows</a><a class="headerlink" href="#on-windows" title="Permalink to this headline">¶</a></h3>
<p>The python tools are ubiquitously installed with the operating system on Linux,
and installation methods are somewhat more consistent there.  On Windows,
there is a wide variety of methods of installation, stemming from the
variety of python distributions available. The various methods conflict, to the
extent that using the .exe files, as one would expect using winpython, does not
work at all when installed using Anaconda.</p>
<p>A setting is provided <em>windows_run</em> to allow selection. the choices are:</p>
<ul class="simple">
<li><p>exe - run sr_subscribe.exe as installed by pip (what one would expect to start)</p></li>
<li><p>pyw - run the pythonw.exe executable with sr_subscribe.py (or sr_subscribe-script.py)
as the argument. (sometimes needed to have the component continue to run
after calling process is terminated.</p></li>
<li><p>py - run the python.exe executable with sr_subscribe.py (or sr_subscribe-script.py)
as the argument. (sometimes also works.)</p></li>
</ul>
</section>
<section id="periodic-processing">
<h3><a class="toc-backref" href="#id135">PERIODIC PROCESSING</a><a class="headerlink" href="#periodic-processing" title="Permalink to this headline">¶</a></h3>
<p>Most processing occurs on receipt of a message, but there is some periodic maintenance
work that happens every <em>housekeeping</em> interval (default is 5 minutes.)  Evey housekeeping, all of the
configured <em>on_housekeeping</em> plugins are run. By default there are three present:</p>
<blockquote>
<div><ul class="simple">
<li><p>log - prints “housekeeping” in the log.</p></li>
<li><p>nodupe - ages out old entries in the reception cache, to minimize its size.</p></li>
<li><p>memory - checks the process memory usage, and restart if too big.</p></li>
</ul>
</div></blockquote>
<p>The log will contain messages from all three plugins every housekeeping interval, and
if additional periodic processing is needed, the user can configure addition
plugins to run with the <em>on_housekeeping</em> option.</p>
<section id="sanity-log-dead-interval-default-1-5-housekeeping">
<h4><a class="toc-backref" href="#id136">sanity_log_dead &lt;interval&gt; (default: 1.5*housekeeping)</a><a class="headerlink" href="#sanity-log-dead-interval-default-1-5-housekeeping" title="Permalink to this headline">¶</a></h4>
<p>The <strong>sanity_log_dead</strong> option sets how long to consider too long before restarting
a component.</p>
</section>
<section id="suppress-duplicates-off-on-999-default-off">
<h4><a class="toc-backref" href="#id137">suppress_duplicates &lt;off|on|999&gt; (default: off)</a><a class="headerlink" href="#suppress-duplicates-off-on-999-default-off" title="Permalink to this headline">¶</a></h4>
<p>The cleanup of expired elements in the duplicate suppression store happens at
each housekeeping.</p>
</section>
</section>
<section id="error-recovery">
<h3><a class="toc-backref" href="#id138">ERROR RECOVERY</a><a class="headerlink" href="#error-recovery" title="Permalink to this headline">¶</a></h3>
<p>The tools are meant to work well unattended, and so when transient errors occur, they do
their best to recover elegantly.  There are timeouts on all operations, and when a failure
is detected, the problem is noted for retry.  Errors can happen at many times:</p>
<blockquote>
<div><ul class="simple">
<li><p>Establishing a connection to the broker.</p></li>
<li><p>losing a connection to the broker</p></li>
<li><p>establishing a connection to the file server for a file (for download or upload.)</p></li>
<li><p>losing a connection to the server.</p></li>
<li><p>during data transfer.</p></li>
</ul>
</div></blockquote>
<p>Initially, the programs try to download (or send) a file a fixed number (<em>attempts</em>, default: 3) times.
If all three attempts to process the file are unsuccessful, then the file is placed in an instance’s
retry file. The program then continues processing of new items. When there are no new items to
process, the program looks for a file to process in the retry queue. It then checks if the file
is so old that it is beyond the <em>retry_expire</em> (default: 2 days). If the file is not expired, then
it triggers a new round of attempts at processing the file. If the attempts fail, it goes back
on the retry queue.</p>
<p>This algorithm ensures that programs do not get stuck on a single bad product that prevents
the rest of the queue from being processed, and allows for reasonable, gradual recovery of
service, allowing fresh data to flow preferentially, and sending old data opportunistically
when there are gaps.</p>
<p>While fast processing of good data is very desirable, it is important to slow down when errors
start occurring. Often errors are load related, and retrying quickly will just make it worse.
Sarracenia uses exponential back-off in many points to avoid overloading a server when there
are errors. The back-off can accumulate to the point where retries could be separated by a minute
or two. Once the server begins responding normally again, the programs will return to normal
processing speed.</p>
</section>
<section id="examples">
<h3><a class="toc-backref" href="#id139">EXAMPLES</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>Here is a short complete example configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">broker</span> <span class="n">amqps</span><span class="p">:</span><span class="o">//</span><span class="n">dd</span><span class="o">.</span><span class="n">weather</span><span class="o">.</span><span class="n">gc</span><span class="o">.</span><span class="n">ca</span><span class="o">/</span>

<span class="n">subtopic</span> <span class="n">model_gem_global</span><span class="mf">.25</span><span class="n">km</span><span class="o">.</span><span class="n">grib2</span><span class="o">.</span><span class="c1">#</span>
<span class="n">accept</span> <span class="o">.*</span>
</pre></div>
</div>
<p>This above file will connect to the dd.weather.gc.ca broker, connecting as
anonymous with password anonymous (defaults) to obtain announcements about
files in the <a class="reference external" href="http://dd.weather.gc.ca/model_gem_global/25km/grib2">http://dd.weather.gc.ca/model_gem_global/25km/grib2</a> directory.
All files which arrive in that directory or below it will be downloaded
into the current directory (or just printed to standard output if -n option
was specified.)</p>
<p>A variety of example configuration files are available here:</p>
<blockquote>
<div><p><a class="reference external" href="https://github.com/MetPX/sarracenia/tree/master/sarra/examples">https://github.com/MetPX/sarracenia/tree/master/sarra/examples</a></p>
</div></blockquote>
</section>
<section id="naming-exchanges-and-queues">
<h3><a class="toc-backref" href="#id140">NAMING EXCHANGES AND QUEUES</a><a class="headerlink" href="#naming-exchanges-and-queues" title="Permalink to this headline">¶</a></h3>
<p>While in most common cases, a good value is generated by the application, in some cases
there may be a need to override those choices with an explicit user specification.
To do that, one needs to be aware of the rules for naming queues:</p>
<ol class="arabic simple">
<li><p>queue names start with q_</p></li>
<li><p>this is followed by &lt;amqpUserName&gt; (the owner/user of the queue’s broker username)</p></li>
<li><p>followed by a second underscore ( _ )</p></li>
<li><p>followed by a string of the user’s choice.</p></li>
</ol>
<p>The total length of the queue name is limited to 255 bytes of UTF-8 characters.</p>
<p>The same applies for exchanges.  The rules for those are:</p>
<ol class="arabic simple">
<li><p>Exchange names start with x</p></li>
<li><p>Exchanges that end in <em>public</em> are accessible (for reading) by any authenticated user.</p></li>
<li><p>Users are permitted to create exchanges with the pattern:  xs_&lt;amqpUserName&gt;_&lt;whatever&gt; such exchanges can be written to only by that user.</p></li>
<li><p>The system (sr_audit or administrators) create the xr_&lt;amqpUserName&gt; exchange as a place to send reports for a given user. It is only readable by that user.</p></li>
<li><p>Administrative users (admin or feeder roles) can post or subscribe anywhere.</p></li>
</ol>
<p>For example, xpublic does not have xs_ and a username pattern, so it can only be posted to by admin or feeder users.
Since it ends in public, any user can bind to it to subscribe to messages posted.
Users can create exchanges such as xs_&lt;amqpUserName&gt;_public which can be written to by that user (by rule 3),
and read by others (by rule 2.) A description of the conventional flow of messages through exchanges on a pump.
Subscribers usually bind to the xpublic exchange to get the main data feed. This is the default in sr_subscribe.</p>
<p>Another example, a user named Alice will have at least two exchanges:</p>
<blockquote>
<div><ul class="simple">
<li><p>xs_Alice the exhange where Alice posts her file notifications and report messages (via many tools).</p></li>
<li><p>xr_Alice the exchange where Alice reads her report messages from (via sr_report).</p></li>
<li><p>Alice can create a new exchange by just posting to it (with sr3_post or sr_cpost) if it meets the naming rules.</p></li>
</ul>
</div></blockquote>
<p>Usually an sr_sarra run by a pump administrator will read from an exchange such as xs_Alice_mydata,
retrieve the data corresponding to Alice´s <em>post</em> message, and make it available on the pump,
by re-announcing it on the xpublic exchange.</p>
</section>
<section id="queues-and-multiple-streams">
<h3><a class="toc-backref" href="#id141">QUEUES and MULTIPLE STREAMS</a><a class="headerlink" href="#queues-and-multiple-streams" title="Permalink to this headline">¶</a></h3>
<p>When executed,  <strong>sr_subscribe</strong>  chooses a queue name, which it writes
to a file named after the configuration file given as an argument to <strong>sr_subscribe</strong>
with a .queue suffix ( .”configfile”.queue).
If sr_subscribe is stopped, the posted messages continue to accumulate on the
broker in the queue.  When the program is restarted, it uses the queuename
stored in that file to connect to the same queue, and not lose any messages.</p>
<p>File downloads can be parallelized by running multiple sr_subscribes using
the same queue.  The processes will share the queue and each download
part of what has been selected.  Simply launch multiple instances
of sr_subscribe in the same user/directory using the same configuration file.</p>
<p>You can also run several sr_subscribe with different configuration files to
have multiple download streams delivering into the the same directory,
and that download stream can be multi-streamed as well.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While the brokers keep the queues available for some time, Queues take resources on
brokers, and are cleaned up from time to time.  A queue which is not accessed for
a long (implementation dependent) period will be destroyed.  A queue which is not
accessed and has too many (implementation defined) files queued will be destroyed.
Processes which die should be restarted within a reasonable period of time to avoid
loss of notifications.</p>
</div>
</section>
<section id="report-back-and-report-exchange">
<h3><a class="toc-backref" href="#id142">report_back and report_exchange</a><a class="headerlink" href="#report-back-and-report-exchange" title="Permalink to this headline">¶</a></h3>
<p>For each download, by default, an amqp report message is sent back to the broker.
This is done with option :</p>
<ul class="simple">
<li><p><strong>report_back &lt;boolean&gt;        (default: True)</strong></p></li>
<li><p><strong>report_exchange &lt;report_exchangename&gt; (default: xreport|xs_*username* )</strong></p></li>
</ul>
<p>When a report is generated, it is sent to the configured <em>report_exchange</em>. Administrative
components post directly to <em>xreport</em>, whereas user components post to their own
exchanges (xs_*username*). The report daemons then copy the messages to <em>xreport</em> after validation.</p>
<p>These reports are used for delivery tuning and for data sources to generate statistical information.
Set this option to <strong>False</strong>, to prevent generation of reports.</p>
</section>
<section id="instances">
<h3><a class="toc-backref" href="#id143">INSTANCES</a><a class="headerlink" href="#instances" title="Permalink to this headline">¶</a></h3>
<p>Sometimes one instance of a component and configuration is not enough to process &amp; send all available notifications.</p>
<p><strong>instances      &lt;integer&gt;     (default:1)</strong></p>
<p>The instance option allows launching several instances of a component and configuration.
When running sr_sender for example, a number of runtime files are created.
In the ~/.cache/sarra/sender/configName directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>A .sr_sender_configname.state         is created, containing the number instances.
A .sr_sender_configname_$instance.pid is created, containing the PID  of $instance process.
</pre></div>
</div>
<p>In directory ~/.cache/sarra/log:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>A .sr_sender_configname_$instance.log  is created as a log of $instance process.
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>known bug in the management interface <cite>sr &lt;sr.8.rst&gt;_</cite>  means that instance should
always be in the .conf file (not a .inc) and should always be an number
(not a substituted variable or other more complex value.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>FIXME: indicate Windows location also… dot files on Windows?</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>While the brokers keep the queues available for some time, Queues take resources on
brokers, and are cleaned up from time to time.  A queue which is not
accessed and has too many (implementation defined) files queued will be destroyed.
Processes which die should be restarted within a reasonable period of time to avoid
loss of notifications.  A queue which is not accessed for a long (implementation dependent)
period will be destroyed.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<dl class="simple">
<dt>FIXME  The last sentence is not really right…sr_audit does track the queues’ age.</dt><dd><p>sr_audit acts when a queue gets to the max_queue_size and not running.</p>
</dd>
</dl>
</div>
<section id="vip-active-passive-options">
<h4><a class="toc-backref" href="#id144">vip - ACTIVE/PASSIVE OPTIONS</a><a class="headerlink" href="#vip-active-passive-options" title="Permalink to this headline">¶</a></h4>
<p><strong>sr_subscribe</strong> can be used on a single server node, or multiple nodes
could share responsibility. Some other, separately configured, high availability
software presents a <strong>vip</strong> (virtual ip) on the active server. Should
the server go down, the <strong>vip</strong> is moved on another server.
Both servers would run <strong>sr_subscribe</strong>. It is for that reason that the
following options were implemented:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>vip          &lt;string&gt;          (None)</strong></p></li>
</ul>
</div></blockquote>
<p>When you run only one <strong>sr_subscribe</strong> on one server, these options are not set,
and sr_subscribe will run in ‘standalone mode’.</p>
<p>In the case of clustered brokers, you would set the options for the
moving vip.</p>
<p><strong>vip 153.14.126.3</strong></p>
<p>When <strong>sr_subscribe</strong> does not find the vip, it sleeps for 5 seconds and retries.
If it does, it consumes and processes a message and than rechecks for the vip.</p>
</section>
</section>
<section id="posting-options">
<h3><a class="toc-backref" href="#id145">POSTING OPTIONS</a><a class="headerlink" href="#posting-options" title="Permalink to this headline">¶</a></h3>
<p>When advertising files downloaded for downstream consumers, one must set
the rabbitmq configuration for an output broker.</p>
<p>The post_broker option sets all the credential information to connect to the
output <strong>AMQP</strong> broker.</p>
<p><strong>post_broker amqp{s}://&lt;user&gt;:&lt;pw&gt;&#64;&lt;brokerhost&gt;[:port]/&lt;vhost&gt;</strong></p>
<p>Once connected to the source AMQP broker, the program builds notifications after
the download of a file has occurred. To build the notification and send it to
the next hop broker, the user sets these options :</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>[–blocksize &lt;value&gt;]            (default: 0 (auto))</strong></p></li>
<li><p><strong>[–outlet &lt;post|json|url&gt;]       (default: post)</strong></p></li>
<li><p><strong>[-pbd|–post_baseDir &lt;path&gt;]    (optional)</strong></p></li>
<li><p><strong>[-ptp|–post_topicPrefix &lt;pfx&gt;] (default: ‘v03’)</strong></p></li>
<li><p><strong>post_exchange     &lt;name&gt;         (default: xpublic)</strong></p></li>
<li><p><strong>post_exchange_split   &lt;number&gt;   (default: 0)</strong></p></li>
<li><p><strong>post_baseUrl          &lt;url&gt;     (MANDATORY)</strong></p></li>
<li><p><strong>on_post           &lt;script&gt;       (default: None)</strong></p></li>
</ul>
</div></blockquote>
<section id="blocksize-value-default-0-auto">
<h4><a class="toc-backref" href="#id146">[–blocksize &lt;value&gt;] (default: 0 (auto))</a><a class="headerlink" href="#blocksize-value-default-0-auto" title="Permalink to this headline">¶</a></h4>
<p>This <strong>blocksize</strong> option controls the partitioning strategy used to post files.
The value should be one of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span> <span class="o">-</span> <span class="n">autocompute</span> <span class="n">an</span> <span class="n">appropriate</span> <span class="n">partitioning</span> <span class="n">strategy</span> <span class="p">(</span><span class="n">default</span><span class="p">)</span>
<span class="mi">1</span> <span class="o">-</span> <span class="n">always</span> <span class="n">send</span> <span class="n">entire</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">single</span> <span class="n">part</span><span class="o">.</span>
<span class="o">&lt;</span><span class="n">blocksize</span><span class="o">&gt;</span> <span class="o">-</span> <span class="n">used</span> <span class="n">a</span> <span class="n">fixed</span> <span class="n">partition</span> <span class="n">size</span> <span class="p">(</span><span class="n">example</span> <span class="n">size</span><span class="p">:</span> <span class="mi">1</span><span class="n">M</span> <span class="p">)</span>
</pre></div>
</div>
<p>Files can be announced as multiple parts.  Each part has a separate checksum.
The parts and their checksums are stored in the cache. Partitions can traverse
the network separately, and in parallel.  When files change, transfers are
optimized by only sending parts which have changed.</p>
<p>The <em>outlet</em> option allows the final output to be other than a post.
See <a class="reference external" href="sr3_cpump.1.rst">sr3_cpump(1)</a> for details.</p>
</section>
<section id="pbd-post-basedir-path-optional">
<h4><a class="toc-backref" href="#id147">[-pbd|–post_baseDir &lt;path&gt;] (optional)</a><a class="headerlink" href="#pbd-post-basedir-path-optional" title="Permalink to this headline">¶</a></h4>
<p>The <em>post_baseDir</em> option supplies the directory path that, when combined (or found)
in the given <em>path</em>, gives the local absolute path to the data file to be posted.
The <em>post_baseDir</em> part of the path will be removed from the posted announcement.
For sftp urls it can be appropriate to specify a path relative to a user account.
Example of that usage would be:  -pbd ~user  -url sftp:user&#64;host
For file: url’s, baseDir is usually not appropriate.  To post an absolute path,
omit the -pbd setting, and just specify the complete path as an argument.</p>
</section>
<section id="post-baseurl-url-mandatory">
<h4><a class="toc-backref" href="#id148">post_baseUrl &lt;url&gt; (MANDATORY)</a><a class="headerlink" href="#post-baseurl-url-mandatory" title="Permalink to this headline">¶</a></h4>
<p>The <strong>post_baseUrl</strong> option sets how to get the file… it defines the protocol,
host, port, and optionally, the user. It is best practice to not include
passwords in urls.</p>
</section>
<section id="post-exchange-name-default-xpublic">
<h4><a class="toc-backref" href="#id149">post_exchange &lt;name&gt; (default: xpublic)</a><a class="headerlink" href="#post-exchange-name-default-xpublic" title="Permalink to this headline">¶</a></h4>
<p>The <strong>post_exchange</strong> option set under which exchange the new notification
will be posted.  In most cases it is ‘xpublic’.</p>
<p>Whenever a publish happens for a product, a user can set to trigger a script.
The option <strong>on_post</strong> would be used to do such a setup.</p>
</section>
<section id="post-exchange-split-number-default-0">
<h4><a class="toc-backref" href="#id150">post_exchange_split   &lt;number&gt;   (default: 0)</a><a class="headerlink" href="#post-exchange-split-number-default-0" title="Permalink to this headline">¶</a></h4>
<p>The <strong>post_exchange_split</strong> option appends a two digit suffix resulting from
hashing the last character of the checksum to the post_exchange name,
in order to divide the output amongst a number of exchanges.  This is currently used
in high traffic pumps to allow multiple instances of sr_winnow, which cannot be
instanced in the normal way.  Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">post_exchange_split</span> <span class="mi">5</span>
<span class="n">post_exchange</span> <span class="n">xwinnow</span>
</pre></div>
</div>
<p>will result in posting messages to five exchanges named: xwinnow00, xwinnow01,
xwinnow02, xwinnow03 and xwinnow04, where each exchange will receive only one fifth
of the total flow.</p>
</section>
<section id="remote-configurations">
<h4><a class="toc-backref" href="#id151">Remote Configurations</a><a class="headerlink" href="#remote-configurations" title="Permalink to this headline">¶</a></h4>
<p>One can specify URI’s as configuration files, rather than local files. Example:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>–config http://dd.weather.gc.ca/alerts/doc/cap.conf</strong></p></li>
</ul>
</div></blockquote>
<p>On startup, sr_subscribe checks if the local file cap.conf exists in the
local configuration directory.  If it does, then the file will be read to find
a line like so:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>–remote_config_url http://dd.weather.gc.ca/alerts/doc/cap.conf</strong></p></li>
</ul>
</div></blockquote>
<p>In which case, it will check the remote URL and compare the modification time
of the remote file against the local one. The remote file is not newer, or cannot
be reached, then the component will continue with the local file.</p>
<p>If either the remote file is newer, or there is no local file, it will be downloaded,
and the remote_config_url line will be prepended to it, so that it will continue
to self-update in future.</p>
</section>
</section>
<section id="extensions">
<h3><a class="toc-backref" href="#id152">Extensions</a><a class="headerlink" href="#extensions" title="Permalink to this headline">¶</a></h3>
<p>One can override or add functionality with python scripting.</p>
<p>Sarracenia comes with a variety of example plugins, and uses some to implement base functionality,
such as logging (implemented by default use of msg_log, file_log, post_log plugins):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sr3 list fcb
Provided callback classes: ( /home/peter/Sarracenia/sr3/sarracenia )
flowcb/filter/deleteflowfiles.py flowcb/filter/fdelay.py          flowcb/filter/pclean_f90.py      flowcb/filter/pclean_f92.py
flowcb/gather/file.py            flowcb/gather/message.py         flowcb/line_log.py               flowcb/line_mode.py
flowcb/log.py                    flowcb/nodupe.py                 flowcb/pclean.py                 flowcb/post/message.py
flowcb/retry.py                  flowcb/sample.py                 flowcb/script.py                 flowcb/v2wrapper.py
flowcb/work/rxpipe.py
$
</pre></div>
</div>
<p>Users can place their own scripts in the script sub-directory of their config directory
tree ( on Linux, the ~/.config/sarra/plugins).</p>
<section id="flowcallback-and-flowcallbackprepend-class">
<h4><a class="toc-backref" href="#id153">flowCallback and flowCallbackPrepend &lt;class&gt;</a><a class="headerlink" href="#flowcallback-and-flowcallbackprepend-class" title="Permalink to this headline">¶</a></h4>
<p>The flowCallback directive takes a class to load can scan for entry points as an argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flowCallback</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">Log</span>
</pre></div>
</div>
<p>With this directive in a configuration file, the Log class found in installed package will be used.
That module logs messages <em>after_accept</em> (after messages have passed through the accept/reject masks.)
and the <em>after_work</em> (after the file has been downloaded or sent). Here is the source code
for that callback class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">sarracenia.flowcb</span> <span class="kn">import</span> <span class="n">FlowCB</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Log</span><span class="p">(</span><span class="n">FlowCB</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>

      <span class="c1"># FIXME: should a logging module have a logLevel setting?</span>
      <span class="c1">#        just put in a cookie cutter for now...</span>
      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;logLevel&#39;</span><span class="p">):</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">logLevel</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
      <span class="k">else</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">after_accept</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">incoming</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;accepted: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">msg_dumps</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="p">)</span>

  <span class="k">def</span> <span class="nf">after_work</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worklist</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">worklist</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
          <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;worked successfully: </span><span class="si">%s</span><span class="s2"> &quot;</span> <span class="o">%</span> <span class="n">msg</span><span class="o">.</span><span class="n">dumps</span><span class="p">()</span> <span class="p">)</span>
</pre></div>
</div>
<p>If you have multiple callbacks configured, they will be called in the same order they are
configuration file. components in sr3 are often differentiated by the callbacks configured.
For example, a <em>watch</em> is a flow with sarracenia.flowcb.gather.file.File class that
is used to scan directories. A Common need when a data source is not easily accessed
with python scripts is to use the script callback:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">flowCallbackPrepend</span> <span class="n">sarracenia</span><span class="o">.</span><span class="n">flowcb</span><span class="o">.</span><span class="n">script</span><span class="o">.</span><span class="n">Script</span>

<span class="n">script_gather</span> <span class="n">get_weird_data</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Using the <em>_prepend</em> variant of the <em>flowCallback</em> option, will have the Script callback
class’s entry point, before the File callback… So A script will be executed, and then
the directory will be checked for new files.  Here is part of the Script callback class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">sarracenia.flowcb</span> <span class="kn">import</span> <span class="n">FlowCB</span>
<span class="kn">import</span> <span class="nn">subprocess</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Script</span><span class="p">(</span><span class="n">FlowCB</span><span class="p">):</span>

   <span class="o">.</span>
   <span class="o">.</span>
   <span class="o">.</span>

    <span class="k">def</span> <span class="nf">run_script</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">script</span> <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">script_gather</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;subprocess.run failed err=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Exception details:&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">gather</span><span class="p">(</span><span class="bp">self</span> <span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="p">,</span> <span class="s1">&#39;script_gather&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">script_gather</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_script</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">o</span><span class="o">.</span><span class="n">script_gather</span> <span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>
</pre></div>
</div>
</section>
<section id="integrity">
<h4><a class="toc-backref" href="#id154">Integrity</a><a class="headerlink" href="#integrity" title="Permalink to this headline">¶</a></h4>
<p>One can use the <em>import</em> directive to add new checksum algorithms by sub-classing
sarracenia.integrity.Integrity.</p>
</section>
<section id="transfer">
<h4><a class="toc-backref" href="#id155">Transfer</a><a class="headerlink" href="#transfer" title="Permalink to this headline">¶</a></h4>
<p>One can add support for additional methods of downloading data by sub-classing
sarracenia.transfer.Transfer.</p>
<p>Transfer protocol scripts should be declared using the <strong>import</strong> option.
Aside the targetted built-in function(s), a module <strong>registered_as</strong> that defines
a list of protocols that these functions provide.  Example :</p>
<dl class="simple">
<dt>def registered_as(self) :</dt><dd><p>return [‘ftp’,’ftps’]</p>
</dd>
</dl>
<p>See the <a class="reference external" href="../Explanation/SarraPluginDev.rst">Programming Guide</a> for more information on Extension development.</p>
</section>
</section>
<section id="queue-save-restore">
<h3><a class="toc-backref" href="#id156">Queue Save/Restore</a><a class="headerlink" href="#queue-save-restore" title="Permalink to this headline">¶</a></h3>
<section id="sender-destination-unavailable">
<h4><a class="toc-backref" href="#id157">Sender Destination Unavailable</a><a class="headerlink" href="#sender-destination-unavailable" title="Permalink to this headline">¶</a></h4>
<p>If the server to which the files are being sent is going to be unavailable for
a prolonged period, and there is a large number of messages to send to them, then
the queue will build up on the broker. As the performance of the entire broker
is affected by large queues, one needs to minimize such queues.</p>
<p>The <em>-save</em> and <em>-restore</em> options are used get the messages away from the broker
when too large a queue will certainly build up.
The <em>-save</em> option copies the messages to a (per instance) disk file (in the same directory
that stores state and pid files), as json encoded strings, one per line.
When a queue is building up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr_sender</span> <span class="n">stop</span> <span class="o">&lt;</span><span class="n">config</span><span class="o">&gt;</span>
<span class="n">sr_sender</span> <span class="o">-</span><span class="n">save</span> <span class="n">start</span> <span class="o">&lt;</span><span class="n">config</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>And run the sender in <em>save</em> mode (which continually writes incoming messages to disk)
in the log, a line for each message written to disk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">12</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">51</span><span class="p">,</span><span class="mi">386</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_sender</span> <span class="n">saving</span> <span class="mi">2</span> <span class="n">message</span> <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">peter</span><span class="o">.</span><span class="n">sarra_devdocroot</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">SASP34_LEMM_031630__LEDA_60215</span>
</pre></div>
</div>
<p>Continue in this mode until the absent server is again available.  At that point:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr_sender</span> <span class="n">stop</span> <span class="o">&lt;</span><span class="n">config</span><span class="o">&gt;</span>
<span class="n">sr_sender</span> <span class="o">-</span><span class="n">restore</span> <span class="n">start</span> <span class="o">&lt;</span><span class="n">config</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>While restoring from the disk file, messages like the following will appear in the log:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">02</span><span class="p">,</span><span class="mi">969</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_sender</span> <span class="n">restoring</span> <span class="n">message</span> <span class="mi">29</span> <span class="n">of</span> <span class="mi">34</span><span class="p">:</span> <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">home</span><span class="o">.</span><span class="n">peter</span><span class="o">.</span><span class="n">sarra_devdocroot</span><span class="o">.</span><span class="n">sub</span><span class="o">.</span><span class="n">ON_02GD022_daily_hydrometric</span><span class="o">.</span><span class="n">csv</span>
</pre></div>
</div>
<p>After the last one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">03</span> <span class="mi">12</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">03</span><span class="p">,</span><span class="mi">112</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_sender</span> <span class="n">restore</span> <span class="n">complete</span> <span class="n">deleting</span> <span class="n">save</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">peter</span><span class="o">/.</span><span class="n">cache</span><span class="o">/</span><span class="n">sarra</span><span class="o">/</span><span class="n">sender</span><span class="o">/</span><span class="n">tsource2send</span><span class="o">/</span><span class="n">sr_sender_tsource2send_0000</span><span class="o">.</span><span class="n">save</span>
</pre></div>
</div>
<p>and the sr_sender will function normally thereafter.</p>
</section>
<section id="shovel-save-restore">
<h4><a class="toc-backref" href="#id158">Shovel Save/Restore</a><a class="headerlink" href="#shovel-save-restore" title="Permalink to this headline">¶</a></h4>
<p>If a queue builds up on a broker because a subscriber is unable to process
messages, overall broker performance will suffer, so leaving the queue lying around
is a problem. As an administrator, one could keep a configuration like this
around:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">more</span> <span class="o">~/</span><span class="n">tools</span><span class="o">/</span><span class="n">save</span><span class="o">.</span><span class="n">conf</span>
<span class="n">broker</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span>
<span class="n">topicPrefix</span> <span class="n">v03</span>
<span class="n">exchange</span> <span class="n">xpublic</span>

<span class="n">post_rate_limit</span> <span class="mi">50</span>
<span class="n">on_post</span> <span class="n">post_rate_limit</span>
<span class="n">post_broker</span> <span class="n">amqp</span><span class="p">:</span><span class="o">//</span><span class="n">tfeed</span><span class="nd">@localhost</span><span class="o">/</span>
</pre></div>
</div>
<p>The configuration relies on the use of an administrator or feeder account.
Note the queue which has messages in it, in this case q_tsub.sr_subscribe.t.99524171.43129428. Invoke the shovel in save mode to consume messages from the queue
and save them to disk:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">cd</span> <span class="o">~/</span><span class="n">tools</span>
<span class="o">%</span> <span class="n">sr_shovel</span> <span class="o">-</span><span class="n">save</span> <span class="o">-</span><span class="n">queue</span> <span class="n">q_tsub</span><span class="o">.</span><span class="n">sr_subscribe</span><span class="o">.</span><span class="n">t</span><span class="mf">.99524171.43129428</span> <span class="n">foreground</span> <span class="n">save</span><span class="o">.</span><span class="n">conf</span>

<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">786</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">start</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">786</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_sarra</span> <span class="n">run</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">786</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">AMQP</span>  <span class="n">broker</span><span class="p">(</span><span class="n">localhost</span><span class="p">)</span> <span class="n">user</span><span class="p">(</span><span class="n">tfeed</span><span class="p">)</span> <span class="n">vhost</span><span class="p">(</span><span class="o">/</span><span class="p">)</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">788</span> <span class="p">[</span><span class="n">WARNING</span><span class="p">]</span> <span class="n">non</span> <span class="n">standard</span> <span class="n">queue</span> <span class="n">name</span> <span class="n">q_tsub</span><span class="o">.</span><span class="n">sr_subscribe</span><span class="o">.</span><span class="n">t</span><span class="mf">.99524171.43129428</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">788</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Binding</span> <span class="n">queue</span> <span class="n">q_tsub</span><span class="o">.</span><span class="n">sr_subscribe</span><span class="o">.</span><span class="n">t</span><span class="mf">.99524171.43129428</span> <span class="k">with</span> <span class="n">key</span> <span class="n">v03</span><span class="o">.</span><span class="c1"># from exchange xpublic on broker amqp://tfeed@localhost/</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">790</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">report_back</span> <span class="n">to</span> <span class="n">tfeed</span><span class="nd">@localhost</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="n">xreport</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">792</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">saving</span> <span class="n">to</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">peter</span><span class="o">/.</span><span class="n">cache</span><span class="o">/</span><span class="n">sarra</span><span class="o">/</span><span class="n">shovel</span><span class="o">/</span><span class="n">save</span><span class="o">/</span><span class="n">sr_shovel_save_0000</span><span class="o">.</span><span class="n">save</span> <span class="k">for</span> <span class="n">future</span> <span class="n">restore</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">794</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">saving</span> <span class="mi">1</span> <span class="n">message</span> <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">swob</span><span class="o">-</span><span class="n">ml</span><span class="mf">.20170318</span><span class="o">.</span><span class="n">CPSL</span><span class="mf">.2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="mi">1600</span><span class="o">-</span><span class="n">CPSL</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">795</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">saving</span> <span class="mi">2</span> <span class="n">message</span> <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">hydrometric</span><span class="o">.</span><span class="n">doc</span><span class="o">.</span><span class="n">hydrometric_StationList</span><span class="o">.</span><span class="n">csv</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">901</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">saving</span> <span class="mi">188</span> <span class="n">message</span> <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">hydrometric</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">ON</span><span class="o">.</span><span class="n">hourly</span><span class="o">.</span><span class="n">ON_hourly_hydrometric</span><span class="o">.</span><span class="n">csv</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">07</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">902</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">saving</span> <span class="mi">189</span> <span class="n">message</span> <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">hydrometric</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">BC</span><span class="o">.</span><span class="n">hourly</span><span class="o">.</span><span class="n">BC_hourly_hydrometric</span><span class="o">.</span><span class="n">csv</span>

<span class="o">^</span><span class="n">C2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">261</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">signal</span> <span class="n">stop</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">27</span><span class="p">,</span><span class="mi">261</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">stop</span>


<span class="o">%</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">peter</span><span class="o">/.</span><span class="n">cache</span><span class="o">/</span><span class="n">sarra</span><span class="o">/</span><span class="n">shovel</span><span class="o">/</span><span class="n">save</span><span class="o">/</span><span class="n">sr_shovel_save_0000</span><span class="o">.</span><span class="n">save</span>
<span class="mi">189</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">peter</span><span class="o">/.</span><span class="n">cache</span><span class="o">/</span><span class="n">sarra</span><span class="o">/</span><span class="n">shovel</span><span class="o">/</span><span class="n">save</span><span class="o">/</span><span class="n">sr_shovel_save_0000</span><span class="o">.</span><span class="n">save</span>
<span class="o">%</span>
</pre></div>
</div>
<p>The messages are written to a file in the caching directory for future use, with
the name of the file being based on the configuration name used. The file is in
json format, one message per line (lines are very long) and so filtering with other tools
is possible to modify the list of saved messages. Note that a single save file per
configuration is automatically set, so to save multiple queues, one would need one configurations
file per queue to be saved.  Once the subscriber is back in service, one can return the messages
saved to a file into the same queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="n">sr_shovel</span> <span class="o">-</span><span class="n">restore_to_queue</span> <span class="n">q_tsub</span><span class="o">.</span><span class="n">sr_subscribe</span><span class="o">.</span><span class="n">t</span><span class="mf">.99524171.43129428</span> <span class="n">foreground</span> <span class="n">save</span><span class="o">.</span><span class="n">conf</span>

<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">610</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">start</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">611</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_sarra</span> <span class="n">run</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">611</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">AMQP</span>  <span class="n">broker</span><span class="p">(</span><span class="n">localhost</span><span class="p">)</span> <span class="n">user</span><span class="p">(</span><span class="n">tfeed</span><span class="p">)</span> <span class="n">vhost</span><span class="p">(</span><span class="o">/</span><span class="p">)</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">613</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">Binding</span> <span class="n">queue</span> <span class="n">q_tfeed</span><span class="o">.</span><span class="n">sr_shovel</span><span class="o">.</span><span class="n">save</span> <span class="k">with</span> <span class="n">key</span> <span class="n">v03</span><span class="o">.</span><span class="c1"># from exchange xpublic on broker amqp://tfeed@localhost/</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">615</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">report_back</span> <span class="n">to</span> <span class="n">tfeed</span><span class="nd">@localhost</span><span class="p">,</span> <span class="n">exchange</span><span class="p">:</span> <span class="n">xreport</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">618</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">restoring</span> <span class="mi">189</span> <span class="n">messages</span> <span class="kn">from</span> <span class="nn">save</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">peter</span><span class="o">/.</span><span class="n">cache</span><span class="o">/</span><span class="n">sarra</span><span class="o">/</span><span class="n">shovel</span><span class="o">/</span><span class="n">save</span><span class="o">/</span><span class="n">sr_shovel_save_0000</span><span class="o">.</span><span class="n">save</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">620</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">restoring</span> <span class="n">message</span> <span class="mi">1</span> <span class="n">of</span> <span class="mi">189</span><span class="p">:</span> <span class="n">topic</span><span class="p">:</span> <span class="n">v03</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">swob</span><span class="o">-</span><span class="n">ml</span><span class="mf">.20170318</span><span class="o">.</span><span class="n">CPSL</span><span class="mf">.2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="mi">1600</span><span class="o">-</span><span class="n">CPSL</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">620</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">msg_log</span> <span class="n">received</span><span class="p">:</span> <span class="mf">20170318165818.878</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span> <span class="n">observations</span><span class="o">/</span><span class="n">swob</span><span class="o">-</span><span class="n">ml</span><span class="o">/</span><span class="mi">20170318</span><span class="o">/</span><span class="n">CPSL</span><span class="o">/</span><span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="mi">1600</span><span class="o">-</span><span class="n">CPSL</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span> <span class="n">topic</span><span class="o">=</span><span class="n">v03</span><span class="o">.</span><span class="n">observations</span><span class="o">.</span><span class="n">swob</span><span class="o">-</span><span class="n">ml</span><span class="mf">.20170318</span><span class="o">.</span><span class="n">CPSL</span><span class="mf">.2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="mi">1600</span><span class="o">-</span><span class="n">CPSL</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span> <span class="n">lag</span><span class="o">=</span><span class="mf">1034.74</span> <span class="n">sundew_extension</span><span class="o">=</span><span class="n">DMS</span><span class="p">:</span><span class="n">WXO_RENAMED_SWOB</span><span class="p">:</span><span class="n">MSC</span><span class="p">:</span><span class="n">XML</span><span class="p">::</span><span class="mi">20170318165818</span> <span class="n">source</span><span class="o">=</span><span class="n">metpx</span> <span class="n">mtime</span><span class="o">=</span><span class="mf">20170318165818.878</span> <span class="nb">sum</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="mi">66</span><span class="n">f7249bd5cd68b89a5ad480f4ea1196</span> <span class="n">to_clusters</span><span class="o">=</span><span class="n">DD</span><span class="p">,</span><span class="n">DDI</span><span class="o">.</span><span class="n">CMC</span><span class="p">,</span><span class="n">DDI</span><span class="o">.</span><span class="n">EDM</span><span class="p">,</span><span class="n">DDI</span><span class="o">.</span><span class="n">CMC</span><span class="p">,</span><span class="n">CMC</span><span class="p">,</span><span class="n">SCIENCE</span><span class="p">,</span><span class="n">EDM</span> <span class="n">parts</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">5354</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="n">toolong</span><span class="o">=</span><span class="mi">1234567890</span><span class="n">ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ß</span> <span class="n">from_cluster</span><span class="o">=</span><span class="n">DD</span> <span class="n">atime</span><span class="o">=</span><span class="mf">20170318165818.878</span> <span class="n">filename</span><span class="o">=</span><span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span><span class="o">-</span><span class="mi">1600</span><span class="o">-</span><span class="n">CPSL</span><span class="o">-</span><span class="n">AUTO</span><span class="o">-</span><span class="n">swob</span><span class="o">.</span><span class="n">xml</span>
   <span class="o">.</span>
   <span class="o">.</span>
   <span class="o">.</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">825</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">post_log</span> <span class="n">notice</span><span class="o">=</span><span class="mf">20170318165832.323</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">8000</span><span class="o">/</span><span class="n">hydrometric</span><span class="o">/</span><span class="n">csv</span><span class="o">/</span><span class="n">BC</span><span class="o">/</span><span class="n">hourly</span><span class="o">/</span><span class="n">BC_hourly_hydrometric</span><span class="o">.</span><span class="n">csv</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sundew_extension&#39;</span><span class="p">:</span> <span class="s1">&#39;BC:HYDRO:CSV:DEV::20170318165829&#39;</span><span class="p">,</span> <span class="s1">&#39;toolong&#39;</span><span class="p">:</span> <span class="s1">&#39;1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ßñç1234567890ß&#39;</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="s1">&#39;BC_hourly_hydrometric.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;to_clusters&#39;</span><span class="p">:</span> <span class="s1">&#39;DD,DDI.CMC,DDI.EDM,DDI.CMC,CMC,SCIENCE,EDM&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="s1">&#39;d,a22b2df5e316646031008654b29c4ac3&#39;</span><span class="p">,</span> <span class="s1">&#39;parts&#39;</span><span class="p">:</span> <span class="s1">&#39;1,12270407,1,0,0&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="s1">&#39;metpx&#39;</span><span class="p">,</span> <span class="s1">&#39;from_cluster&#39;</span><span class="p">:</span> <span class="s1">&#39;DD&#39;</span><span class="p">,</span> <span class="s1">&#39;atime&#39;</span><span class="p">:</span> <span class="s1">&#39;20170318165832.323&#39;</span><span class="p">,</span> <span class="s1">&#39;mtime&#39;</span><span class="p">:</span> <span class="s1">&#39;20170318165832.323&#39;</span><span class="p">}</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mi">33</span><span class="p">,</span><span class="mi">826</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">restore</span> <span class="n">complete</span> <span class="n">deleting</span> <span class="n">save</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">peter</span><span class="o">/.</span><span class="n">cache</span><span class="o">/</span><span class="n">sarra</span><span class="o">/</span><span class="n">shovel</span><span class="o">/</span><span class="n">save</span><span class="o">/</span><span class="n">sr_shovel_save_0000</span><span class="o">.</span><span class="n">save</span>


<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span><span class="mi">991</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">signal</span> <span class="n">stop</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="mi">18</span> <span class="mi">13</span><span class="p">:</span><span class="mi">19</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span><span class="mi">991</span> <span class="p">[</span><span class="n">INFO</span><span class="p">]</span> <span class="n">sr_shovel</span> <span class="n">stop</span>
<span class="o">%</span>
</pre></div>
</div>
<p>All the messages saved are returned to the named <em>return_to_queue</em>. Note that the use of the <em>post_rate_limit</em>
plugin prevents the queue from being flooded with hundreds of messages per second. The rate limit to use will need
to be tuned in practice.</p>
<p>By default the file name for the save file is chosen to be in ~/.cache/sarra/shovel/&lt;config&gt;_&lt;instance&gt;.save.
To choose a different destination, <em>save_file</em> option is available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sr_shovel -save_file `pwd`/here -restore_to_queue q_tsub.sr_subscribe.t.99524171.43129428 ./save.conf foreground
</pre></div>
</div>
<p>will create the save files in the current directory named here_000x.save where x is the instance number (0 for foreground.)</p>
</section>
</section>
<section id="roles-feeder-admin-declare">
<h3><a class="toc-backref" href="#id159">ROLES - feeder/admin/declare</a><a class="headerlink" href="#roles-feeder-admin-declare" title="Permalink to this headline">¶</a></h3>
<p><em>of interest only to administrators</em></p>
<p>Administrative options are set using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sr_subscribe</span> <span class="n">edit</span> <span class="n">admin</span>
</pre></div>
</div>
<p>The <em>feeder</em> option specifies the account used by default system transfers for components such as
sr_shovel, sr_sarra and sr_sender (when posting).</p>
<ul class="simple">
<li><p><strong>feeder    amqp{s}://&lt;user&gt;:&lt;pw&gt;&#64;&lt;post_brokerhost&gt;[:port]/&lt;vhost&gt;</strong></p></li>
<li><p><strong>admin   &lt;name&gt;        (default: None)</strong></p></li>
</ul>
<p>The admin user is used to do maintenance operations on the pump such as defining
the other users. Most users are defined using the <em>declare</em> option. The feeder can also be declared in that
way.</p>
<ul class="simple">
<li><p><strong>declare &lt;role&gt; &lt;name&gt;   (no defaults)</strong></p></li>
</ul>
<section id="subscriber">
<h4><a class="toc-backref" href="#id160">subscriber</a><a class="headerlink" href="#subscriber" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>A subscriber is user that can only subscribe to data and return report messages. Subscribers are
not permitted to inject data.  Each subscriber has an xs_&lt;user&gt; named exchange on the pump,
where if a user is named <em>Acme</em>, the corresponding exchange will be <em>xs_Acme</em>.  This exchange
is where an sr_subscribe process will send its report messages.</p>
<p>By convention/default, the <em>anonymous</em> user is created on all pumps to permit subscription without
a specific account.</p>
</div></blockquote>
</section>
<section id="source">
<h4><a class="toc-backref" href="#id161">source</a><a class="headerlink" href="#source" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>A user permitted to subscribe or originate data.  A source does not necessarily represent
one person or type of data, but rather an organization responsible for the data produced.
So if an organization gathers and makes available ten kinds of data with a single contact
email or phone number for questions about the data and its availability, then all of
those collection activities might use a single ‘source’ account.</p>
<p>Each source gets a xs_&lt;user&gt; exchange for injection of data posts, and, similar to a subscriber
to send report messages about processing and receipt of data. Source may also have an xl_&lt;user&gt;
exchange where, as per report routing configurations, report messages of consumers will be sent.</p>
</div></blockquote>
</section>
<section id="feeder">
<h4><a class="toc-backref" href="#id162">feeder</a><a class="headerlink" href="#feeder" title="Permalink to this headline">¶</a></h4>
<blockquote>
<div><p>A user permitted to write to any exchange. Sort of an administrative flow user, meant to pump
messages when no ordinary source or subscriber is appropriate to do so.  Is to be used in
preference to administrator accounts to run flows.</p>
</div></blockquote>
<p>User credentials are placed in the credentials files, and <em>sr_audit</em> will update
the broker to accept what is specified in that file, as long as the admin password is
already correct.</p>
</section>
</section>
<section id="configuration-files">
<h3><a class="toc-backref" href="#id163">CONFIGURATION FILES</a><a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h3>
<p>While one can manage configuration files using the <em>add</em>, <em>remove</em>,
<em>list</em>, <em>edit</em>, <em>disable</em>, and <em>enable</em> actions, one can also do all
of the same activities manually by manipulating files in the settings
directory.  The configuration files for an sr_subscribe configuration
called <em>myflow</em> would be here:</p>
<blockquote>
<div><ul class="simple">
<li><p>linux: ~/.config/sarra/subscribe/myflow.conf (as per: <a class="reference external" href="https://specifications.freedesktop.org/basedir-spec/basedir-spec-0.6.rst">XDG Open Directory Specication</a> )</p></li>
<li><p>Windows: %AppDir%/science.gc.ca/sarra/myflow.conf , this might be:
C:UserspeterAppDataLocalscience.gc.casarramyflow.conf</p></li>
<li><p>MAC: FIXME.</p></li>
</ul>
</div></blockquote>
<p>The top of the tree has  <em>~/.config/sarra/default.conf</em> which contains settings that
are read as defaults for any component on start up.  In the same directory, <em>~/.config/sarra/credentials.conf</em> contains credentials (passwords) to be used by sarracenia ( <a class="reference internal" href="#credentials">CREDENTIALS</a> for details. )</p>
<p>One can also set the XDG_CONFIG_HOME environment variable to override default placement, or
individual configuration files can be placed in any directory and invoked with the
complete path.   When components are invoked, the provided file is interpreted as a
file path (with a .conf suffix assumed.)  If it is not found as a file path, then the
component will look in the component’s config directory ( <strong>config_dir</strong> / <strong>component</strong> )
for a matching .conf file.</p>
<p>If it is still not found, it will look for it in the site config dir
(linux: /usr/share/default/sarra/<strong>component</strong>).</p>
<p>Finally, if the user has set option <strong>remote_config</strong> to True and if he has
configured web sites where configurations can be found (option <strong>remote_config_url</strong>),
The program will try to download the named file from each site until it finds one.
If successful, the file is downloaded to <strong>config_dir/Downloads</strong> and interpreted
by the program from there.  There is a similar process for all <em>plugins</em> that can
be interpreted and executed within sarracenia components.  Components will first
look in the <em>plugins</em> directory in the users config tree, then in the site
directory, then in the sarracenia package itself, and finally it will look remotely.</p>
</section>
<section id="see-also">
<h3><a class="toc-backref" href="#id164">SEE ALSO</a><a class="headerlink" href="#see-also" title="Permalink to this headline">¶</a></h3>
<p><strong>User Commands:</strong></p>
<p><a class="reference external" href="sr3_post.1.rst">sr3_post(1)</a> - post announcemensts of specific files.</p>
<p><a class="reference external" href="sr3_log2save.8.rst">sr_log2save(8)</a> - Convert logfile lines to .save Format for reload/resend.</p>
<p><strong>Formats:</strong></p>
<p><a class="reference external" href="sr3_post.7.rst">sr3_post(7)</a> - The v03 format of announcement messages.</p>
<p><a class="reference external" href="sr3_postv2.7.rst">sr3_postv2(7)</a> - The v02 format of announcement messages.</p>
<p><strong>Home Page:</strong></p>
<p><a class="reference external" href="https://github.com/MetPX">https://github.com/MetPX/</a> - sr_subscribe is a component of MetPX-Sarracenia, the AMQP based data pump.</p>
</section>
<section id="bugs">
<h3><a class="toc-backref" href="#id165">BUGS</a><a class="headerlink" href="#bugs" title="Permalink to this headline">¶</a></h3>
<p>sr3 looks in the configuration files for the <em>instance</em> option, and expects a number there.
If <em>instances</em> comes from an include file, or is a variable value (not a raw number) sr
will not use it properly.</p>
</section>
<section id="developer-only-options">
<h3><a class="toc-backref" href="#id166">DEVELOPER ONLY OPTIONS</a><a class="headerlink" href="#developer-only-options" title="Permalink to this headline">¶</a></h3>
<p>The SR_DEV_APPNAME environment variable can be set so that the application configuration and state directories
are created under a different name.  This is used in development to be able to have many configurations
active at once.  It enables more testing than always working with the developer´s <em>real</em> configuration.</p>
<p>Example:  export SR_DEV_APPNAME=sr-hoho… when you start up a component on a linux system, it will
look in ~/.config/sr-hoho/ for configuration files, and write state files in the ~/.cache/sr-hoho
directory.</p>
</section>
<section id="sundew-compatibility-options">
<h3><a class="toc-backref" href="#id167">SUNDEW COMPATIBILITY OPTIONS</a><a class="headerlink" href="#sundew-compatibility-options" title="Permalink to this headline">¶</a></h3>
<p>For compatibility with Sundew, there are some additional delivery options which can be specified.</p>
<section id="destfn-script-script-default-none">
<h4><a class="toc-backref" href="#id168">destfn_script &lt;script&gt; (default:None)</a><a class="headerlink" href="#destfn-script-script-default-none" title="Permalink to this headline">¶</a></h4>
<p>This option defines a script to be run when everything is ready
for the delivery of the product.  The script receives the sr_sender class
instance.  The script takes the parent as an argument, and for example, any
modification to  <strong>parent.msg.new_file</strong>  will change the name of the file written locally.</p>
</section>
<section id="filename-keyword-default-whatfn">
<h4><a class="toc-backref" href="#id169">filename &lt;keyword&gt; (default:WHATFN)</a><a class="headerlink" href="#filename-keyword-default-whatfn" title="Permalink to this headline">¶</a></h4>
<p>From <strong>metpx-sundew</strong> the support of this option give all sorts of possibilities
for setting the remote filename. Some <strong>keywords</strong> are based on the fact that
<strong>metpx-sundew</strong> filenames are five (to six) fields strings separated by for colons.</p>
<p>The default value on Sundew is NONESENDER, but in the interest of discouraging use
of colon separation in files, the default in Sarracenia is WHATFN</p>
<p>The possible keywords are :</p>
<dl class="simple">
<dt><strong>WHATFN</strong></dt><dd><ul class="simple">
<li><p>the first part of the Sundew filename (string before first :)</p></li>
</ul>
</dd>
<dt><strong>HEADFN</strong></dt><dd><ul class="simple">
<li><p>HEADER part of the sundew filename</p></li>
</ul>
</dd>
<dt><strong>SENDER</strong></dt><dd><ul class="simple">
<li><p>the Sundew filename may end with a string SENDER=&lt;string&gt; in this case the &lt;string&gt; will be the remote filename</p></li>
</ul>
</dd>
<dt><strong>NONE</strong></dt><dd><ul class="simple">
<li><p>deliver with the complete Sundew filename (without :SENDER=…)</p></li>
</ul>
</dd>
<dt><strong>NONESENDER</strong></dt><dd><ul class="simple">
<li><p>deliver with the complete Sundew filename (with :SENDER=…)</p></li>
</ul>
</dd>
<dt><strong>TIME</strong></dt><dd><ul class="simple">
<li><p>time stamp appended to filename. Example of use: WHATFN:TIME</p></li>
</ul>
</dd>
<dt><strong>DESTFN=str</strong></dt><dd><ul class="simple">
<li><p>direct filename declaration str</p></li>
</ul>
</dd>
<dt><strong>SATNET=1,2,3,A</strong></dt><dd><ul class="simple">
<li><p>cmc internal satnet application parameters</p></li>
</ul>
</dd>
<dt><strong>DESTFNSCRIPT=script.py</strong></dt><dd><ul class="simple">
<li><p>invoke a script (same as destfn_script) to generate the name of the file to write</p></li>
</ul>
</dd>
</dl>
<p><strong>accept &lt;regexp pattern&gt; [&lt;keyword&gt;]</strong></p>
<p>keyword can be added to the <strong>accept</strong> option. The keyword is any one of the <strong>filename</strong>
options.  A message that matched against the accept regexp pattern, will have its remote_file
plied this keyword option.  This keyword has priority over the preceeding <strong>filename</strong> one.</p>
<p>The <strong>regexp pattern</strong> can be use to set directory parts if part of the message is put
to parenthesis. <strong>sr_sender</strong> can use these parts to build the directory name. The
rst enclosed parenthesis strings will replace keyword <strong>${0}</strong> in the directory name…
the second <strong>${1}</strong> etc.</p>
<p>Example of use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>filename NONE

directory /this/first/target/directory

accept .*file.*type1.*

directory /this/target/directory

accept .*file.*type2.*

accept .*file.*type3.*  DESTFN=file_of_type3

directory /this/${0}/pattern/${1}/directory

accept .*(2016....).*(RAW.*GRIB).*
</pre></div>
</div>
<p>A selected message by the first accept would be delivered unchanged to the first directory.</p>
<p>A selected message by the second accept would be delivered unchanged to the second directory.</p>
<p>A selected message by the third accept would be renamed “file_of_type3” in the second directory.</p>
<p>A selected message by the forth accept would be delivered unchanged to a directory.</p>
<p>It’s named  <em>/this/20160123/pattern/RAW_MERGER_GRIB/directory</em> if the message would have a notice like:</p>
<p><strong>20150813161959.854 http://this.pump.com/ relative/path/to/20160123_product_RAW_MERGER_GRIB_from_CMC</strong></p>
</section>
<section id="field-replacements">
<h4><a class="toc-backref" href="#id170">Field Replacements</a><a class="headerlink" href="#field-replacements" title="Permalink to this headline">¶</a></h4>
<p>In MetPX Sundew, there is a much more strict file naming standard, specialised for use with
World Meteorological Organization (WMO) data.   Note that the file naming convention predates, and
bears no relation to the WMO file naming convention currently approved, but is strictly an internal
format.   The files are separated into six fields by colon characters.  The first field, DESTFN,
gives the WMO (386 style) Abbreviated Header Line (AHL) with underscores replacing blanks:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TTAAii</span> <span class="n">CCCC</span> <span class="n">YYGGGg</span> <span class="n">BBB</span> <span class="o">...</span>
</pre></div>
</div>
<p>(see WMO manuals for details) followed by numbers to render the product unique (as in practice,
though not in theory, there are a large number of products which have the same identifiers).
The meanings of the fifth field is a priority, and the last field is a date/time stamp.
The other fields vary in meaning depending on context.  A sample file name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SACN43_CWAO_012000_AAA_41613</span><span class="p">:</span><span class="n">ncp1</span><span class="p">:</span><span class="n">CWAO</span><span class="p">:</span><span class="n">SA</span><span class="p">:</span><span class="mf">3.</span><span class="n">A</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">E</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mi">20050201200339</span>
</pre></div>
</div>
<p>If a file is sent to sarracenia and it is named according to the Sundew conventions, then the
following substitution fields are available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>${T1}    replace by bulletin&#39;s T1
${T2}    replace by bulletin&#39;s T2
${A1}    replace by bulletin&#39;s A1
${A2}    replace by bulletin&#39;s A2
${ii}    replace by bulletin&#39;s ii
${CCCC}  replace by bulletin&#39;s CCCC
${YY}    replace by bulletin&#39;s YY   (obs. day)
${GG}    replace by bulletin&#39;s GG   (obs. hour)
${Gg}    replace by bulletin&#39;s Gg   (obs. minute)
${BBB}   replace by bulletin&#39;s bbb
${RYYYY} replace by reception year
${RMM}   replace by reception month
${RDD}   replace by reception day
${RHH}   replace by reception hour
${RMN}   replace by reception minutes
${RSS}   replace by reception second
</pre></div>
</div>
<p>The ‘R’ fields come from the sixth field, and the others come from the first one.
When data is injected into sarracenia from Sundew, the <em>sundew_extension</em> message header
will provide the source for these substitions even if the fields have been removed
from the delivered file names.</p>
</section>
<section id="deprecated-settings">
<h4><a class="toc-backref" href="#id171">DEPRECATED SETTINGS</a><a class="headerlink" href="#deprecated-settings" title="Permalink to this headline">¶</a></h4>
<p>These settings pertain to previous versions of the client, and have been superceded.</p>
<ul class="simple">
<li><p><strong>lock      &lt;locktext&gt;         (renamed to inflight)</strong></p></li>
</ul>
</section>
</section>
<section id="history">
<h3><a class="toc-backref" href="#id172">HISTORY</a><a class="headerlink" href="#history" title="Permalink to this headline">¶</a></h3>
<p>Sarracenia is part of the MetPX (Meteorological Product Exchanger.) project.
The initial prototypes leveraged MetPX Sundew, Sarracenia’s ancestor. Sundew
plugins were developed to create announcements for files delivered by Sundew,
and Dd_subscribe was initially developed as a download client for <strong>dd.weather.gc.ca</strong>, an
Environment Canada website where a wide variety of meteorological products are made
available to the public. It is from the name of this site that the sarracenia
suite takes the dd_ prefix for its tools. The initial version was deployed in
2013 on an experimental basis. The following year, support of checksums
was added, and in the fall of 2015, the feeds were updated to v02.</p>
<p>In 2007, when MetPX was originally open sourced, the staff responsible were part of
Environment Canada. In honour of the Species At Risk Act (SARA), to highlight the plight
of disappearing species which are not furry (the furry ones get all the attention) and
because search engines will find references to names which are more unusual more easily,
the original MetPX WMO switch was named after a carnivorous plant on the Species At
Risk Registry: The <em>Thread-leaved Sundew</em>.</p>
<p>The organization behind MetPX has since moved to Shared Services Canada, but when
it came time to name a new module, we kept with a theme of carnivorous plants, and
chose another one indigenous to some parts of Canada: <em>Sarracenia</em>, a variety
of insectivorous pitcher plants. We like plants that eat meat!</p>
<p>Sarracenia was initially called v2, as in the second data pumping architecture
in the MetPX project, (v1 being Sundew.) Over the years a number of limitations
with the existing implementation became clear:</p>
<ul class="simple">
<li><p>The poor support for python developers.</p></li>
<li><p>the odd plugin logic, with very poor error reporting.</p></li>
<li><p>The inability to process groups of messages.</p></li>
<li><p>The inability to add other queueing protocols (limited to rabbitmq/AMQP.)</p></li>
</ul>
<p>in 2020, Development began on v03.</p>
<p>V03 is a deep refactor of Sarracenia, bringing support for MQTT in addition to AMQP,
and pluggable organization that makes it easy to add other message queueing protocols.
whereas v02 was an application that one could add snippets of python code to customize
to a certain degree, V03 is a set of python APIs with used to implement a CLI. It
can be used by application programmers in a much more piecemeal/lego-style way.</p>
<section id="dd-subscribe-renaming">
<h4><a class="toc-backref" href="#id173">dd_subscribe Renaming</a><a class="headerlink" href="#dd-subscribe-renaming" title="Permalink to this headline">¶</a></h4>
<p>The new project (MetPX-Sarracenia) has many components, is used for more than
distribution, and more than one website, and causes confusion for sysadmins thinking
it is associated with the dd(1) command (to convert and copy files).  So, we switched
all the components to use the sr_ prefix.</p>
</section>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">SR3</a><ul>
<li><a class="reference internal" href="#sr3-sarracenia-cli">sr3 Sarracenia CLI</a><ul>
<li><a class="reference internal" href="#synopsis">SYNOPSIS</a></li>
<li><a class="reference internal" href="#description">DESCRIPTION</a></li>
<li><a class="reference internal" href="#contents">Contents</a></li>
<li><a class="reference internal" href="#commands">COMMANDS</a></li>
<li><a class="reference internal" href="#components">COMPONENTS</a><ul>
<li><a class="reference internal" href="#cpump-sr-cpump">CPUMP|sr_cpump</a></li>
<li><a class="reference internal" href="#poll">POLL</a><ul>
<li><a class="reference internal" href="#repeated-scans-and-vip">Repeated Scans and VIP</a></li>
<li><a class="reference internal" href="#polling-specifications">POLLING SPECIFICATIONS</a></li>
<li><a class="reference internal" href="#posting-specifications">POSTING SPECIFICATIONS</a></li>
<li><a class="reference internal" href="#advanced-features">ADVANCED FEATURES</a></li>
</ul>
</li>
<li><a class="reference internal" href="#post-sr3-post-sr-cpost-watch">post|sr3_post|sr_cpost|watch</a><ul>
<li><a class="reference internal" href="#settings">Settings</a></li>
</ul>
</li>
<li><a class="reference internal" href="#p-path-path">[-p|–path path]</a></li>
<li><a class="reference internal" href="#blocksize-value">[–blocksize &lt;value&gt;]</a></li>
<li><a class="reference internal" href="#e-fileevents-event-event">[-e|–fileEvents &lt;event|event|…&gt;]</a></li>
<li><a class="reference internal" href="#fp-force-polling-boolean">[-fp|–force_polling &lt;boolean&gt;]</a></li>
<li><a class="reference internal" href="#pos-post-on-start">[-pos|–post_on_start]</a></li>
<li><a class="reference internal" href="#r-randomize">[-r|–randomize]</a></li>
<li><a class="reference internal" href="#real-realpath-boolean">[-real|–realpath &lt;boolean&gt;]</a></li>
<li><a class="reference internal" href="#rn-rename-path">[-rn|–rename &lt;path&gt;]</a></li>
<li><a class="reference internal" href="#rr-reconnect">[-rr|–reconnect]</a></li>
<li><a class="reference internal" href="#fs-follow-symlinks-boolean">[-fs|–follow_symlinks &lt;boolean&gt;]</a></li>
<li><a class="reference internal" href="#header-name-value">[-header &lt;name&gt;=&lt;value&gt;]</a></li>
<li><a class="reference internal" href="#id4">[-real|–realpath &lt;boolean&gt;]</a></li>
<li><a class="reference internal" href="#id5">[-rn|–rename &lt;path&gt;]</a></li>
<li><a class="reference internal" href="#sub-subtopic-key">[-sub|–subtopic &lt;key&gt;]</a></li>
<li><a class="reference internal" href="#sleep-time">[–sleep &lt;time&gt; ]</a></li>
<li><a class="reference internal" href="#sum-sum-string">[-sum|–sum &lt;string&gt;]</a></li>
<li><a class="reference internal" href="#file-detection-strategies">File Detection Strategies</a></li>
<li><a class="reference internal" href="#file-detection-strategy-table">File Detection Strategy Table</a><ul>
<li><a class="reference internal" href="#shim-library-usage">SHIM LIBRARY USAGE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#shim-usage-notes">Shim Usage Notes</a></li>
<li><a class="reference internal" href="#sarra">SARRA</a><ul>
<li><a class="reference internal" href="#specific-consuming-requirements">Specific consuming requirements</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sender">SENDER</a><ul>
<li><a class="reference internal" href="#destination-unavailable">DESTINATION UNAVAILABLE</a></li>
<li><a class="reference internal" href="#setup-1-pump-to-pump-replication">SETUP 1 : PUMP TO PUMP REPLICATION</a></li>
<li><a class="reference internal" href="#destination-setup-2-metpx-sundew-like-dissemination">DESTINATION SETUP 2 : METPX-SUNDEW LIKE DISSEMINATION</a></li>
</ul>
</li>
<li><a class="reference internal" href="#shovel">shovel</a></li>
<li><a class="reference internal" href="#subscribe">subscribe</a></li>
<li><a class="reference internal" href="#watch">watch</a></li>
<li><a class="reference internal" href="#winnow">winnow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id11">DESCRIPTION</a><ul>
<li><a class="reference internal" href="#documentation">Documentation</a></li>
<li><a class="reference internal" href="#configurations">Configurations</a></li>
<li><a class="reference internal" href="#option-syntax">Option Syntax</a><ul>
<li><a class="reference internal" href="#option-order">Option Order</a></li>
<li><a class="reference internal" href="#flowcallback-options">flowCallback options</a></li>
<li><a class="reference internal" href="#callback-options">callback options</a></li>
<li><a class="reference internal" href="#importing-extensions">Importing Extensions</a></li>
<li><a class="reference internal" href="#deprecated-v2-plugins">Deprecated v2 plugins</a></li>
<li><a class="reference internal" href="#environment-variables">Environment Variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#logs-and-monitoring">LOGS and MONITORING</a></li>
<li><a class="reference internal" href="#credentials">CREDENTIALS</a><ul>
<li><a class="reference internal" href="#credential-details">Credential Details</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#consumer">CONSUMER</a><ul>
<li><a class="reference internal" href="#setting-the-broker">Setting the Broker</a></li>
<li><a class="reference internal" href="#creating-the-queue">Creating the Queue</a><ul>
<li><a class="reference internal" href="#queue-queue-name-qn-name">[ queue|queue_name|qn &lt;name&gt;]</a></li>
<li><a class="reference internal" href="#durable-boolean-default-true">durable &lt;boolean&gt; (default: True)</a></li>
<li><a class="reference internal" href="#expire-duration-default-5m-five-minutes-recommend-overriding">expire &lt;duration&gt; (default: 5m  == five minutes. RECOMMEND OVERRIDING)</a></li>
<li><a class="reference internal" href="#message-ttl-duration-default-none">message_ttl &lt;duration&gt;  (default: None)</a></li>
<li><a class="reference internal" href="#prefetch-n-default-1">prefetch &lt;N&gt; (default: 1)</a></li>
<li><a class="reference internal" href="#reset-boolean-default-false">reset &lt;boolean&gt; (default: False)</a></li>
<li><a class="reference internal" href="#save-restore">save/restore</a></li>
<li><a class="reference internal" href="#declare-queue-bind-queue">declare_queue/bind_queue</a></li>
</ul>
</li>
<li><a class="reference internal" href="#amqp-queue-bindings">AMQP QUEUE BINDINGS</a><ul>
<li><a class="reference internal" href="#exchange-name-default-xpublic-and-exchange-suffix">exchange &lt;name&gt; (default: xpublic) and exchange_suffix</a></li>
<li><a class="reference internal" href="#subtopic-amqp-pattern-default">subtopic &lt;amqp pattern&gt; (default: #)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#client-side-filtering">Client-side Filtering</a><ul>
<li><a class="reference internal" href="#brief-introduction-to-regular-expressions">Brief Introduction to Regular Expressions</a></li>
<li><a class="reference internal" href="#accept-reject-and-accept-unmatch">accept, reject and accept_unmatch</a></li>
</ul>
</li>
<li><a class="reference internal" href="#acceleration">ACCELERATION</a><ul>
<li><a class="reference internal" href="#accel-treshold-byte-count-default-0-disabled">accel_treshold &lt;byte count&gt; (default: 0- disabled.)</a></li>
<li><a class="reference internal" href="#accel-xx-command">accel_xx_command</a></li>
</ul>
</li>
<li><a class="reference internal" href="#delivery-specifications">DELIVERY SPECIFICATIONS</a><ul>
<li><a class="reference internal" href="#attempts-count-default-3">attempts &lt;count&gt; (default: 3)</a></li>
<li><a class="reference internal" href="#acceptsizewrong-boolean-default-false">acceptSizeWrong: &lt;boolean&gt; (default: False)</a></li>
<li><a class="reference internal" href="#retry-ttl-duration-default-same-as-expire">retry_ttl &lt;duration&gt; (default: same as expire)</a></li>
<li><a class="reference internal" href="#timeout-float-default-0">timeout &lt;float&gt; (default: 0)</a></li>
<li><a class="reference internal" href="#inflight-string-default-tmp-or-none-if-post-broker-set">inflight &lt;string&gt; (default: .tmp or NONE if post_broker set)</a></li>
<li><a class="reference internal" href="#delete-boolean-default-off">delete &lt;boolean&gt; (default: off)</a></li>
<li><a class="reference internal" href="#batch-count-default-100">batch &lt;count&gt; (default: 100)</a></li>
<li><a class="reference internal" href="#directory-path-default">directory &lt;path&gt; (default: .)</a></li>
<li><a class="reference internal" href="#mirror-boolean-default-off">mirror &lt;boolean&gt; (default: off)</a></li>
<li><a class="reference internal" href="#strip-count-regexp-default-0">strip &lt;count|regexp&gt; (default: 0)</a></li>
<li><a class="reference internal" href="#flatten-string-default">flatten &lt;string&gt; (default: ‘/’)</a></li>
<li><a class="reference internal" href="#basedir-path-default">baseDir &lt;path&gt; (default: /)</a></li>
<li><a class="reference internal" href="#inline-boolean-default-false">inline &lt;boolean&gt; (default: False)</a></li>
<li><a class="reference internal" href="#inplace-boolean-default-on">inplace &lt;boolean&gt; (default: On)</a></li>
<li><a class="reference internal" href="#outlet-post-json-url-default-post">outlet post|json|url (default: post)</a></li>
<li><a class="reference internal" href="#overwrite-boolean-default-off">overwrite &lt;boolean&gt; (default: off)</a></li>
<li><a class="reference internal" href="#discard-boolean-default-off">discard &lt;boolean&gt; (default: off)</a></li>
<li><a class="reference internal" href="#source-from-exchange-boolean-default-off">source_from_exchange &lt;boolean&gt; (default: off)</a></li>
<li><a class="reference internal" href="#housekeeping-count-default-300-seconds">housekeeping &lt;count&gt; (default: 300 seconds)</a></li>
<li><a class="reference internal" href="#shim-defer-posting-to-exit-experimental">shim_defer_posting_to_exit (EXPERIMENTAL)</a></li>
<li><a class="reference internal" href="#shim-post-minterval-interval-experimental">shim_post_minterval <em>interval</em> (EXPERIMENTAL)</a></li>
<li><a class="reference internal" href="#shim-skip-parent-open-files-experimental">shim_skip_parent_open_files (EXPERIMENTAL)</a></li>
<li><a class="reference internal" href="#suppress-duplicates-off-on-999-smhdw-default-off">suppress_duplicates &lt;off|on|999[smhdw]&gt; (default: off)</a></li>
<li><a class="reference internal" href="#suppress-duplicates-basis-data-name-path-default-path">suppress_duplicates_basis &lt;data|name|path&gt; (default: path)</a></li>
<li><a class="reference internal" href="#kbytes-ps-count-default-0">kbytes_ps &lt;count&gt; (default: 0)</a></li>
<li><a class="reference internal" href="#messagecountmax-count-default-0">messageCountMax &lt;count&gt; (default: 0)</a></li>
<li><a class="reference internal" href="#messageratemax-float-default-0">messageRateMax &lt;float&gt; (default: 0)</a></li>
<li><a class="reference internal" href="#messageratemin-float-default-0">messageRateMin &lt;float&gt; (default: 0)</a></li>
<li><a class="reference internal" href="#timecopy-default-on">timeCopy (default: on)</a></li>
<li><a class="reference internal" href="#permdefault-permdirdefault-permlog-permcopy">permDefault, permDirDefault, permLog, permCopy</a></li>
<li><a class="reference internal" href="#tls-rigour-default-medium">tls_rigour (default: medium)</a></li>
<li><a class="reference internal" href="#xattr-disable-default-off">xattr_disable (default: off)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#delivery-completion-inflight">Delivery Completion (inflight)</a><ul>
<li><a class="reference internal" href="#frequent-configuration-errors">Frequent Configuration Errors</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#on-windows">On Windows</a></li>
<li><a class="reference internal" href="#periodic-processing">PERIODIC PROCESSING</a><ul>
<li><a class="reference internal" href="#sanity-log-dead-interval-default-1-5-housekeeping">sanity_log_dead &lt;interval&gt; (default: 1.5*housekeeping)</a></li>
<li><a class="reference internal" href="#suppress-duplicates-off-on-999-default-off">suppress_duplicates &lt;off|on|999&gt; (default: off)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#error-recovery">ERROR RECOVERY</a></li>
<li><a class="reference internal" href="#examples">EXAMPLES</a></li>
<li><a class="reference internal" href="#naming-exchanges-and-queues">NAMING EXCHANGES AND QUEUES</a></li>
<li><a class="reference internal" href="#queues-and-multiple-streams">QUEUES and MULTIPLE STREAMS</a></li>
<li><a class="reference internal" href="#report-back-and-report-exchange">report_back and report_exchange</a></li>
<li><a class="reference internal" href="#instances">INSTANCES</a><ul>
<li><a class="reference internal" href="#vip-active-passive-options">vip - ACTIVE/PASSIVE OPTIONS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#posting-options">POSTING OPTIONS</a><ul>
<li><a class="reference internal" href="#blocksize-value-default-0-auto">[–blocksize &lt;value&gt;] (default: 0 (auto))</a></li>
<li><a class="reference internal" href="#pbd-post-basedir-path-optional">[-pbd|–post_baseDir &lt;path&gt;] (optional)</a></li>
<li><a class="reference internal" href="#post-baseurl-url-mandatory">post_baseUrl &lt;url&gt; (MANDATORY)</a></li>
<li><a class="reference internal" href="#post-exchange-name-default-xpublic">post_exchange &lt;name&gt; (default: xpublic)</a></li>
<li><a class="reference internal" href="#post-exchange-split-number-default-0">post_exchange_split   &lt;number&gt;   (default: 0)</a></li>
<li><a class="reference internal" href="#remote-configurations">Remote Configurations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extensions">Extensions</a><ul>
<li><a class="reference internal" href="#flowcallback-and-flowcallbackprepend-class">flowCallback and flowCallbackPrepend &lt;class&gt;</a></li>
<li><a class="reference internal" href="#integrity">Integrity</a></li>
<li><a class="reference internal" href="#transfer">Transfer</a></li>
</ul>
</li>
<li><a class="reference internal" href="#queue-save-restore">Queue Save/Restore</a><ul>
<li><a class="reference internal" href="#sender-destination-unavailable">Sender Destination Unavailable</a></li>
<li><a class="reference internal" href="#shovel-save-restore">Shovel Save/Restore</a></li>
</ul>
</li>
<li><a class="reference internal" href="#roles-feeder-admin-declare">ROLES - feeder/admin/declare</a><ul>
<li><a class="reference internal" href="#subscriber">subscriber</a></li>
<li><a class="reference internal" href="#source">source</a></li>
<li><a class="reference internal" href="#feeder">feeder</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration-files">CONFIGURATION FILES</a></li>
<li><a class="reference internal" href="#see-also">SEE ALSO</a></li>
<li><a class="reference internal" href="#bugs">BUGS</a></li>
<li><a class="reference internal" href="#developer-only-options">DEVELOPER ONLY OPTIONS</a></li>
<li><a class="reference internal" href="#sundew-compatibility-options">SUNDEW COMPATIBILITY OPTIONS</a><ul>
<li><a class="reference internal" href="#destfn-script-script-default-none">destfn_script &lt;script&gt; (default:None)</a></li>
<li><a class="reference internal" href="#filename-keyword-default-whatfn">filename &lt;keyword&gt; (default:WHATFN)</a></li>
<li><a class="reference internal" href="#field-replacements">Field Replacements</a></li>
<li><a class="reference internal" href="#deprecated-settings">DEPRECATED SETTINGS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#history">HISTORY</a><ul>
<li><a class="reference internal" href="#dd-subscribe-renaming">dd_subscribe Renaming</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/Reference/sr3.1.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../index.html">sarracenia 3.00.013 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">SR3</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2022, Peter Silva.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
  </body>
</html>